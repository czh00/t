<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時間</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100vw;
            position: relative;
            font-family: 'Inter', sans-serif;
        }

        #dateTimeDisplay {
            font-family: 'Segoe UI', Arial, sans-serif;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            position: absolute;
            transition: transform 1s ease-in-out;
            transform: translate(-50%, -50%);
            left: 50%;
            top: 50%;
        }

        .time-text {
            font-size: 32vw;
            margin-bottom: -10vw;
            position: relative;
            display: inline-block;
            white-space: nowrap;
            padding-right: 8vw;
        }

        .time-seconds {
            font-size: 6vw;
            cursor: pointer;
            position: absolute;
            right: 0;
            bottom: 6vw;
            text-align: right;
            width: 6vw;
        }

        .time-ampm {
            font-size: 5vw;
            position: absolute;
            top: 11vw;
            right: 0;
            text-align: right;
            width: 8vw;
        }

        .gregorian-date-text {
            font-size: 10vw;
            margin-top: -2vw;
            margin-bottom: -3vw;
            display: block;
            white-space: nowrap;
        }

        /* 農曆日期和節氣節日共同的行容器 */
        .lunar-and-jieqi-line {
            display: flex; /* 使用 Flexbox 讓內容在同一行 */
            justify-content: center; /* 水平居中 */
            align-items: center; /* 垂直居中 */
            font-size: 6.4vw;
            white-space: nowrap; /* 防止換行 */
            width: 92vw; /* 設置一個寬度，讓內容可以溢出進行跑馬燈 */
            margin: 0 auto;
            overflow: hidden; /* 隱藏溢出內容，為跑馬燈做準備 */
            cursor: pointer; /* 讓整行可點擊以顯示詳細資訊 */
        }

        /* 農曆日期樣式 (靜態部分) */
        .lunar-date-static-text {
            flex-shrink: 0; /* 防止農曆日期被壓縮 */
            text-align: right; /* 確保內容靠右對齊 */
            /* 移除 margin-right 以消除空格 */
        }

        /* 節氣與節日跑馬燈容器樣式 */
        .jieqi-holiday-marquee-container {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
            text-align: left;
            min-width: 0;
            max-width: 40vw;
        }

        /* 跑馬燈內部容器，實際被動畫的元素 */
        .jieqi-holiday-marquee-inner {
            display: flex;
            flex-wrap: nowrap;
            width: max-content;
            animation-name: marquee;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            animation-play-state: paused; /* 預設暫停 */
        }

        /* 滾動時應用的動畫樣式 */
        .jieqi-holiday-marquee-container.scrolling .jieqi-holiday-marquee-inner {
            animation-play-state: running; /* 開始動畫 */
        }

        /* 跑馬燈內容和重複內容的樣式 */
        .jieqi-holiday-marquee-content,
        .jieqi-holiday-marquee-content-duplicate {
            display: inline-block;
            padding-right: 0.2em;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* 跑馬燈動畫定義 */
        @keyframes marquee {
            from { transform: translateX(0); }
            to { transform: translateX(var(--marquee-scroll-distance)); }
        }

        .noscript-message {
            font-size: 0.5em;
            color: #FFB3BA;
            margin-top: 10px;
        }

        .settings-modal, .jieqi-modal, .yiji-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .settings-modal.is-active, .jieqi-modal.is-active, .yiji-modal.is-active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .settings-content, .jieqi-content, .yiji-content {
            background-color: #333;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            color: #00FF00;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .setting-item {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }

        .setting-item label {
            font-size: 1.2em;
            flex-shrink: 0;
            margin-right: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: auto;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #00FF00;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #00FF00;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        .setting-item input[type="color"] {
            width: 40px;
            height: 34px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
            flex-shrink: 0;
        }

        .action-button {
            background-color: #555;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
        }

        .action-button:hover {
            background-color: #777;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            white-space: nowrap;
        }

        .calendar-settings-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
            width: 100%;
        }

        .gregorian-settings-column,
        .lunar-settings-column {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 8px;
            background-color: #444;
            text-align: left;
        }

        .gregorian-settings-column h3,
        .lunar-settings-column h3 {
            text-align: center;
            margin-top: 0;
        }

        .lunar-date-clickable,
        .lunar-shichen-clickable {
            cursor: pointer;
        }

        .yiji-content p {
            margin-bottom: 5px;
        }
        .yiji-content strong {
            color: #FFD700;
        }

        .jieqi-content p {
            margin-bottom: 5px;
        }
        .jieqi-content strong {
            color: #FFD700;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.7.0/lunar.min.js"></script>
</head>
<body>
    <div id="dateTimeDisplay"></div>

    <noscript>
            <div class="noscript-message">
                您的瀏覽器不支援或已禁用 JavaScript。
            </div>
    </noscript>

    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <h2>顯示設定</h2>
            <div class="calendar-settings-container">
                <div class="gregorian-settings-column">
                    <h3>公曆</h3>
                    <div class="setting-item">
                        <label for="textColor">時間</label>
                        <label class="switch" title="切換上午/下午格式">
                            <input type="checkbox" id="showAmPm">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="textColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianYear">年</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianYear">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianYearColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianMonth">月</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianMonth">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianMonthColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianDay">日</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianDay">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianDayColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianWeekday">周</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianWeekday">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianWeekdayColor" value="#00FF00">
                    </div>
                </div>

                <div class="lunar-settings-column">
                    <h3>農曆</h3>
                    <div class="setting-item">
                        <label for="showMinguoYear">年</label>
                        <label class="switch">
                            <input type="checkbox" id="showMinguoYear">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="minguoYearColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showLunarMonth">月</label>
                        <label class="switch">
                            <input type="checkbox" id="showLunarMonth">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="lunarMonthColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showLunarDay">日</label>
                        <label class="switch">
                            <input type="checkbox" id="showLunarDay">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="lunarDayColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showLunarShiChen">時</label>
                        <label class="switch">
                            <input type="checkbox" id="showLunarShiChen">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="lunarShiChenColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showJieqi">節氣</label>
                        <label class="switch">
                            <input type="checkbox" id="showJieqi">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="jieqiColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showHolidays">節日</label>
                        <label class="switch">
                            <input type="checkbox" id="showHolidays">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="holidayColor" value="#00FF00">
                    </div>
                </div>
            </div>

            <div class="setting-item">
                <label for="backgroundColor">背景顏色</label>
                <input type="color" id="backgroundColor" value="#000000">
            </div>

            <div class="button-group">
                <button id="restoreDefaultsBtn" class="action-button">恢復預設</button>
                <button id="randomColorsBtn" class="action-button">隨機顏色</button>
                <button id="doneBtn" class="action-button">完成</button>
            </div>
        </div>
    </div>

    <div id="jieqiDetailsModal" class="jieqi-modal">
        <div class="jieqi-content">
            <h2>節氣與節日資訊</h2>
            <div id="jieqiDetailsContent" style="text-align: left;">
            </div>
            <button id="closeJieqiDetailsBtn" class="action-button">關閉</button>
        </div>
    </div>

    <div id="yijiDetailsModal" class="yiji-modal">
        <div class="yiji-content">
            <h2>宜忌資訊</h2>
            <div id="yijiDetailsContent" style="text-align: left;">
            </div>
            <button id="closeYijiDetailsBtn" class="action-button">關閉</button>
        </div>
    </div>

    <script>
        let lastSecondTensDigit = -1;
        let currentPosition = { x: 0, y: 0 };
        let lastJieqiHolidayContent = '';
        let lastDay = -1;

        const defaultDisplaySettings = {
            showAmPm: true,
            showGregorianYear: true,
            showGregorianMonth: true,
            showGregorianDay: true,
            showGregorianWeekday: true,
            showMinguoYear: true,
            showLunarMonth: true,
            showLunarDay: true,
            showLunarShiChen: true,
            showJieqi: true,
            showHolidays: true,
            textColor: '#00FF00',
            backgroundColor: '#000000',
            gregorianYearColor: '#00FF00',
            gregorianMonthColor: '#00FF00',
            gregorianDayColor: '#00FF00',
            gregorianWeekdayColor: '#00FF00',
            minguoYearColor: '#00FF00',
            lunarMonthColor: '#00FF00',
            lunarDayColor: '#00FF00',
            lunarShiChenColor: '#00FF00',
            jieqiColor: '#00FF00',
            holidayColor: '#0000FF'
        };

        let displaySettings = { ...defaultDisplaySettings }; 

        // 儲存設定到 Cookie
        function saveSettings() {
            const settingsJson = JSON.stringify(displaySettings);
            document.cookie = `displaySettings=${settingsJson}; expires=${new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toUTCString()}; path=/`;
        }

        // 從 Cookie 載入設定
        function loadSettings() {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith('displaySettings=')) {
                    try {
                        const settingsJson = cookie.substring('displaySettings='.length);
                        const loadedSettings = JSON.parse(settingsJson);
                        displaySettings = Object.assign({ ...defaultDisplaySettings }, loadedSettings);
                    } catch (e) {
                        console.error("Failed to parse display settings from cookie:", e);
                    }
                    return;
                }
            }
        }

        // 更新設定模態框中的勾選狀態和顏色值
        function updateSettingsModalCheckboxes() {
            document.getElementById('showAmPm').checked = displaySettings.showAmPm;
            document.getElementById('showGregorianYear').checked = displaySettings.showGregorianYear;
            document.getElementById('showGregorianMonth').checked = displaySettings.showGregorianMonth;
            document.getElementById('showGregorianDay').checked = displaySettings.showGregorianDay;
            document.getElementById('showGregorianWeekday').checked = displaySettings.showGregorianWeekday;
            document.getElementById('showMinguoYear').checked = displaySettings.showMinguoYear;
            document.getElementById('showLunarMonth').checked = displaySettings.showLunarMonth;
            document.getElementById('showLunarDay').checked = displaySettings.showLunarDay;
            document.getElementById('showLunarShiChen').checked = displaySettings.showLunarShiChen;
            document.getElementById('showJieqi').checked = displaySettings.showJieqi;
            document.getElementById('showHolidays').checked = displaySettings.showHolidays;
            document.getElementById('textColor').value = displaySettings.textColor;
            document.getElementById('backgroundColor').value = displaySettings.backgroundColor;
            document.getElementById('gregorianYearColor').value = displaySettings.gregorianYearColor;
            document.getElementById('gregorianMonthColor').value = displaySettings.gregorianMonthColor;
            document.getElementById('gregorianDayColor').value = displaySettings.gregorianDayColor;
            document.getElementById('gregorianWeekdayColor').value = displaySettings.gregorianWeekdayColor;
            document.getElementById('minguoYearColor').value = displaySettings.minguoYearColor;
            document.getElementById('lunarMonthColor').value = displaySettings.lunarMonthColor;
            document.getElementById('lunarDayColor').value = displaySettings.lunarDayColor;
            document.getElementById('lunarShiChenColor').value = displaySettings.lunarShiChenColor;
            document.getElementById('jieqiColor').value = displaySettings.jieqiColor;
            document.getElementById('holidayColor').value = displaySettings.holidayColor;
        }

        // 取得生肖 emoji
        function getShengXiaoEmoji(shengXiaoName) {
            const emojiMap = {
                '鼠': '🐭', '牛': '🐂', '虎': '🐅', '兔': '🐇', '龍': '🐉', '蛇': '🐍',
                '馬': '🐎', '羊': '🐑', '猴': '🐒', '雞': '🐓', '狗': '🐕', '豬': '🐖'
            };
            return emojiMap[shengXiaoName] || shengXiaoName;
        }

        // 取得節氣描述
        function getJieqiDescription(jieqiName) {
            const descriptions = {
                '立春': '春季開始，萬物復甦，氣溫回升。', '雨水': '降雨增多，草木萌動，春耕開始。',
                '驚蟄': '春雷響動，驚醒冬眠動物，氣溫漸升。', '春分': '晝夜等長，春意盎然，南北半球氣溫趨於平衡。',
                '清明': '氣候清爽明朗，萬物潔淨，是掃墓祭祖的日子。', '穀雨': '雨水滋潤，穀物生長，是播種移苗的好時節。',
                '立夏': '夏季開始，萬物繁茂，氣溫明顯升高。', '小滿': '麥類等夏熟作物籽粒開始飽滿，但尚未成熟。',
                '芒種': '有芒作物（如麥、稻）成熟，可以收穫和播種。', '夏至': '北半球白晝最長，陽氣最盛，是盛夏的開始。',
                '小暑': '天氣開始炎熱，但還未到最熱的時候。', '大暑': '一年中最炎熱的時期，濕熱交蒸。',
                '立秋': '秋季開始，氣溫逐漸下降，但仍有暑熱。', '處暑': '暑氣漸退，天氣轉涼，但仍有「秋老虎」。',
                '白露': '天氣轉涼，水氣凝結成露珠，天氣漸寒。', '秋分': '晝夜等長，秋高氣爽，是收穫的季節。',
                '寒露': '氣溫更低，露水更多，天氣轉冷。', '霜降': '天氣漸冷，露水凝結成霜，是秋季的最後一個節氣。',
                '立冬': '冬季開始，萬物收藏，氣溫顯著下降。', '小雪': '開始降雪，但雪量不大，氣溫持續走低。',
                '大雪': '降雪量增多，天氣更冷，冰凍現象常見。', '冬至': '北半球白晝最短，夜晚最長，是數九寒天的開始。',
                '小寒': '天氣寒冷，尚未達到最冷。', '大寒': '一年中最寒冷的時期，嚴寒冰凍。'
            };
            return descriptions[jieqiName] || '此節氣無詳細說明。';
        }

        // 取得節日資訊
        function getHolidays(year) {
            const holidays = [
                { name: '元旦', date: new Date(year, 0, 1) }, { name: '和平紀念日', date: new Date(year, 1, 28) },
                { name: '兒童節', date: new Date(year, 3, 4) }, { name: '清明節', date: new Date(year, 3, 4) },
                { name: '勞動節', date: new Date(year, 4, 1) }, { name: '國慶日', date: new Date(year, 9, 10) },
                { name: '聖誕節', date: new Date(year, 11, 25) }
            ];
            const lunarNewYear = Lunar.fromYmd(year, 1, 1).getSolar();
            holidays.push({ name: '農曆新年', date: new Date(lunarNewYear.getYear(), lunarNewYear.getMonth() - 1, lunarNewYear.getDay()) });
            const dragonBoatFestival = Lunar.fromYmd(year, 5, 5).getSolar();
            holidays.push({ name: '端午節', date: new Date(dragonBoatFestival.getYear(), dragonBoatFestival.getMonth() - 1, dragonBoatFestival.getDay()) });
            const ghostFestival = Lunar.fromYmd(year, 7, 15).getSolar();
            holidays.push({ name: '中元節', date: new Date(ghostFestival.getYear(), ghostFestival.getMonth() - 1, ghostFestival.getDay()) });
            const midAutumnFestival = Lunar.fromYmd(year, 8, 15).getSolar();
            holidays.push({ name: '中秋節', date: new Date(midAutumnFestival.getYear(), midAutumnFestival.getMonth() - 1, midAutumnFestival.getDay()) });
            const doubleNinthFestival = Lunar.fromYmd(year, 9, 9).getSolar();
            holidays.push({ name: '重陽節', date: new Date(doubleNinthFestival.getYear(), doubleNinthFestival.getMonth() - 1, doubleNinthFestival.getDay()) });
            const nextLunarNewYearSolar = Lunar.fromYmd(year + 1, 1, 1).getSolar();
            const chineseNewYearsEveDate = new Date(nextLunarNewYearSolar.getYear(), nextLunarNewYearSolar.getMonth() - 1, nextLunarNewYearSolar.getDay() - 1);
            holidays.push({ name: '除夕', date: chineseNewYearsEveDate });
            holidays.sort((a, b) => a.date.getTime() - b.date.getTime());
            return holidays;
        }

        // 取得時辰名稱
        function getShiChen(h) {
            if (h >= 23 || h < 1) return '子'; if (h >= 1 && h < 3) return '丑'; if (h >= 3 && h < 5) return '寅';
            if (h >= 5 && h < 7) return '卯'; if (h >= 7 && h < 9) return '辰'; if (h >= 9 && h < 11) return '巳';
            if (h >= 11 && h < 13) return '午'; if (h >= 13 && h < 15) return '未'; if (h >= 15 && h < 17) return '申';
            if (h >= 17 && h < 19) return '酉'; if (h >= 19 && h < 21) return '戌'; if (h >= 21 && h < 23) return '亥';
            return '';
        }

        // 取得詳細時間段（凌晨、清晨等）
        function getDetailedTimePeriod(hour) {
            if (hour >= 0 && hour < 5) return '凌晨'; if (hour >= 5 && hour < 9) return '清晨';
            if (hour >= 9 && hour < 12) return '上午'; if (hour === 12) return '中午';
            if (hour > 12 && hour < 17) return '下午'; if (hour >= 17 && hour < 19) return '傍晚';
            if (hour >= 19 && hour < 23) return '夜晚'; if (hour === 23) return '深夜';
            return '';
        }

        // [修正] 獨立的跑馬燈更新邏輯，根據傳入的內容決定顯示/隱藏及動畫
        function updateMarquee(combinedJieqiHolidayText) {
            const jieqiHolidayMarqueeContainer = document.getElementById('jieqiHolidayMarqueeContainer');
            const jieqiHolidayMarqueeInner = document.getElementById('jieqiHolidayMarqueeInner');
            const jieqiHolidayMarqueeContent = jieqiHolidayMarqueeInner?.querySelector('.jieqi-holiday-marquee-content');
            const jieqiHolidayMarqueeContentDuplicate = jieqiHolidayMarqueeInner?.querySelector('.jieqi-holiday-marquee-content-duplicate');

            if (!jieqiHolidayMarqueeContainer || !jieqiHolidayMarqueeInner || !jieqiHolidayMarqueeContent || !jieqiHolidayMarqueeContentDuplicate) {
                return;
            }

            // 如果沒有文字，隱藏容器並停止動畫
            if (!combinedJieqiHolidayText) {
                jieqiHolidayMarqueeContainer.style.display = 'none';
                jieqiHolidayMarqueeContent.innerHTML = '';
                jieqiHolidayMarqueeContentDuplicate.innerHTML = '';
                jieqiHolidayMarqueeContainer.classList.remove('scrolling');
                jieqiHolidayMarqueeInner.style.animationName = 'none'; // 停止動畫
                return;
            }

            // 如果有文字，顯示容器並只更新主內容
            jieqiHolidayMarqueeContainer.style.display = ''; // 恢復預設顯示
            jieqiHolidayMarqueeContent.innerHTML = combinedJieqiHolidayText;
            // *** FIX: 先清除重複的內容以避免閃爍 ***
            jieqiHolidayMarqueeContentDuplicate.innerHTML = ''; 

            // 使用 setTimeout 確保 DOM 更新後再計算寬度
            setTimeout(() => {
                const singleContentWidth = jieqiHolidayMarqueeContent.scrollWidth;
                const containerWidth = jieqiHolidayMarqueeContainer.offsetWidth;

                if (singleContentWidth > containerWidth) {
                    // *** FIX: 只有在需要滾動時才設定重複的內容 ***
                    jieqiHolidayMarqueeContentDuplicate.innerHTML = combinedJieqiHolidayText;
                    jieqiHolidayMarqueeContainer.classList.add('scrolling');
                    const speed = 60; // 每秒像素
                    const animationDuration = singleContentWidth / speed;
                    jieqiHolidayMarqueeInner.style.setProperty('--marquee-scroll-distance', `-${singleContentWidth}px`);
                    jieqiHolidayMarqueeInner.style.animationName = 'marquee'; // 重新應用動畫
                    jieqiHolidayMarqueeInner.style.animationDuration = `${animationDuration}s`;
                    jieqiHolidayMarqueeInner.style.animationPlayState = 'running';
                    jieqiHolidayMarqueeContainer.style.textAlign = 'left';
                } else {
                    jieqiHolidayMarqueeContainer.classList.remove('scrolling');
                    // 重複的內容已經被清除
                    jieqiHolidayMarqueeInner.style.animationName = 'none';
                    jieqiHolidayMarqueeInner.style.animationPlayState = 'paused';
                    jieqiHolidayMarqueeContainer.style.textAlign = 'center';
                }
            }, 50);
        }

        // [修正] 更新日期和時間顯示，採用非破壞性 DOM 更新
        function updateDateTime() {
            const now = new Date();
            const currentSeconds = now.getSeconds();
            const secondTensDigit = Math.floor(currentSeconds / 10);

            if (secondTensDigit !== lastSecondTensDigit) {
                moveRandomly();
                lastSecondTensDigit = secondTensDigit;
            }

            // --- 資料計算 ---
            const timeOptions = { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: displaySettings.showAmPm };
            const formatter = new Intl.DateTimeFormat('zh-Hant', timeOptions);
            const parts = formatter.formatToParts(now);
            const hourPart = parts.find(p => p.type === 'hour')?.value.padStart(2, '0') || '00';
            const minutePart = parts.find(p => p.type === 'minute')?.value || '00';
            const secondPart = parts.find(p => p.type === 'second')?.value || '00';
            const hoursMinutes = `${hourPart}:${minutePart}`;
            const seconds = secondPart;
            const amPmText = displaySettings.showAmPm ? getDetailedTimePeriod(now.getHours()) : '';

            let gregorianDateHtml = '';
            if (displaySettings.showGregorianYear || displaySettings.showGregorianMonth || displaySettings.showGregorianDay || displaySettings.showGregorianWeekday) {
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const weekday = ['日', '一', '二', '三', '四', '五', '六'][now.getDay()];
                let gregorianParts = [];
                if (displaySettings.showGregorianYear) gregorianParts.push(`<span style="color: ${displaySettings.gregorianYearColor};">${year}年</span>`);
                if (displaySettings.showGregorianMonth) gregorianParts.push(`<span style="color: ${displaySettings.gregorianMonthColor};">${month}月</span>`);
                if (displaySettings.showGregorianDay) gregorianParts.push(`<span style="color: ${displaySettings.gregorianDayColor};">${day}日</span>`);
                if (displaySettings.showGregorianWeekday) gregorianParts.push(`<span style="color: ${displaySettings.gregorianWeekdayColor};">周${weekday}</span>`);
                gregorianDateHtml = gregorianParts.join('');
            }

            let lunarDateString = '';
            let combinedJieqiHolidayText = '';
            let currentJieqiInfo = null, nextHolidayInfo = null, currentHolidayName = '';
            let tempJieqiName = '', tempJieqiDate = null, tempDaysUntilNextJieqi = -1;
            
            if (typeof Lunar !== 'undefined' && typeof Solar !== 'undefined') {
                const solar = Solar.fromDate(now);
                const lunar = solar.getLunar();
                if (displaySettings.showMinguoYear || displaySettings.showLunarMonth || displaySettings.showLunarDay || displaySettings.showLunarShiChen) {
                    let lunarParts = [];
                    if (displaySettings.showMinguoYear) lunarParts.push(`<span style="color: ${displaySettings.minguoYearColor};">${now.getFullYear() - 1911}年${getShengXiaoEmoji(lunar.getYearShengXiao())}</span>`);
                    if (displaySettings.showLunarMonth) lunarParts.push(`<span style="color: ${displaySettings.lunarMonthColor};">${lunar.getMonthInChinese().replace('闰', '閏')}月</span>`);
                    if (displaySettings.showLunarDay) lunarParts.push(`<span id="lunarDayDisplay" class="lunar-date-clickable" style="color: ${displaySettings.lunarDayColor};">${lunar.getDayInChinese()}</span>`);
                    if (displaySettings.showLunarShiChen) lunarParts.push(`<span id="lunarShiChenDisplay" class="lunar-shichen-clickable" style="color: ${displaySettings.lunarShiChenColor};">${getShiChen(now.getHours())}時</span>`);
                    lunarDateString = lunarParts.join('');
                }

                const allJieqis = Object.entries(lunar.getJieQiTable()).map(([name, dateStr]) => ({ name, date: new Date(dateStr) })).sort((a, b) => a.date.getTime() - b.date.getTime());
                let foundTodayJieqi = false;
                for (const jq of allJieqis) {
                    if (jq.date.getFullYear() === now.getFullYear() && jq.date.getMonth() === now.getMonth() && jq.date.getDate() === now.getDate()) {
                        tempJieqiName = jq.name; tempJieqiDate = jq.date; foundTodayJieqi = true; tempDaysUntilNextJieqi = 0; break;
                    }
                }
                if (!foundTodayJieqi) {
                    for (const jq of allJieqis) {
                        const jqDateAtEndOfDay = new Date(jq.date.getFullYear(), jq.date.getMonth(), jq.date.getDate(), 23, 59, 59, 999);
                        if (jqDateAtEndOfDay > now) {
                            tempDaysUntilNextJieqi = Math.ceil((jqDateAtEndOfDay.getTime() - now.getTime()) / 86400000);
                            tempJieqiName = jq.name; tempJieqiDate = jq.date; break;
                        }
                    }
                }
                if (tempJieqiName && tempJieqiDate) currentJieqiInfo = { name: tempJieqiName, date: tempJieqiDate };

                const holidays = getHolidays(now.getFullYear());
                let foundTodayHoliday = false;
                for (const holiday of holidays) {
                    if (holiday.date.getFullYear() === now.getFullYear() && holiday.date.getMonth() === now.getMonth() && holiday.date.getDate() === now.getDate()) {
                        currentHolidayName = holiday.name; foundTodayHoliday = true; break;
                    }
                }
                if (!foundTodayHoliday) {
                    for (const holiday of holidays) {
                        const holidayDateAtEndOfDay = new Date(holiday.date.getFullYear(), holiday.date.getMonth(), holiday.date.getDate(), 23, 59, 59, 999);
                        if (holidayDateAtEndOfDay >= new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1)) {
                            nextHolidayInfo = { name: holiday.name, date: holiday.date, daysUntil: Math.ceil((holidayDateAtEndOfDay.getTime() - now.getTime()) / 86400000) };
                            break;
                        }
                    }
                }
                
                let jieQiText = '';
                if (displaySettings.showJieqi) {
                    if (foundTodayJieqi) jieQiText = `今日節氣：${tempJieqiName}`;
                    else if (tempJieqiName && tempDaysUntilNextJieqi !== -1) jieQiText = `${tempDaysUntilNextJieqi}➡${tempJieqiName}`;
                }
                let holidayCountdownText = '';
                if (displaySettings.showHolidays) {
                    if (foundTodayHoliday) holidayCountdownText = `今日節日：${currentHolidayName}`;
                    else if (nextHolidayInfo) holidayCountdownText = `${nextHolidayInfo.daysUntil}➡${nextHolidayInfo.name}`;
                }

                let combinedParts = [];
                if (jieQiText) combinedParts.push(`<span style="color: ${displaySettings.jieqiColor};">${jieQiText}</span>`);
                if (holidayCountdownText) combinedParts.push(`<span style="color: ${displaySettings.holidayColor};">${holidayCountdownText}</span>`);
                combinedJieqiHolidayText = combinedParts.join('');
            }
            
            // --- DOM 更新 ---
            const dateTimeDisplay = document.getElementById('dateTimeDisplay');
            if (!dateTimeDisplay.querySelector('.time-text')) { // 首次或意外清空後，建立結構
                dateTimeDisplay.innerHTML = `
                    <div class="time-text">
                        <span></span>
                        <span class="time-seconds" id="secondsDisplay"></span>
                    </div>
                    <div class="gregorian-date-text"></div>
                    <div class="lunar-and-jieqi-line">
                        <span class="lunar-date-static-text lunar-date-clickable"></span>
                        <div id="jieqiHolidayMarqueeContainer" class="jieqi-holiday-marquee-container" style="display: none;">
                            <div id="jieqiHolidayMarqueeInner" class="jieqi-holiday-marquee-inner">
                                <span class="jieqi-holiday-marquee-content"></span>
                                <span class="jieqi-holiday-marquee-content-duplicate"></span>
                            </div>
                        </div>
                    </div>`;
            }
            
            // 更新時間
            const timeTextEl = dateTimeDisplay.querySelector('.time-text');
            timeTextEl.style.color = displaySettings.textColor;
            timeTextEl.querySelector('span:first-child').textContent = hoursMinutes;
            dateTimeDisplay.querySelector('#secondsDisplay').textContent = seconds;
            let amPmSpan = dateTimeDisplay.querySelector('.time-ampm');
            if (amPmText) {
                if (!amPmSpan) {
                    amPmSpan = document.createElement('span');
                    amPmSpan.className = 'time-ampm';
                    timeTextEl.appendChild(amPmSpan);
                }
                amPmSpan.textContent = amPmText;
            } else if (amPmSpan) {
                amPmSpan.remove();
            }

            // 更新公曆
            const gregorianDiv = dateTimeDisplay.querySelector('.gregorian-date-text');
            gregorianDiv.innerHTML = gregorianDateHtml;
            gregorianDiv.style.display = gregorianDateHtml ? '' : 'none';

            // 更新農曆
            const lunarDateStaticText = dateTimeDisplay.querySelector('.lunar-date-static-text');
            lunarDateStaticText.innerHTML = lunarDateString;
            lunarDateStaticText.style.display = lunarDateString ? '' : 'none';
            
            // 更新跑馬燈資料屬性
            const marqueeContainer = document.getElementById('jieqiHolidayMarqueeContainer');
            marqueeContainer.setAttribute('data-jieqi-name', currentJieqiInfo ? currentJieqiInfo.name : '');
            marqueeContainer.setAttribute('data-jieqi-date', currentJieqiInfo ? currentJieqiInfo.date.toISOString() : '');
            marqueeContainer.setAttribute('data-days-until-next-jieqi', tempDaysUntilNextJieqi !== -1 ? tempDaysUntilNextJieqi : '');
            marqueeContainer.setAttribute('data-next-holiday-name', nextHolidayInfo ? nextHolidayInfo.name : '');
            marqueeContainer.setAttribute('data-next-holiday-date', nextHolidayInfo ? nextHolidayInfo.date.toISOString() : '');
            marqueeContainer.setAttribute('data-next-holiday-days-until', nextHolidayInfo ? nextHolidayInfo.daysUntil : '');
            marqueeContainer.setAttribute('data-current-holiday-name', currentHolidayName);
            
            // [修正] 只有在節氣/節日內容實際變更時才更新跑馬燈，以防止動畫閃爍
            if (combinedJieqiHolidayText !== lastJieqiHolidayContent) {
                updateMarquee(combinedJieqiHolidayText);
                lastJieqiHolidayContent = combinedJieqiHolidayText;
            }
            
            document.body.style.backgroundColor = displaySettings.backgroundColor;
        }

        // 隨機移動顯示元素
        function moveRandomly() {
            const displayElement = document.getElementById('dateTimeDisplay');
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const elementRect = displayElement.getBoundingClientRect();
            const elementWidth = elementRect.width;
            const elementHeight = elementRect.height;
            const safeMargin = 20;
            const smallOffsetRange = 40;

            let currentX = currentPosition.x;
            let currentY = currentPosition.y;

            const offsetX = (Math.random() * 2 - 1) * smallOffsetRange;
            const offsetY = (Math.random() * 2 - 1) * smallOffsetRange;

            let newTargetX = currentX + offsetX;
            let newTargetY = currentY + offsetY;

            const minAllowedX = - (viewportWidth / 2) + (elementWidth / 2) + safeMargin;
            const minAllowedY = - (viewportHeight / 2) + (elementHeight / 2) + safeMargin;
            const maxAllowedX = (viewportWidth / 2) - (elementWidth / 2) - safeMargin;
            const maxAllowedY = (viewportHeight / 2) - (elementHeight / 2) - safeMargin;

            newTargetX = Math.max(minAllowedX, Math.min(newTargetX, maxAllowedX));
            newTargetY = Math.max(minAllowedY, Math.min(newTargetY, maxAllowedY));

            currentPosition.x = newTargetX;
            currentPosition.y = newTargetY;
            displayElement.style.transform = `translate(calc(-50% + ${newTargetX}px), calc(-70% + ${newTargetY}px))`;
        }

        // 恢復預設設定
        function restoreDefaults() {
            displaySettings = { ...defaultDisplaySettings };
            saveSettings();
            updateSettingsModalCheckboxes();
            updateDateTime();
            // 強制更新跑馬燈
            lastJieqiHolidayContent = ''; 
            updateDateTime();
        }

        // 取得隨機顏色
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 設定隨機顏色
        function setRandomColors() {
            Object.keys(displaySettings).forEach(key => {
                if (key.toLowerCase().includes('color')) {
                    displaySettings[key] = getRandomColor();
                }
            });
            saveSettings();
            updateSettingsModalCheckboxes();
            // 強制更新跑馬燈
            lastJieqiHolidayContent = ''; 
            updateDateTime();
        }

        window.onload = function () {
            loadSettings();
            updateSettingsModalCheckboxes();
            currentPosition = { x: 0, y: 0 };
            setInterval(updateDateTime, 1000);
            updateDateTime(); // 首次載入時呼叫一次以初始化顯示

            // 設定模態框按鈕事件
            document.getElementById('doneBtn').onclick = () => document.getElementById('settingsModal').classList.remove('is-active');
            document.getElementById('closeJieqiDetailsBtn').onclick = () => document.getElementById('jieqiDetailsModal').classList.remove('is-active');
            document.getElementById('closeYijiDetailsBtn').onclick = () => document.getElementById('yijiDetailsModal').classList.remove('is-active');

            // 設定切換開關事件
            const toggleIds = ['showAmPm', 'showGregorianYear', 'showGregorianMonth', 'showGregorianDay', 'showGregorianWeekday', 'showMinguoYear', 'showLunarMonth', 'showLunarDay', 'showLunarShiChen', 'showJieqi', 'showHolidays'];
            toggleIds.forEach(id => {
                document.getElementById(id).onchange = function(event) {
                    displaySettings[id] = event.target.checked;
                    saveSettings();
                    // 強制更新跑馬燈
                    lastJieqiHolidayContent = '';
                    updateDateTime();
                };
            });

            // 顏色選擇器事件
            const colorIds = ['textColor', 'backgroundColor', 'gregorianYearColor', 'gregorianMonthColor', 'gregorianDayColor', 'gregorianWeekdayColor', 'minguoYearColor', 'lunarMonthColor', 'lunarDayColor', 'lunarShiChenColor', 'jieqiColor', 'holidayColor'];
            colorIds.forEach(id => {
                document.getElementById(id).oninput = function(event) {
                    displaySettings[id] = event.target.value;
                    saveSettings();
                    // 顏色變化也需要強制更新
                    lastJieqiHolidayContent = '';
                    updateDateTime();
                };
            });

            // 功能按鈕事件
            document.getElementById('restoreDefaultsBtn').onclick = restoreDefaults;
            document.getElementById('randomColorsBtn').onclick = setRandomColors;

            // 點擊顯示區域的事件處理
            document.getElementById('dateTimeDisplay').addEventListener('click', function(event) {
                const now = new Date();
                const solar = Solar.fromDate(now);
                const lunar = solar.getLunar();

                const secondsElement = event.target.closest('#secondsDisplay');
                const jieqiHolidayMarqueeContainerElement = event.target.closest('#jieqiHolidayMarqueeContainer'); 
                const lunarDayElement = event.target.closest('#lunarDayDisplay');
                const lunarShiChenElement = event.target.closest('#lunarShiChenDisplay');

                if (secondsElement) {
                    document.getElementById('settingsModal').classList.add('is-active');
                    updateSettingsModalCheckboxes();
                } else if (jieqiHolidayMarqueeContainerElement && jieqiHolidayMarqueeContainerElement.style.display !== 'none') {
                    const jieqiName = jieqiHolidayMarqueeContainerElement.getAttribute('data-jieqi-name');
                    const jieqiDateStr = jieqiHolidayMarqueeContainerElement.getAttribute('data-jieqi-date');
                    const daysUntilNextJieqi = jieqiHolidayMarqueeContainerElement.getAttribute('data-days-until-next-jieqi');
                    const nextHolidayName = jieqiHolidayMarqueeContainerElement.getAttribute('data-next-holiday-name');
                    const nextHolidayDateStr = jieqiHolidayMarqueeContainerElement.getAttribute('data-next-holiday-date');
                    const nextHolidayDaysUntil = jieqiHolidayMarqueeContainerElement.getAttribute('data-next-holiday-days-until');
                    const currentHolidayNameFromData = jieqiHolidayMarqueeContainerElement.getAttribute('data-current-holiday-name');

                    let detailsHtml = '';
                    let hasJieqiInfo = false;

                    if (jieqiName && jieqiDateStr) {
                        hasJieqiInfo = true;
                        const jieqiDate = new Date(jieqiDateStr);
                        const formattedDate = `${jieqiDate.getFullYear()}年${(jieqiDate.getMonth() + 1).toString().padStart(2, '0')}月${jieqiDate.getDate().toString().padStart(2, '0')}日`;
                        const description = getJieqiDescription(jieqiName);
                        if (parseInt(daysUntilNextJieqi) === 0) {
                            detailsHtml += `<p>今日 <strong>${formattedDate} ${jieqiName}</strong></p>`;
                        } else {
                            detailsHtml += `<p>${formattedDate} <strong>${jieqiName}</strong> 還有${daysUntilNextJieqi}天</p>`;
                        }
                        detailsHtml += `<p style="margin-top: 15px;">說明： ${description}</p>`;
                    }
                    
                    if (currentHolidayNameFromData || (nextHolidayName && nextHolidayDateStr && nextHolidayDaysUntil)) {
                        if(hasJieqiInfo) detailsHtml += `<hr style="margin: 20px 0; border-color: #555;">`;
                        if (currentHolidayNameFromData) {
                            detailsHtml += `<p>今日 <strong>${currentHolidayNameFromData}</strong></p>`;
                        } else {
                            const nextHolidayDate = new Date(nextHolidayDateStr);
                            const formattedHolidayDate = `${nextHolidayDate.getFullYear()}年${(nextHolidayDate.getMonth() + 1).toString().padStart(2, '0')}月${nextHolidayDate.getDate().toString().padStart(2, '0')}日`;
                            detailsHtml += `<p>${formattedHolidayDate} <strong>${nextHolidayName}</strong> 還有${nextHolidayDaysUntil}天</p>`;
                        }
                    }

                    if (!detailsHtml) detailsHtml = `<p>目前沒有節氣或節日資訊可顯示。</p>`;

                    document.getElementById('jieqiDetailsContent').innerHTML = detailsHtml;
                    document.getElementById('jieqiDetailsModal').classList.add('is-active');
                } else if (lunarDayElement) {
                    const yiList = lunar.getDayYi() || [];
                    const jiList = lunar.getDayJi() || [];
                    document.getElementById('yijiDetailsContent').innerHTML = `
                        <p><strong>農曆日期：</strong> ${lunar.getMonthInChinese().replace('闰', '閏')}月${lunar.getDayInChinese()}</p>
                        <p style="margin-top: 15px;"><strong>宜：</strong> ${yiList.join('、') || '無'}</p>
                        <p style="margin-top: 15px;"><strong>忌：</strong> ${jiList.join('、') || '無'}</p>
                        <p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">每日宜忌僅供參考，請勿過度迷信。</p>`;
                    document.getElementById('yijiDetailsModal').classList.add('is-active');
                } else if (lunarShiChenElement) {
                    const hourYiList = lunar.getTimeYi() || [];
                    const hourJiList = lunar.getTimeJi() || [];
                    document.getElementById('yijiDetailsContent').innerHTML = `
                        <p><strong>時辰：</strong> ${getShiChen(now.getHours())}時</p>
                        <p style="margin-top: 15px;"><strong>宜：</strong> ${hourYiList.join('、') || '無'}</p>
                        <p style="margin-top: 15px;"><strong>忌：</strong> ${hourJiList.join('、') || '無'}</p>
                        <p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">時辰宜忌僅供參考，請勿過度迷信。</p>`;
                    document.getElementById('yijiDetailsModal').classList.add('is-active');
                }
            });
        };
    </script>
</body>
</html>
