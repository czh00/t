<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時間</title>
    <style>
        /* CSS 樣式保持不變 */
        /* 全局樣式：設定所有元素的盒模型為 border-box */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* body 樣式：設定頁面為全屏顯示，內容居中，背景為黑色 */
        body {
            margin: 0;
            overflow: hidden; /* 隱藏超出視窗的內容 */
            display: flex; /* 使用 Flexbox 佈局 */
            flex-direction: column; /* 垂直排列子元素 */
            justify-content: center; /* 垂直居中對齊 */
            align-items: center; /* 水平居中對齊 */
            min-height: 100vh; /* 最小高度為視窗高度 */
            width: 100vw; /* 寬度為視窗寬度 */
            position: relative; /* 相對定位 */
            /* background-color: black; */ /* 已移除，由 JavaScript 控制 */
            perspective: none; /* 禁用 3D 透視 */
            transform-style: flat; /* 禁用 3D 變換樣式 */
            font-family: 'Inter', sans-serif; /* 使用 Inter 字體 */
        }

        /* dateTimeDisplay 樣式：時間顯示容器的樣式，包括字體、顏色、陰影和定位 */
        #dateTimeDisplay {
            font-family: 'Segoe UI', Arial, sans-serif; /* 字體設定 */
            font-weight: bold; /* 字體加粗 */
            text-align: center; /* 文字居中對齊 */
            padding: 10px; /* 內邊距 */
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5); /* 文字陰影 */
            /* color: #00FF00; */ /* 已移除，由 JavaScript 控制 */
            position: absolute; /* 絕對定位 */
            transition: transform 1s ease-in-out; /* 變換過渡效果 */
            z-index: 1; /* 層級 */
            transform: translate(-50%, -50%); /* 居中定位 */
            left: 50%; /* 左邊距 50% */
            top: 50%; /* 上邊距 50% */
        }

        /* time-text 樣式：顯示時分的主時間文字樣式 */
        .time-text {
            font-size: 26vw; /* 字體大小根據視窗寬度調整 */
            margin-bottom: -10vw; /* 底部外邊距 */
            position: relative; /* 相對定位 */
            display: inline-block; /* 行內塊級元素 */
        }

        /* time-seconds 樣式：顯示秒數的文字樣式 */
        .time-seconds {
            font-size: 6.25vw; /* 字體大小根據視窗寬度調整 */
            position: absolute; /* 絕對定位 */
            top: 8vw; /* 距離頂部 */
            right: -12vw; /* 距離右側 */
            cursor: pointer; /* 鼠標懸停時顯示手型 */
        }

        /* gregorian-date-text 樣式：顯示公曆日期的文字樣式 */
        .gregorian-date-text {
            font-size: 9vw; /* 字體大小根據視窗寬度調整 */
            margin-bottom: -3vw; /* 底部外邊距 */
            display: block; /* 塊級元素 */
            white-space: nowrap; /* 不換行 */
        }

        /* 加入農曆和節氣相關的樣式 */
        /* lunar-jieqi-combined-text 樣式：顯示農曆和節氣的文字樣式 */
        .lunar-jieqi-combined-text {
            font-size: 6vw; /* 字體大小根據視窗寬度調整 */
            display: block; /* 塊級元素 */
            white-space: nowrap; /* 不換行 */
            /* color: #00FF00; */ /* 已移除，將繼承父元素的顏色設定 */
        }

        /* noscript-message 樣式：當 JavaScript 被禁用時顯示的提示訊息樣式 */
        .noscript-message {
            font-size: 0.5em; /* 字體大小 */
            color: #FFB3BA; /* 淺紅色 */
            margin-top: 10px; /* 頂部外邊距 */
            display: block; /* 塊級元素 */
        }

        /* 設定彈出視窗的樣式 */
        .settings-modal {
            display: none; /* 預設隱藏 */
            position: fixed; /* 固定定位 */
            z-index: 100; /* 確保在最上層 */
            left: 0;
            top: 0;
            width: 100%; /* 全寬 */
            height: 100%; /* 全高 */
            overflow: auto; /* 允許滾動 */
            background-color: rgba(0, 0, 0, 0.7); /* 半透明黑色背景 */
            display: flex; /* 使用 Flexbox 居中內容 */
            justify-content: center;
            align-items: center;
        }

        /* 設定彈出視窗內容的樣式 */
        .settings-content {
            background-color: #333; /* 深灰色背景 */
            margin: auto; /* 自動外邊距，用於居中 */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* 寬度佔 80% */
            max-width: 400px; /* 最大寬度 */
            border-radius: 10px; /* 圓角 */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); /* 陰影 */
            color: #00FF00; /* 文字顏色 */
            text-align: center; /* 文字居中 */
        }

        /* 關閉按鈕樣式 */
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        /* 設定項目樣式 */
        .setting-item {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-item label {
            font-size: 1.2em;
        }

        /* 開關按鈕樣式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #00FF00;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #00FF00;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
    </style>
    <!-- 加入對外部 lunar-javascript 函式庫的引用，用於農曆和節氣計算 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.7.0/lunar.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <!-- 時間、日期、農曆和節氣的顯示容器 -->
    <div id="dateTimeDisplay"></div>

    <!-- 如果瀏覽器不支援 JavaScript，顯示此訊息 -->
    <noscript>
            <div class="noscript-message">
                您的瀏覽器不支援或已禁用 JavaScript。
            </div>
    </noscript>

    <!-- 設定彈出視窗 -->
    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h2>顯示設定</h2>
            <h3>公曆</h3>
            <div class="setting-item">
                <label for="showGregorianYear">年</label>
                <label class="switch">
                    <input type="checkbox" id="showGregorianYear">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label for="showGregorianMonth">月</label>
                <label class="switch">
                    <input type="checkbox" id="showGregorianMonth">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label for="showGregorianDay">日</label>
                <label class="switch">
                    <input type="checkbox" id="showGregorianDay">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label for="showGregorianWeekday">周</label>
                <label class="switch">
                    <input type="checkbox" id="showGregorianWeekday">
                    <span class="slider"></span>
                </label>
            </div>

            <h3>農曆</h3>
            <div class="setting-item">
                <label for="showMinguoYear">年</label>
                <label class="switch">
                    <input type="checkbox" id="showMinguoYear">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label for="showLunarMonth">月</label>
                <label class="switch">
                    <input type="checkbox" id="showLunarMonth">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label for="showLunarDay">日</label>
                <label class="switch">
                    <input type="checkbox" id="showLunarDay">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label for="showLunarShiChen">時</label>
                <label class="switch">
                    <input type="checkbox" id="showLunarShiChen">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label for="showJieqi">節氣</label>
                <label class="switch">
                    <input type="checkbox" id="showJieqi">
                    <span class="slider"></span>
                </label>
            </div>

            <h3>顏色設定</h3>
            <div class="setting-item">
                <label for="textColor">文字顏色</label>
                <input type="color" id="textColor" value="#00FF00">
            </div>
            <div class="setting-item">
                <label for="backgroundColor">背景顏色</label>
                <input type="color" id="backgroundColor" value="#000000">
            </div>
        </div>
    </div>

    <script>
        let lastSecondTensDigit = -1; // 用於追蹤秒數的十位數，以觸發每十秒的隨機移動
        let currentPosition = { x: 0, y: 0 }; // 追蹤時間顯示元素的當前位置

        // 預設顯示設定
        let displaySettings = {
            showGregorianYear: true,
            showGregorianMonth: true,
            showGregorianDay: true,
            showGregorianWeekday: true,
            showMinguoYear: true,
            showLunarMonth: true,
            showLunarDay: true,
            showLunarShiChen: true,
            showJieqi: true,
            textColor: '#00FF00', // 新增文字顏色設定
            backgroundColor: '#000000' // 新增背景顏色設定
        };

        /**
         * 將顯示設定儲存到 Cookie 中。
         */
        function saveSettings() {
            // 將 displaySettings 物件轉換為 JSON 字串
            const settingsJson = JSON.stringify(displaySettings);
            // 將 JSON 字串儲存為名為 'displaySettings' 的 Cookie，有效期為 365 天
            document.cookie = `displaySettings=${settingsJson}; expires=${new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toUTCString()}; path=/`;
        }

        /**
         * 從 Cookie 中載入顯示設定。
         */
        function loadSettings() {
            // 讀取所有 Cookie
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                // 查找名為 'displaySettings' 的 Cookie
                if (cookie.startsWith('displaySettings=')) {
                    try {
                        // 解析 Cookie 中的 JSON 字串，並更新 displaySettings
                        const settingsJson = cookie.substring('displaySettings='.length);
                        const loadedSettings = JSON.parse(settingsJson);
                        // 遍歷 loadedSettings 並更新 displaySettings，確保所有預設值都被覆蓋
                        for (const key in loadedSettings) {
                            if (displaySettings.hasOwnProperty(key)) {
                                displaySettings[key] = loadedSettings[key];
                            }
                        }
                    } catch (e) {
                        console.error("Failed to parse display settings from cookie:", e);
                    }
                    break;
                }
            }
        }

        /**
         * 更新設定彈出視窗中的開關狀態以匹配當前設定。
         */
        function updateSettingsModalCheckboxes() {
            document.getElementById('showGregorianYear').checked = displaySettings.showGregorianYear;
            document.getElementById('showGregorianMonth').checked = displaySettings.showGregorianMonth;
            document.getElementById('showGregorianDay').checked = displaySettings.showGregorianDay;
            document.getElementById('showGregorianWeekday').checked = displaySettings.showGregorianWeekday;
            document.getElementById('showMinguoYear').checked = displaySettings.showMinguoYear;
            document.getElementById('showLunarMonth').checked = displaySettings.showLunarMonth;
            document.getElementById('showLunarDay').checked = displaySettings.showLunarDay;
            document.getElementById('showLunarShiChen').checked = displaySettings.showLunarShiChen;
            document.getElementById('showJieqi').checked = displaySettings.showJieqi;
            document.getElementById('textColor').value = displaySettings.textColor; // 更新文字顏色
            document.getElementById('backgroundColor').value = displaySettings.backgroundColor; // 更新背景顏色
        }

        /**
         * 更新時間、日期、農曆和節氣的顯示。
         * 每十秒會觸發一次隨機移動效果。
         */
        function updateDateTime() {
            const now = new Date(); // 獲取當前日期和時間
            const currentSeconds = now.getSeconds(); // 獲取當前秒數
            const secondTensDigit = Math.floor(currentSeconds / 10); // 計算秒數的十位數

            // 每十秒隨機移動一次
            if (secondTensDigit !== lastSecondTensDigit) {
                moveRandomly(); // 呼叫隨機移動函數
                lastSecondTensDigit = secondTensDigit; // 更新秒數的十位數
            }

            // 格式化時間
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }; // 時間格式選項
            const fullTimeString = now.toLocaleTimeString('zh-Hant', timeOptions); // 格式化完整時間字串
            const timeParts = fullTimeString.split(':'); // 分割時間字串
            let hoursMinutes = ''; // 時分部分
            let seconds = ''; // 秒數部分
            if (timeParts.length === 3) {
                hoursMinutes = `${timeParts[0]}:${timeParts[1]}`;
                seconds = timeParts[2];
            } else {
                hoursMinutes = fullTimeString;
            }

            // 公曆日期邏輯
            let gregorianDateHtml = '';
            if (displaySettings.showGregorianYear || displaySettings.showGregorianMonth || displaySettings.showGregorianDay || displaySettings.showGregorianWeekday) {
                const year = now.getFullYear();
                const month = now.getMonth() + 1;
                const day = now.getDate();
                const weekday = ['日', '一', '二', '三', '四', '五', '六'][now.getDay()];

                let gregorianParts = [];
                if (displaySettings.showGregorianYear) gregorianParts.push(`${year}年`);
                if (displaySettings.showGregorianMonth) gregorianParts.push(`${month}月`);
                if (displaySettings.showGregorianDay) gregorianParts.push(`${day}日`);
                if (displaySettings.showGregorianWeekday) gregorianParts.push(`周${weekday}`);

                if (gregorianParts.length > 0) {
                    gregorianDateHtml = `<div class="gregorian-date-text">${gregorianParts.join('')}</div>`;
                }
            }

            // 農曆和節氣邏輯 (僅在 lunar-javascript 函式庫載入成功時執行)
            let lunarAndJieQiHtml = '';
            if ((displaySettings.showMinguoYear || displaySettings.showLunarMonth || displaySettings.showLunarDay || displaySettings.showLunarShiChen || displaySettings.showJieqi) && typeof Lunar !== 'undefined' && typeof Solar !== 'undefined') {
                const year = now.getFullYear();
                const day = now.getDate();
                const hour = now.getHours();
                const minguoYear = year - 1911;

                const solar = Solar.fromYmd(year, now.getMonth() + 1, day);
                const lunar = solar.getLunar();

                /**
                 * 根據小時獲取時辰。
                 * @param {number} h - 當前小時 (0-23)。
                 * @returns {string} 對應的時辰字串。
                 */
                function getShiChen(h) {
                    if (h >= 23 || h < 1) return '子';
                    if (h >= 1 && h < 3) return '丑';
                    if (h >= 3 && h < 5) return '寅';
                    if (h >= 5 && h < 7) return '卯';
                    if (h >= 7 && h < 9) return '辰';
                    if (h >= 9 && h < 11) return '巳';
                    if (h >= 11 && h < 13) return '午';
                    if (h >= 13 && h < 15) return '未';
                    if (h >= 15 && h < 17) return '申';
                    if (h >= 17 && h < 19) return '酉';
                    if (h >= 19 && h < 21) return '戌';
                    if (h >= 21 && h < 23) return '亥';
                    return '';
                }

                let lunarParts = [];
                if (displaySettings.showMinguoYear) lunarParts.push(`${minguoYear}${lunar.getYearShengXiao()}年`);
                if (displaySettings.showLunarMonth) lunarParts.push(`${lunar.getMonthInChinese()}月`);
                if (displaySettings.showLunarDay) lunarParts.push(`${lunar.getDayInChinese()}`);
                if (displaySettings.showLunarShiChen) lunarParts.push(`${getShiChen(hour)}時`);

                let lunarDateString = lunarParts.join('');

                let jieQiText = '';
                if (displaySettings.showJieqi) {
                    const today = Solar.fromDate(now);
                    const lunarToday = today.getLunar();
                    let nextJieQi = null;
                    let nextJieQiDate = null;
                    let minDiff = Infinity;

                    const jieQis = lunarToday.getJieQiTable();
                    for (const [name, dateStr] of Object.entries(jieQis)) {
                        const date = new Date(dateStr + 'T00:00:00');
                        if (date >= now) {
                            const diff = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
                            if (diff < minDiff) {
                                nextJieQi = name;
                                nextJieQiDate = date;
                                minDiff = diff;
                            }
                        }
                    }

                    if (nextJieQi && nextJieQiDate) {
                        if (minDiff === 0) {
                            jieQiText = `${nextJieQi}`;
                        } else {
                            jieQiText = `再${minDiff}天${nextJieQi}`;
                        }
                    }
                }

                if (lunarDateString || jieQiText) {
                    lunarAndJieQiHtml = `<div class="lunar-jieqi-combined-text">${lunarDateString} ${jieQiText}</div>`;
                }
            }

            // 更新畫面
            const dateTimeDisplay = document.getElementById('dateTimeDisplay');
            dateTimeDisplay.innerHTML = `
                <div class="time-text">
                    <span>${hoursMinutes}</span><span class="time-seconds" id="secondsDisplay">${seconds}</span>
                </div>
                ${gregorianDateHtml}
                ${lunarAndJieQiHtml}
            `;
            dateTimeDisplay.style.color = displaySettings.textColor; // 應用文字顏色
            document.body.style.backgroundColor = displaySettings.backgroundColor; // 應用背景顏色

            // 為秒數元素添加點擊事件監聽器
            document.getElementById('secondsDisplay').onclick = function() {
                document.getElementById('settingsModal').style.display = 'flex';
                // 更新設定視窗中的開關狀態以匹配當前設定
                updateSettingsModalCheckboxes();
            };
        }

        /**
         * 使時間顯示元素在螢幕上隨機移動。
         * 移動範圍受限於安全邊距，以確保元素不會移出視窗。
         */
        function moveRandomly() {
            const displayElement = document.getElementById('dateTimeDisplay'); // 獲取時間顯示元素
            const viewportWidth = window.innerWidth; // 獲取視窗寬度
            const viewportHeight = window.innerHeight; // 獲取視窗高度
            const elementRect = displayElement.getBoundingClientRect(); // 獲取元素的大小和位置
            const elementWidth = elementRect.width; // 元素寬度
            const elementHeight = elementRect.height; // 元素高度
            const safeMargin = 20; // 元素距離視窗邊緣的安全邊距
            const smallOffsetRange = 40; // 每次隨機移動的範圍

            let currentX = currentPosition.x; // 當前 X 座標
            let currentY = currentPosition.y; // 當前 Y 座標

            // 計算隨機偏移量
            const offsetX = (Math.random() * 2 - 1) * smallOffsetRange; // X 軸隨機偏移量
            const offsetY = (Math.random() * 2 - 1) * smallOffsetRange; // Y 軸隨機偏移量

            let newTargetX = currentX + offsetX; // 新的目標 X 座標
            let newTargetY = currentY + offsetY; // 新的目標 Y 座標

            // 計算允許的移動範圍，確保元素不會移出視窗
            const minAllowedX = - (viewportWidth / 2) + (elementWidth / 2) + safeMargin;
            const minAllowedY = - (viewportHeight / 2) + (elementHeight / 2) + safeMargin;
            const maxAllowedX = (viewportWidth / 2) - (elementWidth / 2) - safeMargin;
            const maxAllowedY = (viewportHeight / 2) - (elementHeight / 2) - safeMargin;

            // 將新的目標位置限制在允許的範圍內
            newTargetX = Math.max(minAllowedX, Math.min(newTargetX, maxAllowedX));
            newTargetY = Math.max(minAllowedY, Math.min(newTargetY, maxAllowedY));

            // 更新當前位置並應用 CSS 變換
            currentPosition.x = newTargetX;
            currentPosition.y = newTargetY;
            // 調整 transform 確保居中，因為內容高度可能會因顯示設定而變化
            displayElement.style.transform = `translate(calc(-50% + ${newTargetX}px), calc(-65% + ${newTargetY}px))`;
        }

        // 頁面載入後開始更新時間
        window.onload = function () {
            loadSettings(); // 載入之前儲存的設定
            updateSettingsModalCheckboxes(); // 在載入設定後立即更新設定視窗中的開關狀態
            currentPosition = { x: 0, y: 0 }; // 初始化元素位置
            setInterval(updateDateTime, 1000); // 每秒更新一次
            updateDateTime(); // 立即更新一次以避免延遲

            // 設定彈出視窗的關閉按鈕事件
            document.getElementById('closeModalBtn').onclick = function() {
                document.getElementById('settingsModal').style.display = 'none';
            };

            // 設定選項的變更事件
            document.getElementById('showGregorianYear').onchange = function(event) {
                displaySettings.showGregorianYear = event.target.checked;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };
            document.getElementById('showGregorianMonth').onchange = function(event) {
                displaySettings.showGregorianMonth = event.target.checked;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };
            document.getElementById('showGregorianDay').onchange = function(event) {
                displaySettings.showGregorianDay = event.target.checked;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };
            document.getElementById('showGregorianWeekday').onchange = function(event) {
                displaySettings.showGregorianWeekday = event.target.checked;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };
            document.getElementById('showMinguoYear').onchange = function(event) {
                displaySettings.showMinguoYear = event.target.checked;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };
            document.getElementById('showLunarMonth').onchange = function(event) {
                displaySettings.showLunarMonth = event.target.checked;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };
            document.getElementById('showLunarDay').onchange = function(event) {
                displaySettings.showLunarDay = event.target.checked;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };
            document.getElementById('showLunarShiChen').onchange = function(event) {
                displaySettings.showLunarShiChen = event.target.checked;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };
            document.getElementById('showJieqi').onchange = function(event) {
                displaySettings.showJieqi = event.target.checked;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };

            // 新增文字顏色和背景顏色設定的變更事件
            document.getElementById('textColor').onchange = function(event) {
                displaySettings.textColor = event.target.value;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };
            document.getElementById('backgroundColor').onchange = function(event) {
                displaySettings.backgroundColor = event.target.value;
                saveSettings(); // 儲存設定
                updateDateTime(); // 更新顯示
            };
        };
    </script>
</body>
</html>
