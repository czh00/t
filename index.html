<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚é–“</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100vw;
            position: relative;
            font-family: 'Inter', sans-serif;
        }

        #dateTimeDisplay {
            font-family: 'Segoe UI', Arial, sans-serif;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            position: absolute;
            transition: transform 1s ease-in-out;
            transform: translate(-50%, -50%);
            left: 50%;
            top: 50%;
        }

        .time-text {
            font-size: 32vw;
            margin-bottom: -10vw;
            position: relative;
            display: inline-block;
            white-space: nowrap;
            padding-right: 8vw;
        }

        .time-seconds {
            font-size: 6vw;
            cursor: pointer;
            position: absolute;
            right: 0;
            bottom: 6vw;
            text-align: right;
            width: 6vw;
        }

        .time-ampm {
            font-size: 5vw;
            position: absolute;
            top: 11vw;
            right: 0;
            text-align: right;
            width: 8vw;
        }

        .gregorian-date-text {
            font-size: 10vw;
            margin-top: -2vw;
            margin-bottom: -3vw;
            display: block;
            white-space: nowrap;
        }

        /* è¾²æ›†æ—¥æœŸå’Œç¯€æ°£ç¯€æ—¥å…±åŒçš„è¡Œå®¹å™¨ */
        .lunar-and-jieqi-line {
            display: flex; /* ä½¿ç”¨ Flexbox è®“å…§å®¹åœ¨åŒä¸€è¡Œ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            font-size: 6.4vw;
            white-space: nowrap; /* é˜²æ­¢æ›è¡Œ */
            width: 92vw; /* è¨­ç½®ä¸€å€‹å¯¬åº¦ï¼Œè®“å…§å®¹å¯ä»¥æº¢å‡ºé€²è¡Œè·‘é¦¬ç‡ˆ */
            margin: 0 auto;
            overflow: hidden; /* éš±è—æº¢å‡ºå…§å®¹ï¼Œç‚ºè·‘é¦¬ç‡ˆåšæº–å‚™ */
            cursor: pointer; /* è®“æ•´è¡Œå¯é»æ“Šä»¥é¡¯ç¤ºè©³ç´°è³‡è¨Š */
        }

        /* è¾²æ›†æ—¥æœŸæ¨£å¼ (éœæ…‹éƒ¨åˆ†) */
        .lunar-date-static-text {
            flex-shrink: 0; /* é˜²æ­¢è¾²æ›†æ—¥æœŸè¢«å£“ç¸® */
            text-align: right; /* ç¢ºä¿å…§å®¹é å³å°é½Š */
            /* ç§»é™¤ margin-right ä»¥æ¶ˆé™¤ç©ºæ ¼ */
        }

        /* ç¯€æ°£èˆ‡ç¯€æ—¥è·‘é¦¬ç‡ˆå®¹å™¨æ¨£å¼ */
        .jieqi-holiday-marquee-container {
            flex-grow: 1; /* è®“è·‘é¦¬ç‡ˆå®¹å™¨ä½”æ“šå‰©é¤˜ç©ºé–“ */
            overflow: hidden; /* éš±è—è¶…å‡ºéƒ¨åˆ† */
            position: relative;
            text-align: left; /* è·‘é¦¬ç‡ˆå…§å®¹å·¦å°é½Š */
            min-width: 0; /* å…è¨± flex item ç¸®å° */
            max-width: 40vw; /* ç¸®å°è·‘é¦¬ç‡ˆçš„å¯¬åº¦ */
        }

        /* è·‘é¦¬ç‡ˆå…§éƒ¨å®¹å™¨ï¼Œå¯¦éš›è¢«å‹•ç•«çš„å…ƒç´  */
        .jieqi-holiday-marquee-inner {
            display: flex; /* è®“å…§å®¹ä¸¦æ’é¡¯ç¤º */
            flex-wrap: nowrap; /* ç¢ºä¿å…§å®¹ä¸æ›è¡Œ */
            width: max-content; /* è®“å…¶å¯¬åº¦é©æ‡‰å…§å®¹ç¸½å¯¬åº¦ */
            /* animation å±¬æ€§å°‡ç”± JS å‹•æ…‹è¨­å®š */
        }

        /* è·‘é¦¬ç‡ˆå…§å®¹å’Œé‡è¤‡å…§å®¹çš„æ¨£å¼ */
        .jieqi-holiday-marquee-content,
        .jieqi-holiday-marquee-content-duplicate {
            display: inline-block; /* è®“å…§å®¹åœ¨åŒä¸€è¡Œ */
            padding-right: 0.2em; /* åŸå§‹å…§å®¹èˆ‡é‡è¤‡å…§å®¹ä¹‹é–“ç•™å‡ºé–“è· */
            white-space: nowrap;
            flex-shrink: 0; /* é˜²æ­¢å…§å®¹è¢«å£“ç¸® */
        }

        /* æ»¾å‹•æ™‚æ‡‰ç”¨çš„å‹•ç•«æ¨£å¼ */
        .jieqi-holiday-marquee-container.scrolling .jieqi-holiday-marquee-inner {
            animation-name: marquee;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        /* è·‘é¦¬ç‡ˆå‹•ç•«å®šç¾© */
        @keyframes marquee {
            from { transform: translateX(0); }
            /* æ²å‹•è·é›¢ç‚ºå–®å€‹å…§å®¹å¡Šçš„å¯¬åº¦ */
            to { transform: translateX(var(--marquee-scroll-distance)); } 
        }

        .noscript-message {
            font-size: 0.5em;
            color: #FFB3BA;
            margin-top: 10px;
        }

        .settings-modal, .jieqi-modal, .yiji-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .settings-modal.is-active, .jieqi-modal.is-active, .yiji-modal.is-active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .settings-content, .jieqi-content, .yiji-content {
            background-color: #333;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            color: #00FF00;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .setting-item {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }

        .setting-item label {
            font-size: 1.2em;
            flex-shrink: 0;
            margin-right: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: auto;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #00FF00;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #00FF00;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        .setting-item input[type="color"] {
            width: 40px;
            height: 34px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
            flex-shrink: 0;
        }

        .action-button {
            background-color: #555;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
        }

        .action-button:hover {
            background-color: #777;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            white-space: nowrap;
        }

        .calendar-settings-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
            width: 100%;
        }

        .gregorian-settings-column,
        .lunar-settings-column {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 8px;
            background-color: #444;
            text-align: left;
        }

        .gregorian-settings-column h3,
        .lunar-settings-column h3 {
            text-align: center;
            margin-top: 0;
        }

        .lunar-date-clickable,
        .lunar-shichen-clickable {
            cursor: pointer;
        }

        .yiji-content p {
            margin-bottom: 5px;
        }
        .yiji-content strong {
            color: #FFD700;
        }

        .jieqi-content p {
            margin-bottom: 5px;
        }
        .jieqi-content strong {
            color: #FFD700;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.7.0/lunar.min.js"></script>
</head>
<body>
    <div id="dateTimeDisplay"></div>

    <noscript>
            <div class="noscript-message">
                æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æˆ–å·²ç¦ç”¨ JavaScriptã€‚
            </div>
    </noscript>

    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <h2>é¡¯ç¤ºè¨­å®š</h2>
            <div class="calendar-settings-container">
                <div class="gregorian-settings-column">
                    <h3>å…¬æ›†</h3>
                    <div class="setting-item">
                        <label for="textColor">æ™‚é–“</label>
                        <label class="switch" title="åˆ‡æ›ä¸Šåˆ/ä¸‹åˆæ ¼å¼">
                            <input type="checkbox" id="showAmPm">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="textColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianYear">å¹´</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianYear">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianYearColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianMonth">æœˆ</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianMonth">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianMonthColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianDay">æ—¥</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianDay">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianDayColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianWeekday">å‘¨</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianWeekday">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianWeekdayColor" value="#00FF00">
                    </div>
                </div>

                <div class="lunar-settings-column">
                    <h3>è¾²æ›†</h3>
                    <div class="setting-item">
                        <label for="showMinguoYear">å¹´</label>
                        <label class="switch">
                            <input type="checkbox" id="showMinguoYear">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="minguoYearColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showLunarMonth">æœˆ</label>
                        <label class="switch">
                            <input type="checkbox" id="showLunarMonth">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="lunarMonthColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showLunarDay">æ—¥</label>
                        <label class="switch">
                            <input type="checkbox" id="showLunarDay">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="lunarDayColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showLunarShiChen">æ™‚</label>
                        <label class="switch">
                            <input type="checkbox" id="showLunarShiChen">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="lunarShiChenColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showJieqi">ç¯€æ°£</label>
                        <label class="switch">
                            <input type="checkbox" id="showJieqi">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="jieqiColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showHolidays">ç¯€æ—¥</label>
                        <label class="switch">
                            <input type="checkbox" id="showHolidays">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="holidayColor" value="#00FF00">
                    </div>
                </div>
            </div>

            <div class="setting-item">
                <label for="backgroundColor">èƒŒæ™¯é¡è‰²</label>
                <input type="color" id="backgroundColor" value="#000000">
            </div>

            <div class="button-group">
                <button id="restoreDefaultsBtn" class="action-button">æ¢å¾©é è¨­</button>
                <button id="randomColorsBtn" class="action-button">éš¨æ©Ÿé¡è‰²</button>
                <button id="doneBtn" class="action-button">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div id="jieqiDetailsModal" class="jieqi-modal">
        <div class="jieqi-content">
            <h2>ç¯€æ°£èˆ‡ç¯€æ—¥è³‡è¨Š</h2>
            <div id="jieqiDetailsContent" style="text-align: left;">
            </div>
            <button id="closeJieqiDetailsBtn" class="action-button">é—œé–‰</button>
        </div>
    </div>

    <div id="yijiDetailsModal" class="yiji-modal">
        <div class="yiji-content">
            <h2>å®œå¿Œè³‡è¨Š</h2>
            <div id="yijiDetailsContent" style="text-align: left;">
            </div>
            <button id="closeYijiDetailsBtn" class="action-button">é—œé–‰</button>
        </div>
    </div>

    <script>
        let lastSecondTensDigit = -1;
        let currentPosition = { x: 0, y: 0 };
        let lastMarqueeContent = ''; // ç”¨æ–¼è¿½è¹¤è·‘é¦¬ç‡ˆå…§å®¹æ˜¯å¦è®ŠåŒ–

        const defaultDisplaySettings = {
            showAmPm: true,
            showGregorianYear: true,
            showGregorianMonth: true,
            showGregorianDay: true,
            showGregorianWeekday: true,
            showMinguoYear: true,
            showLunarMonth: true,
            showLunarDay: true,
            showLunarShiChen: true,
            showJieqi: true,
            showHolidays: true,
            textColor: '#00FF00',
            backgroundColor: '#000000',
            gregorianYearColor: '#00FF00',
            gregorianMonthColor: '#00FF00',
            gregorianDayColor: '#00FF00',
            gregorianWeekdayColor: '#00FF00',
            minguoYearColor: '#00FF00',
            lunarMonthColor: '#00FF00',
            lunarDayColor: '#00FF00',
            lunarShiChenColor: '#00FF00',
            jieqiColor: '#00FF00',
            holidayColor: '#0000FF'
        };

        let displaySettings = { ...defaultDisplaySettings }; 

        // [ä¿®æ”¹] å„²å­˜è¨­å®šåˆ° localStorage
        function saveSettings() {
            try {
                const settingsJson = JSON.stringify(displaySettings);
                localStorage.setItem('displaySettings', settingsJson);
            } catch (e) {
                console.error("Failed to save settings to localStorage:", e);
            }
        }

        // [ä¿®æ”¹] å¾ localStorage è¼‰å…¥è¨­å®š
        function loadSettings() {
            try {
                const settingsJson = localStorage.getItem('displaySettings');
                if (settingsJson) {
                    const loadedSettings = JSON.parse(settingsJson);
                    displaySettings = Object.assign({ ...defaultDisplaySettings }, loadedSettings);
                }
            } catch (e) {
                console.error("Failed to parse display settings from localStorage:", e);
            }
        }

        // æ›´æ–°è¨­å®šæ¨¡æ…‹æ¡†ä¸­çš„å‹¾é¸ç‹€æ…‹å’Œé¡è‰²å€¼
        function updateSettingsModalCheckboxes() {
            document.getElementById('showAmPm').checked = displaySettings.showAmPm;
            document.getElementById('showGregorianYear').checked = displaySettings.showGregorianYear;
            document.getElementById('showGregorianMonth').checked = displaySettings.showGregorianMonth;
            document.getElementById('showGregorianDay').checked = displaySettings.showGregorianDay;
            document.getElementById('showGregorianWeekday').checked = displaySettings.showGregorianWeekday;
            document.getElementById('showMinguoYear').checked = displaySettings.showMinguoYear;
            document.getElementById('showLunarMonth').checked = displaySettings.showLunarMonth;
            document.getElementById('showLunarDay').checked = displaySettings.showLunarDay;
            document.getElementById('showLunarShiChen').checked = displaySettings.showLunarShiChen;
            document.getElementById('showJieqi').checked = displaySettings.showJieqi;
            document.getElementById('showHolidays').checked = displaySettings.showHolidays;
            document.getElementById('textColor').value = displaySettings.textColor;
            document.getElementById('backgroundColor').value = displaySettings.backgroundColor;
            document.getElementById('gregorianYearColor').value = displaySettings.gregorianYearColor;
            document.getElementById('gregorianMonthColor').value = displaySettings.gregorianMonthColor;
            document.getElementById('gregorianDayColor').value = displaySettings.gregorianDayColor;
            document.getElementById('gregorianWeekdayColor').value = displaySettings.gregorianWeekdayColor;
            document.getElementById('minguoYearColor').value = displaySettings.minguoYearColor;
            document.getElementById('lunarMonthColor').value = displaySettings.lunarMonthColor;
            document.getElementById('lunarDayColor').value = displaySettings.lunarDayColor;
            document.getElementById('lunarShiChenColor').value = displaySettings.lunarShiChenColor;
            document.getElementById('jieqiColor').value = displaySettings.jieqiColor;
            document.getElementById('holidayColor').value = displaySettings.holidayColor;
        }

        // å–å¾—ç”Ÿè‚– emoji
        function getShengXiaoEmoji(shengXiaoName) {
            const emojiMap = {
                'é¼ ': 'ğŸ­',
                'ç‰›': 'ğŸ‚',
                'è™': 'ğŸ…',
                'å…”': 'ğŸ‡',
                'é¾': 'ğŸ‰',
                'è›‡': 'ğŸ',
                'é¦¬': 'ğŸ',
                'ç¾Š': 'ğŸ‘',
                'çŒ´': 'ğŸ’',
                'é›': 'ğŸ“',
                'ç‹—': 'ğŸ•',
                'è±¬': 'ğŸ–'
            };
            return emojiMap[shengXiaoName] || shengXiaoName;
        }

        // å–å¾—ç¯€æ°£æè¿°
        function getJieqiDescription(jieqiName) {
            const descriptions = {
                'ç«‹æ˜¥': 'æ˜¥å­£é–‹å§‹ï¼Œè¬ç‰©å¾©ç”¦ï¼Œæ°£æº«å›å‡ã€‚',
                'é›¨æ°´': 'é™é›¨å¢å¤šï¼Œè‰æœ¨èŒå‹•ï¼Œæ˜¥è€•é–‹å§‹ã€‚',
                'é©šèŸ„': 'æ˜¥é›·éŸ¿å‹•ï¼Œé©šé†’å†¬çœ å‹•ç‰©ï¼Œæ°£æº«æ¼¸å‡ã€‚',
                'æ˜¥åˆ†': 'æ™å¤œç­‰é•·ï¼Œæ˜¥æ„ç›ç„¶ï¼Œå—åŒ—åŠçƒæ°£æº«è¶¨æ–¼å¹³è¡¡ã€‚',
                'æ¸…æ˜': 'æ°£å€™æ¸…çˆ½æ˜æœ—ï¼Œè¬ç‰©æ½”æ·¨ï¼Œæ˜¯æƒå¢“ç¥­ç¥–çš„æ—¥å­ã€‚',
                'ç©€é›¨': 'é›¨æ°´æ»‹æ½¤ï¼Œç©€ç‰©ç”Ÿé•·ï¼Œæ˜¯æ’­ç¨®ç§»è‹—çš„å¥½æ™‚ç¯€ã€‚',
                'ç«‹å¤': 'å¤å­£é–‹å§‹ï¼Œè¬ç‰©ç¹èŒ‚ï¼Œæ°£æº«æ˜é¡¯å‡é«˜ã€‚',
                'å°æ»¿': 'éº¥é¡ç­‰å¤ç†Ÿä½œç‰©ç±½ç²’é–‹å§‹é£½æ»¿ï¼Œä½†å°šæœªæˆç†Ÿã€‚',
                'èŠ’ç¨®': 'æœ‰èŠ’ä½œç‰©ï¼ˆå¦‚éº¥ã€ç¨»ï¼‰æˆç†Ÿï¼Œå¯ä»¥æ”¶ç©«å’Œæ’­ç¨®ã€‚',
                'å¤è‡³': 'åŒ—åŠçƒç™½æ™æœ€é•·ï¼Œé™½æ°£æœ€ç››ï¼Œæ˜¯ç››å¤çš„é–‹å§‹ã€‚',
                'å°æš‘': 'å¤©æ°£é–‹å§‹ç‚ç†±ï¼Œä½†é‚„æœªåˆ°æœ€ç†±çš„æ™‚å€™ã€‚',
                'å¤§æš‘': 'ä¸€å¹´ä¸­æœ€ç‚ç†±çš„æ™‚æœŸï¼Œæ¿•ç†±äº¤è’¸ã€‚',
                'ç«‹ç§‹': 'ç§‹å­£é–‹å§‹ï¼Œæ°£æº«é€æ¼¸ä¸‹é™ï¼Œä½†ä»æœ‰æš‘ç†±ã€‚',
                'è™•æš‘': 'æš‘æ°£æ¼¸é€€ï¼Œå¤©æ°£è½‰æ¶¼ï¼Œä½†ä»æœ‰ã€Œç§‹è€è™ã€ã€‚',
                'ç™½éœ²': 'å¤©æ°£è½‰æ¶¼ï¼Œæ°´æ°£å‡çµæˆéœ²ç ï¼Œå¤©æ°£æ¼¸å¯’ã€‚',
                'ç§‹åˆ†': 'æ™å¤œç­‰é•·ï¼Œç§‹é«˜æ°£çˆ½ï¼Œæ˜¯æ”¶ç©«çš„å­£ç¯€ã€‚',
                'å¯’éœ²': 'æ°£æº«æ›´ä½ï¼Œéœ²æ°´æ›´å¤šï¼Œå¤©æ°£è½‰å†·ã€‚',
                'éœœé™': 'å¤©æ°£æ¼¸å†·ï¼Œéœ²æ°´å‡çµæˆéœœï¼Œæ˜¯ç§‹å­£çš„æœ€å¾Œä¸€å€‹ç¯€æ°£ã€‚',
                'ç«‹å†¬': 'å†¬å­£é–‹å§‹ï¼Œè¬ç‰©æ”¶è—ï¼Œæ°£æº«é¡¯è‘—ä¸‹é™ã€‚',
                'å°é›ª': 'é–‹å§‹é™é›ªï¼Œä½†é›ªé‡ä¸å¤§ï¼Œæ°£æº«æŒçºŒèµ°ä½ã€‚',
                'å¤§é›ª': 'é™é›ªé‡å¢å¤šï¼Œå¤©æ°£æ›´å†·ï¼Œå†°å‡ç¾è±¡å¸¸è¦‹ã€‚',
                'å†¬è‡³': 'åŒ—åŠçƒç™½æ™æœ€çŸ­ï¼Œå¤œæ™šæœ€é•·ï¼Œæ˜¯æ•¸ä¹å¯’å¤©çš„é–‹å§‹ã€‚',
                'å°å¯’': 'å¤©æ°£å¯’å†·ï¼Œå°šæœªé”åˆ°æœ€å†·ã€‚',
                'å¤§å¯’': 'ä¸€å¹´ä¸­æœ€å¯’å†·çš„æ™‚æœŸï¼Œåš´å¯’å†°å‡ã€‚'
            };
            return descriptions[jieqiName] || 'æ­¤ç¯€æ°£ç„¡è©³ç´°èªªæ˜ã€‚';
        }

        // å–å¾—ç¯€æ—¥è³‡è¨Š
        function getHolidays(year) {
            const holidays = [
                { name: 'å…ƒæ—¦', date: new Date(year, 0, 1) },
                { name: 'å’Œå¹³ç´€å¿µæ—¥', date: new Date(year, 1, 28) },
                { name: 'å…’ç«¥ç¯€', date: new Date(year, 3, 4) },
                { name: 'æ¸…æ˜ç¯€', date: new Date(year, 3, 4) },
                { name: 'å‹å‹•ç¯€', date: new Date(year, 4, 1) },
                { name: 'åœ‹æ…¶æ—¥', date: new Date(year, 9, 10) },
                { name: 'è–èª•ç¯€', date: new Date(year, 11, 25) }
            ];

            // è¾²æ›†ç¯€æ—¥
            const lunarNewYear = Lunar.fromYmd(year, 1, 1).getSolar();
            holidays.push({ name: 'è¾²æ›†æ–°å¹´', date: new Date(lunarNewYear.getYear(), lunarNewYear.getMonth() - 1, lunarNewYear.getDay()) });

            const dragonBoatFestival = Lunar.fromYmd(year, 5, 5).getSolar();
            holidays.push({ name: 'ç«¯åˆç¯€', date: new Date(dragonBoatFestival.getYear(), dragonBoatFestival.getMonth() - 1, dragonBoatFestival.getDay()) });

            const ghostFestival = Lunar.fromYmd(year, 7, 15).getSolar();
            holidays.push({ name: 'ä¸­å…ƒç¯€', date: new Date(ghostFestival.getYear(), ghostFestival.getMonth() - 1, ghostFestival.getDay()) });

            const midAutumnFestival = Lunar.fromYmd(year, 8, 15).getSolar();
            holidays.push({ name: 'ä¸­ç§‹ç¯€', date: new Date(midAutumnFestival.getYear(), midAutumnFestival.getMonth() - 1, midAutumnFestival.getDay()) });

            const doubleNinthFestival = Lunar.fromYmd(year, 9, 9).getSolar();
            holidays.push({ name: 'é‡é™½ç¯€', date: new Date(doubleNinthFestival.getYear(), doubleNinthFestival.getMonth() - 1, doubleNinthFestival.getDay()) });

            const nextLunarNewYearSolar = Lunar.fromYmd(year + 1, 1, 1).getSolar();
            const chineseNewYearsEveDate = new Date(nextLunarNewYearSolar.getYear(), nextLunarNewYearSolar.getMonth() - 1, nextLunarNewYearSolar.getDay() - 1);
            holidays.push({ name: 'é™¤å¤•', date: chineseNewYearsEveDate });


            holidays.sort((a, b) => a.date.getTime() - b.date.getTime());

            return holidays;
        }

        // å–å¾—æ™‚è¾°åç¨±
        function getShiChen(h) {
            if (h >= 23 || h < 1) return 'å­';
            if (h >= 1 && h < 3) return 'ä¸‘';
            if (h >= 3 && h < 5) return 'å¯…';
            if (h >= 5 && h < 7) return 'å¯';
            if (h >= 7 && h < 9) return 'è¾°';
            if (h >= 9 && h < 11) return 'å·³';
            if (h >= 11 && h < 13) return 'åˆ';
            if (h >= 13 && h < 15) return 'æœª';
            if (h >= 15 && h < 17) return 'ç”³';
            if (h >= 17 && h < 19) return 'é…‰';
            if (h >= 19 && h < 21) return 'æˆŒ';
            if (h >= 21 && h < 23) return 'äº¥';
            return '';
        }

        // å–å¾—è©³ç´°æ™‚é–“æ®µï¼ˆå‡Œæ™¨ã€æ¸…æ™¨ç­‰ï¼‰
        function getDetailedTimePeriod(hour) {
            if (hour >= 0 && hour < 5) return 'å‡Œæ™¨';
            if (hour >= 5 && hour < 9) return 'æ¸…æ™¨';
            if (hour >= 9 && hour < 12) return 'ä¸Šåˆ';
            if (hour === 12) return 'ä¸­åˆ';
            if (hour > 12 && hour < 17) return 'ä¸‹åˆ';
            if (hour >= 17 && hour < 19) return 'å‚æ™š';
            if (hour >= 19 && hour < 23) return 'å¤œæ™š';
            if (hour === 23) return 'æ·±å¤œ';
            return '';
        }

        // ç¨ç«‹çš„è·‘é¦¬ç‡ˆæ›´æ–°é‚è¼¯
        function updateMarquee(combinedJieqiHolidayText) {
            const jieqiHolidayMarqueeContainer = document.getElementById('jieqiHolidayMarqueeContainer');
            const jieqiHolidayMarqueeInner = document.getElementById('jieqiHolidayMarqueeInner');
            const jieqiHolidayMarqueeContent = jieqiHolidayMarqueeInner ? jieqiHolidayMarqueeInner.querySelector('.jieqi-holiday-marquee-content') : null;
            const jieqiHolidayMarqueeContentDuplicate = jieqiHolidayMarqueeInner ? jieqiHolidayMarqueeInner.querySelector('.jieqi-holiday-marquee-content-duplicate') : null;

            if (!jieqiHolidayMarqueeContainer || !jieqiHolidayMarqueeInner || !jieqiHolidayMarqueeContent || !jieqiHolidayMarqueeContentDuplicate) {
                return; // å…ƒç´ ä¸å­˜åœ¨ï¼Œä¸åŸ·è¡Œ
            }

            // æ›´æ–°å…§å®¹
            jieqiHolidayMarqueeContent.innerHTML = combinedJieqiHolidayText;
            jieqiHolidayMarqueeContentDuplicate.innerHTML = combinedJieqiHolidayText;

            // åªæœ‰ç•¶ç¯€æ°£æˆ–ç¯€æ—¥é¡¯ç¤ºæ™‚æ‰è™•ç†è·‘é¦¬ç‡ˆ
            if (displaySettings.showJieqi || displaySettings.showHolidays) {
                // ä½¿ç”¨å°å»¶é²ä»¥ç¢ºä¿ DOM æ¸²æŸ“å®Œæˆï¼Œæ‰èƒ½æ­£ç¢ºè¨ˆç®—å¯¬åº¦
                setTimeout(() => {
                    // ç²å–å–®å€‹å…§å®¹å¡Šçš„å¯¦éš›å¯¬åº¦ï¼ŒåŒ…æ‹¬å…¶ padding-right
                    const singleContentWidth = jieqiHolidayMarqueeContent.scrollWidth;
                    const containerWidth = jieqiHolidayMarqueeContainer.offsetWidth;

                    // Check if content actually overflows the container
                    if (singleContentWidth > containerWidth) {
                        jieqiHolidayMarqueeContainer.classList.add('scrolling');
                        
                        // Calculate animation duration based on content width and desired speed (e.g., 50 pixels per second)
                        const speed = 50; // pixels per second
                        const animationDuration = singleContentWidth / speed; // seconds
                        
                        // è¨­å®š CSS è®Šæ•¸ï¼Œç”¨æ–¼ @keyframes ä¸­çš„æ²å‹•è·é›¢
                        // é€™è£¡çš„è·é›¢æ˜¯å–®å€‹å…§å®¹å¡Šçš„å¯¬åº¦ï¼Œä½¿å¾—å‹•ç•«å‰›å¥½æ²å‹•ä¸€å€‹å…§å®¹å¡Šçš„é•·åº¦
                        jieqiHolidayMarqueeInner.style.setProperty('--marquee-scroll-distance', `-${singleContentWidth}px`); 

                        // Apply animation duration to the inner container
                        jieqiHolidayMarqueeInner.style.animationDuration = `${animationDuration}s`;
                        
                        // ç¢ºä¿å‹•ç•«åœ¨é–‹å§‹æ™‚å°±æ‡‰ç”¨
                        jieqiHolidayMarqueeInner.style.animationPlayState = 'running';

                        jieqiHolidayMarqueeContainer.style.textAlign = 'left'; // Align content to left when scrolling
                    } else {
                        // If content doesn't overflow, remove scrolling classes and reset styles
                        jieqiHolidayMarqueeContainer.classList.remove('scrolling');
                        jieqiHolidayMarqueeContentDuplicate.innerHTML = ''; // Clear duplicate if not scrolling
                        jieqiHolidayMarqueeInner.style.animationDuration = '';
                        jieqiHolidayMarqueeContainer.style.textAlign = 'center'; // Center content when not scrolling
                        jieqiHolidayMarqueeInner.style.removeProperty('--marquee-scroll-distance'); // Remove variable
                        // Pause animation
                        jieqiHolidayMarqueeInner.style.animationPlayState = 'paused';
                    }
                }, 50); // 50 ms delay
            } else {
                // If no jieqi/holiday content to show, ensure marquee is off and content cleared
                jieqiHolidayMarqueeContainer.classList.remove('scrolling');
                jieqiHolidayMarqueeContent.innerHTML = '';
                jieqiHolidayMarqueeContentDuplicate.innerHTML = '';
                jieqiHolidayMarqueeInner.style.animationDuration = '';
                jieqiHolidayMarqueeInner.style.removeProperty('--marquee-scroll-distance'); // ç§»é™¤è®Šæ•¸
                // Pause animation
                jieqiHolidayMarqueeInner.style.animationPlayState = 'paused';
            }
        }


        // æ›´æ–°æ—¥æœŸå’Œæ™‚é–“é¡¯ç¤º
        function updateDateTime() {
            const now = new Date();
            const currentSeconds = now.getSeconds();
            const secondTensDigit = Math.floor(currentSeconds / 10);

            if (secondTensDigit !== lastSecondTensDigit) {
                moveRandomly();
                lastSecondTensDigit = secondTensDigit;
            }

            const timeOptions = {
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: displaySettings.showAmPm
            };
            
            const formatter = new Intl.DateTimeFormat('zh-Hant', timeOptions);
            const parts = formatter.formatToParts(now);

            let hoursMinutes = '';
            let seconds = '';
            let amPmText = '';

            const hourPart = parts.find(p => p.type === 'hour')?.value.padStart(2, '0') || '00';
            const minutePart = parts.find(p => p.type === 'minute')?.value || '00';
            const secondPart = parts.find(p => p.type === 'second')?.value || '00';
            
            hoursMinutes = `${hourPart}:${minutePart}`;
            seconds = secondPart;
            
            if (displaySettings.showAmPm) {
                const currentHour24 = now.getHours();
                amPmText = getDetailedTimePeriod(currentHour24);
            }


            let gregorianDateHtml = '';
            if (displaySettings.showGregorianYear || displaySettings.showGregorianMonth || displaySettings.showGregorianDay || displaySettings.showGregorianWeekday) {
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const weekday = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][now.getDay()];

                let gregorianParts = [];
                if (displaySettings.showGregorianYear) gregorianParts.push(`<span style="color: ${displaySettings.gregorianYearColor};">${year}å¹´</span>`);
                if (displaySettings.showGregorianMonth) gregorianParts.push(`<span style="color: ${displaySettings.gregorianMonthColor};">${month}æœˆ</span>`);
                if (displaySettings.showGregorianDay) gregorianParts.push(`<span style="color: ${displaySettings.gregorianDayColor};">${day}æ—¥</span>`);
                if (displaySettings.showGregorianWeekday) gregorianParts.push(`<span style="color: ${displaySettings.gregorianWeekdayColor};">å‘¨${weekday}</span>`);

                if (gregorianParts.length > 0) {
                    gregorianDateHtml = `<div class="gregorian-date-text">${gregorianParts.join('')}</div>`;
                }
            }

            let lunarDateString = '';
            let combinedJieqiHolidayText = '';
            // å°‡é€™äº›è®Šæ•¸çš„å®£å‘Šç§»åˆ°æ›´é ‚å±¤çš„ä½œç”¨åŸŸ
            let currentJieqiInfo = null; 
            let nextHolidayInfo = null; 
            let currentHolidayName = ''; 
            let tempJieqiName = '';
            let tempJieqiDate = null;
            let tempDaysUntilNextJieqi = -1; // ç¢ºä¿æœ‰åˆå§‹å€¼
            let jieQiText = '';
            let holidayCountdownText = '';

            if (typeof Lunar !== 'undefined' && typeof Solar !== 'undefined') {
                const year = now.getFullYear();
                const hour = now.getHours();
                const minguoYear = year - 1911;

                const solar = Solar.fromDate(now);
                const lunar = solar.getLunar();

                if (displaySettings.showMinguoYear || displaySettings.showLunarMonth || displaySettings.showLunarDay || displaySettings.showLunarShiChen) {
                    let lunarParts = [];
                    if (displaySettings.showMinguoYear) {
                        const shengXiaoEmoji = getShengXiaoEmoji(lunar.getYearShengXiao());
                        lunarParts.push(`<span style="color: ${displaySettings.minguoYearColor};">${minguoYear}å¹´${shengXiaoEmoji}</span>`);
                    }
                    if (displaySettings.showLunarMonth) lunarParts.push(`<span style="color: ${displaySettings.lunarMonthColor};">${lunar.getMonthInChinese().replace('é—°', 'é–')}æœˆ</span>`);
                    if (displaySettings.showLunarDay) lunarParts.push(`<span id="lunarDayDisplay" class="lunar-date-clickable" style="color: ${displaySettings.lunarDayColor};">${lunar.getDayInChinese()}</span>`);
                    if (displaySettings.showLunarShiChen) lunarParts.push(`<span id="lunarShiChenDisplay" class="lunar-shichen-clickable" style="color: ${displaySettings.lunarShiChenColor};">${getShiChen(hour)}æ™‚</span>`);
                    
                    lunarDateString = lunarParts.join('');
                }

                const solarToday = Solar.fromDate(now);
                const jieQisForYear = solarToday.getLunar().getJieQiTable();

                const allJieqis = Object.entries(jieQisForYear).map(([name, dateStr]) => {
                    return { name: name, date: new Date(dateStr) };
                }).sort((a, b) => a.date.getTime() - b.date.getTime());

                let foundTodayJieqi = false;
                for (const jq of allJieqis) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©çš„ç¯€æ°£
                    if (jq.date.getFullYear() === now.getFullYear() &&
                        jq.date.getMonth() === now.getMonth() &&
                        jq.date.getDate() === now.getDate()) {
                        tempJieqiName = jq.name;
                        tempJieqiDate = jq.date;
                        foundTodayJieqi = true;
                        tempDaysUntilNextJieqi = 0; // ç•¶å¤©ç¯€æ°£ï¼Œå¤©æ•¸ç‚º0
                        break;
                    }
                }

                if (!foundTodayJieqi) {
                    // å¦‚æœä¸æ˜¯ä»Šå¤©çš„ç¯€æ°£ï¼Œå°‹æ‰¾ä¸‹ä¸€å€‹å³å°‡åˆ°ä¾†çš„ç¯€æ°£
                    for (const jq of allJieqis) {
                        const jqDateAtEndOfDay = new Date(jq.date.getFullYear(), jq.date.getMonth(), jq.date.getDate(), 23, 59, 59, 999);
                        if (jqDateAtEndOfDay > now) { 
                            const diffTime = jqDateAtEndOfDay.getTime() - now.getTime();
                            tempDaysUntilNextJieqi = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            tempJieqiName = jq.name;
                            tempJieqiDate = jq.date;
                            break;
                        }
                    }
                }
                if (tempJieqiName && tempJieqiDate) {
                    currentJieqiInfo = { name: tempJieqiName, date: tempJieqiDate };
                }

                if (displaySettings.showJieqi) {
                    if (foundTodayJieqi) {
                        jieQiText = `${tempJieqiName}`; // ç•¶å¤©ç¯€æ°£é¡¯ç¤ºã€Œä»Šæ—¥ç¯€æ°£ã€
                    } else if (tempJieqiName && tempDaysUntilNextJieqi !== -1) {
                        jieQiText = `${tempDaysUntilNextJieqi}â¡${tempJieqiName}`;
                    }
                }

                const holidays = getHolidays(now.getFullYear());
                let foundTodayHoliday = false;
                currentHolidayName = ''; // ç¢ºä¿æ¯æ¬¡æ›´æ–°æ™‚é‡ç½®

                for (const holiday of holidays) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©çš„ç¯€æ—¥
                    if (holiday.date.getFullYear() === now.getFullYear() &&
                        holiday.date.getMonth() === now.getMonth() &&
                        holiday.date.getDate() === now.getDate()) {
                        currentHolidayName = holiday.name;
                        foundTodayHoliday = true;
                        break;
                    }
                }

                nextHolidayInfo = null; // ç¢ºä¿æ¯æ¬¡æ›´æ–°æ™‚é‡ç½®
                if (!foundTodayHoliday) { // åªæœ‰ç•¶å¤©ä¸æ˜¯ç¯€æ—¥æ‰å°‹æ‰¾ä¸‹ä¸€å€‹ç¯€æ—¥
                    const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    for (const holiday of holidays) {
                        const holidayDateAtEndOfDay = new Date(holiday.date.getFullYear(), holiday.date.getMonth(), holiday.date.getDate(), 23, 59, 59, 999);
                        if (holidayDateAtEndOfDay >= tomorrow) {
                            const diffTime = holidayDateAtEndOfDay.getTime() - now.getTime();
                            nextHolidayInfo = {
                                name: holiday.name,
                                date: holiday.date,
                                daysUntil: Math.ceil(diffTime / (1000 * 60 * 60 * 24))
                            };
                            break;
                        }
                    }
                }

                if (displaySettings.showHolidays) {
                    if (foundTodayHoliday) {
                        holidayCountdownText = `ä»Šæ—¥ç¯€æ—¥ï¼š${currentHolidayName}`; // ç•¶å¤©ç¯€æ—¥é¡¯ç¤ºã€Œä»Šæ—¥ç¯€æ—¥ã€
                    } else if (nextHolidayInfo) {
                        holidayCountdownText = `${nextHolidayInfo.daysUntil}â¡${nextHolidayInfo.name}`;
                    }
                }

                if (jieQiText && holidayCountdownText) {
                    // ç§»é™¤ç¯€æ°£å’Œç¯€æ—¥ä¹‹é–“çš„ç©ºæ ¼
                    combinedJieqiHolidayText = `<span style="color: ${displaySettings.jieqiColor};">${jieQiText}</span><span style="color: ${displaySettings.holidayColor};">${holidayCountdownText}</span>`;
                } else if (jieQiText) {
                    combinedJieqiHolidayText = `<span style="color: ${displaySettings.jieqiColor};">${jieQiText}</span>`;
                } else if (holidayCountdownText) {
                    combinedJieqiHolidayText = `<span style="color: ${displaySettings.holidayColor};">${holidayCountdownText}</span>`;
                }
            }

            // çµ„åˆæˆä¸€è¡Œçš„ HTML çµæ§‹
            // é€™è£¡ä¸å†æ¯æ¬¡éƒ½é‡æ–°å¯«å…¥æ•´å€‹ innerHTMLï¼Œè€Œæ˜¯åªæ›´æ–°éœ€è¦è®ŠåŒ–çš„éƒ¨åˆ†
            // é€™æ¨£å¯ä»¥é¿å…è·‘é¦¬ç‡ˆå…ƒç´ è¢«éŠ·æ¯€å’Œé‡å»º
            const dateTimeDisplay = document.getElementById('dateTimeDisplay');
            let currentDateTimeHtml = `
                <div class="time-text" style="color: ${displaySettings.textColor};">
                    <span>${hoursMinutes}</span>
                    <span class="time-seconds" id="secondsDisplay">${seconds}</span>
                    ${amPmText ? `<span class="time-ampm">${amPmText}</span>` : ''}
                </div>
                ${gregorianDateHtml}
                <div class="lunar-and-jieqi-line">
                    ${lunarDateString ? `<span class="lunar-date-static-text lunar-date-clickable">${lunarDateString}</span>` : ''}${(displaySettings.showJieqi || displaySettings.showHolidays) ? `<div id="jieqiHolidayMarqueeContainer" class="jieqi-holiday-marquee-container"
                            data-jieqi-name="${currentJieqiInfo ? currentJieqiInfo.name : ''}"
                            data-jieqi-date="${currentJieqiInfo ? currentJieqiInfo.date.toISOString() : ''}"
                            data-days-until-next-jieqi="${tempDaysUntilNextJieqi !== -1 ? tempDaysUntilNextJieqi : ''}"
                            data-next-holiday-name="${nextHolidayInfo ? nextHolidayInfo.name : ''}"
                            data-next-holiday-date="${nextHolidayInfo ? nextHolidayInfo.date.toISOString() : ''}"
                            data-next-holiday-days-until="${nextHolidayInfo ? nextHolidayInfo.daysUntil : ''}"
                            data-current-holiday-name="${currentHolidayName}"
                        >
                            <div id="jieqiHolidayMarqueeInner" class="jieqi-holiday-marquee-inner">
                                <span class="jieqi-holiday-marquee-content"></span>
                                <span class="jieqi-holiday-marquee-content-duplicate"></span>
                            </div>
                        </div>` : ''}
                </div>
            `;

            // åªæœ‰ç•¶æ•´å€‹çµæ§‹éœ€è¦è®ŠåŒ–æ™‚æ‰æ›´æ–° innerHTML
            // å¦å‰‡ï¼Œåªæ›´æ–°å…§éƒ¨æ–‡æœ¬å’Œè·‘é¦¬ç‡ˆ
            if (dateTimeDisplay.innerHTML === '' || !dateTimeDisplay.querySelector('#jieqiHolidayMarqueeContainer')) {
                dateTimeDisplay.innerHTML = currentDateTimeHtml;
            } else {
                // å¦‚æœçµæ§‹å·²ç¶“å­˜åœ¨ï¼Œåªæ›´æ–°è®ŠåŒ–çš„éƒ¨åˆ†
                // *** FIX: Update time color style directly ***
                const timeTextElement = dateTimeDisplay.querySelector('.time-text');
                if (timeTextElement) {
                    timeTextElement.style.color = displaySettings.textColor;
                }
                
                dateTimeDisplay.querySelector('.time-text span:first-child').textContent = hoursMinutes;
                dateTimeDisplay.querySelector('#secondsDisplay').textContent = seconds;
                const amPmSpan = dateTimeDisplay.querySelector('.time-ampm');
                if (amPmText && !amPmSpan) {
                    const newAmPmSpan = document.createElement('span');
                    newAmPmSpan.className = 'time-ampm';
                    newAmPmSpan.textContent = amPmText;
                    dateTimeDisplay.querySelector('.time-text').appendChild(newAmPmSpan);
                } else if (amPmSpan) {
                    amPmSpan.textContent = amPmText;
                }

                const gregorianDiv = dateTimeDisplay.querySelector('.gregorian-date-text');
                if (gregorianDateHtml && gregorianDiv) {
                    gregorianDiv.innerHTML = gregorianDateHtml;
                } else if (gregorianDateHtml && !gregorianDiv) {
                    const newGregorianDiv = document.createElement('div');
                    newGregorianDiv.className = 'gregorian-date-text';
                    newGregorianDiv.innerHTML = gregorianDateHtml;
                    const lunarLine = dateTimeDisplay.querySelector('.lunar-and-jieqi-line');
                    if(lunarLine) {
                        dateTimeDisplay.insertBefore(newGregorianDiv, lunarLine);
                    } else {
                        dateTimeDisplay.appendChild(newGregorianDiv);
                    }
                } else if (!gregorianDateHtml && gregorianDiv) {
                     gregorianDiv.remove();
                }


                const lunarDateStaticText = dateTimeDisplay.querySelector('.lunar-date-static-text');
                if (lunarDateString && lunarDateStaticText) {
                    lunarDateStaticText.innerHTML = lunarDateString;
                } else if (lunarDateString && !lunarDateStaticText) {
                    const newLunarSpan = document.createElement('span');
                    newLunarSpan.className = 'lunar-date-static-text lunar-date-clickable';
                    newLunarSpan.innerHTML = lunarDateString;
                    dateTimeDisplay.querySelector('.lunar-and-jieqi-line').prepend(newLunarSpan);
                } else if (!lunarDateString && lunarDateStaticText) {
                    lunarDateStaticText.remove();
                }
            }
            
            document.body.style.backgroundColor = displaySettings.backgroundColor;

            // åƒ…åœ¨è·‘é¦¬ç‡ˆå…§å®¹è®ŠåŒ–æ™‚æ‰é‡æ–°è¨­ç½®è·‘é¦¬ç‡ˆå‹•ç•«
            if (lastMarqueeContent !== combinedJieqiHolidayText) {
                updateMarquee(combinedJieqiHolidayText);
                lastMarqueeContent = combinedJieqiHolidayText;
            } else if (!displaySettings.showJieqi && !displaySettings.showHolidays) {
                // å¦‚æœç¯€æ°£å’Œç¯€æ—¥éƒ½ä¸é¡¯ç¤ºï¼Œç¢ºä¿è·‘é¦¬ç‡ˆåœæ­¢
                updateMarquee(''); // å‚³å…¥ç©ºå…§å®¹ä»¥åœæ­¢å‹•ç•«
            }
        }

        // éš¨æ©Ÿç§»å‹•é¡¯ç¤ºå…ƒç´ 
        function moveRandomly() {
            const displayElement = document.getElementById('dateTimeDisplay');
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const elementRect = displayElement.getBoundingClientRect();
            const elementWidth = elementRect.width;
            const elementHeight = elementRect.height;
            const safeMargin = 20;
            const smallOffsetRange = 40;

            let currentX = currentPosition.x;
            let currentY = currentPosition.y;

            const offsetX = (Math.random() * 2 - 1) * smallOffsetRange;
            const offsetY = (Math.random() * 2 - 1) * smallOffsetRange;

            let newTargetX = currentX + offsetX;
            let newTargetY = currentY + offsetY;

            const minAllowedX = - (viewportWidth / 2) + (elementWidth / 2) + safeMargin;
            const minAllowedY = - (viewportHeight / 2) + (elementHeight / 2) + safeMargin;
            const maxAllowedX = (viewportWidth / 2) - (elementWidth / 2) - safeMargin;
            const maxAllowedY = (viewportHeight / 2) - (elementHeight / 2) - safeMargin;

            newTargetX = Math.max(minAllowedX, Math.min(newTargetX, maxAllowedX));
            newTargetY = Math.max(minAllowedY, Math.min(newTargetY, maxAllowedY));

            currentPosition.x = newTargetX;
            currentPosition.y = newTargetY;
            displayElement.style.transform = `translate(calc(-50% + ${newTargetX}px), calc(-70% + ${newTargetY}px))`;
        }

        // æ¢å¾©é è¨­è¨­å®š
        function restoreDefaults() {
            displaySettings = { ...defaultDisplaySettings };
            saveSettings();
            updateSettingsModalCheckboxes();
            updateDateTime();
        }

        // å–å¾—éš¨æ©Ÿé¡è‰²
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // è¨­å®šéš¨æ©Ÿé¡è‰²
        function setRandomColors() {
            displaySettings.textColor = getRandomColor();
            displaySettings.backgroundColor = getRandomColor();
            displaySettings.gregorianYearColor = getRandomColor();
            displaySettings.gregorianMonthColor = getRandomColor();
            displaySettings.gregorianDayColor = getRandomColor();
            displaySettings.gregorianDayColor = getRandomColor();
            displaySettings.gregorianWeekdayColor = getRandomColor();
            displaySettings.minguoYearColor = getRandomColor();
            displaySettings.lunarMonthColor = getRandomColor();
            displaySettings.lunarDayColor = getRandomColor();
            displaySettings.lunarShiChenColor = getRandomColor();
            displaySettings.jieqiColor = getRandomColor();
            displaySettings.holidayColor = getRandomColor();

            saveSettings();
            updateSettingsModalCheckboxes();
            updateDateTime();
        }


        window.onload = function () {
            loadSettings();
            updateSettingsModalCheckboxes();
            currentPosition = { x: 0, y: 0 };
            setInterval(updateDateTime, 1000);
            updateDateTime(); // é¦–æ¬¡è¼‰å…¥æ™‚å‘¼å«ä¸€æ¬¡ä»¥åˆå§‹åŒ–é¡¯ç¤º

            // è¨­å®šæ¨¡æ…‹æ¡†æŒ‰éˆ•äº‹ä»¶
            document.getElementById('doneBtn').onclick = function() {
                document.getElementById('settingsModal').classList.remove('is-active');
            };

            document.getElementById('closeJieqiDetailsBtn').onclick = function() {
                document.getElementById('jieqiDetailsModal').classList.remove('is-active');
            };

            document.getElementById('closeYijiDetailsBtn').onclick = function() {
                document.getElementById('yijiDetailsModal').classList.remove('is-active');
            };

            // è¨­å®šåˆ‡æ›é–‹é—œäº‹ä»¶
            const toggleIds = ['showAmPm', 'showGregorianYear', 'showGregorianMonth', 'showGregorianDay', 'showGregorianWeekday', 'showMinguoYear', 'showLunarMonth', 'showLunarDay', 'showLunarShiChen', 'showJieqi', 'showHolidays'];
            toggleIds.forEach(id => {
                document.getElementById(id).onchange = function(event) {
                    displaySettings[id] = event.target.checked;
                    saveSettings();
                    // å¼·åˆ¶æ›´æ–°è·‘é¦¬ç‡ˆ
                    lastJieqiHolidayContent = '';
                    updateDateTime();
                };
            });

            // *** FIX: Use 'oninput' for immediate color updates ***
            // é¡è‰²é¸æ“‡å™¨äº‹ä»¶
            document.getElementById('textColor').oninput = function(event) {
                displaySettings.textColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('backgroundColor').oninput = function(event) {
                displaySettings.backgroundColor = event.target.value;
                saveSettings();
                updateDateTime();
            };

            document.getElementById('gregorianYearColor').oninput = function(event) {
                displaySettings.gregorianYearColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('gregorianMonthColor').oninput = function(event) {
                displaySettings.gregorianMonthColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('gregorianDayColor').oninput = function(event) {
                displaySettings.gregorianDayColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('gregorianWeekdayColor').oninput = function(event) {
                displaySettings.gregorianWeekdayColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('minguoYearColor').oninput = function(event) {
                displaySettings.minguoYearColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('lunarMonthColor').oninput = function(event) {
                displaySettings.lunarMonthColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('lunarDayColor').oninput = function(event) {
                displaySettings.lunarDayColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('lunarShiChenColor').oninput = function(event) {
                displaySettings.lunarShiChenColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('jieqiColor').oninput = function(event) {
                displaySettings.jieqiColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('holidayColor').oninput = function(event) {
                displaySettings.holidayColor = event.target.value;
                saveSettings();
                updateDateTime();
            };

            // åŠŸèƒ½æŒ‰éˆ•äº‹ä»¶
            document.getElementById('restoreDefaultsBtn').onclick = restoreDefaults;
            document.getElementById('randomColorsBtn').onclick = setRandomColors;

            // é»æ“Šé¡¯ç¤ºå€åŸŸçš„äº‹ä»¶è™•ç†
            document.getElementById('dateTimeDisplay').addEventListener('click', function(event) {
                const now = new Date();
                const solar = Solar.fromDate(now);
                const lunar = solar.getLunar();

                const secondsElement = event.target.closest('#secondsDisplay');
                // æ›´æ”¹ç‚ºæ–°çš„è·‘é¦¬ç‡ˆå®¹å™¨ ID
                const jieqiHolidayMarqueeContainerElement = event.target.closest('#jieqiHolidayMarqueeContainer'); 
                const lunarDayElement = event.target.closest('#lunarDayDisplay');
                const lunarShiChenElement = event.target.closest('#lunarShiChenDisplay');

                if (secondsElement) {
                    document.getElementById('settingsModal').classList.add('is-active');
                    updateSettingsModalCheckboxes();
                } else if (jieqiHolidayMarqueeContainerElement) { // ä½¿ç”¨æ–°çš„ ID
                    const jieqiName = jieqiHolidayMarqueeContainerElement.getAttribute('data-jieqi-name');
                    const jieqiDateStr = jieqiHolidayMarqueeContainerElement.getAttribute('data-jieqi-date');
                    const daysUntilNextJieqi = jieqiHolidayMarqueeContainerElement.getAttribute('data-days-until-next-jieqi');
                    
                    const nextHolidayName = jieqiHolidayMarqueeContainerElement.getAttribute('data-next-holiday-name');
                    const nextHolidayDateStr = jieqiHolidayMarqueeContainerElement.getAttribute('data-next-holiday-date');
                    const nextHolidayDaysUntil = jieqiHolidayMarqueeContainerElement.getAttribute('data-next-holiday-days-until');
                    const currentHolidayNameFromData = jieqiHolidayMarqueeContainerElement.getAttribute('data-current-holiday-name');

                    let detailsHtml = '';

                    // ç¯€æ°£è³‡è¨Šé¡¯ç¤º
                    if (jieqiName && jieqiDateStr) {
                        const jieqiDate = new Date(jieqiDateStr);
                        const formattedDate = `${jieqiDate.getFullYear()}å¹´${(jieqiDate.getMonth() + 1).toString().padStart(2, '0')}æœˆ${jieqiDate.getDate().toString().padStart(2, '0')}æ—¥`;
                        const description = getJieqiDescription(jieqiName);
                        
                        if (parseInt(daysUntilNextJieqi) === 0) { // å¦‚æœæ˜¯ç•¶å¤©ç¯€æ°£
                            detailsHtml += `<p>ä»Šæ—¥ <strong>${formattedDate} ${jieqiName}</strong></p>`;
                        } else { // å³å°‡åˆ°ä¾†çš„ç¯€æ°£
                            detailsHtml += `<p>${formattedDate} <strong>${jieqiName}</strong> é‚„æœ‰${daysUntilNextJieqi}å¤©</p>`;
                        }
                        detailsHtml += `<p style="margin-top: 15px;">èªªæ˜ï¼š ${description}</p>`;
                    } else {
                        detailsHtml += `<p>ç›®å‰æ²’æœ‰ç¯€æ°£è³‡è¨Šå¯é¡¯ç¤ºã€‚</p><hr style="margin: 20px 0; border-color: #555;">`;
                    }

                    // ç¯€æ—¥è³‡è¨Šé¡¯ç¤º
                    if (currentHolidayNameFromData) { // å¦‚æœæ˜¯ç•¶å¤©ç¯€æ—¥
                            detailsHtml += `<p>ä»Šæ—¥ <strong>${currentHolidayNameFromData}</strong></p>`;
                    } else if (nextHolidayName && nextHolidayDateStr && nextHolidayDaysUntil) { // å³å°‡åˆ°ä¾†çš„ç¯€æ—¥
                        const nextHolidayDate = new Date(nextHolidayDateStr);
                        const formattedHolidayDate = `${nextHolidayDate.getFullYear()}å¹´${(nextHolidayDate.getMonth() + 1).toString().padStart(2, '0')}æœˆ${nextHolidayDate.getDate().toString().padStart(2, '0')}æ—¥`;
                            detailsHtml += `<p>${formattedHolidayDate} <strong>${nextHolidayName}</strong> é‚„æœ‰${nextHolidayDaysUntil}å¤©</p>`;
                    } else {
                        detailsHtml += `<p>ç›®å‰æ²’æœ‰å³å°‡åˆ°ä¾†çš„ç¯€æ—¥è³‡è¨Šã€‚</p>`;
                    }

                    document.getElementById('jieqiDetailsContent').innerHTML = detailsHtml;
                    document.getElementById('jieqiDetailsModal').classList.add('is-active');
                } else if (lunarDayElement) {
                    const yiList = lunar.getDayYi() || [];
                    const jiList = lunar.getDayJi() || [];

                    let yijiHtml = `
                        <p><strong>è¾²æ›†æ—¥æœŸï¼š</strong> ${lunar.getMonthInChinese().replace('é—°', 'é–')}æœˆ${lunar.getDayInChinese()}</p>
                        <p style="margin-top: 15px;"><strong>å®œï¼š</strong> ${yiList.join('ã€')}</p>
                        <p style="margin-top: 15px;"><strong>å¿Œï¼š</strong> ${jiList.join('ã€')}</p>
                        <p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
                            æ¯æ—¥å®œå¿Œåƒ…ä¾›åƒè€ƒï¼Œè«‹å‹¿éåº¦è¿·ä¿¡ã€‚
                        </p>
                    `;
                    document.getElementById('yijiDetailsContent').innerHTML = yijiHtml;
                    document.getElementById('yijiDetailsModal').classList.add('is-active');
                } else if (lunarShiChenElement) {
                    const currentHour = now.getHours();
                    const shiChenName = getShiChen(currentHour);

                    const hourYiList = lunar.getTimeYi() || ['ç„¡'];
                    const hourJiList = lunar.getTimeJi() || ['ç„¡'];

                    let yijiHtml = `
                        <p><strong>æ™‚è¾°ï¼š</strong> ${shiChenName}æ™‚</p>
                        <p style="margin-top: 15px;"><strong>å®œï¼š</strong> ${hourYiList.join('ã€')}</p>
                        <p style="margin-top: 15px;"><strong>å¿Œï¼š</strong> ${hourJiList.join('ã€')}</p>
                        <p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
                            æ™‚è¾°å®œå¿Œåƒ…ä¾›åƒè€ƒï¼Œè«‹å‹¿éåº¦è¿·ä¿¡ã€‚
                        </p>
                    `;
                    document.getElementById('yijiDetailsContent').innerHTML = yijiHtml;
                    document.getElementById('yijiDetailsModal').classList.add('is-active');
                }
            });
        };
    </script>
</body>
</html>
