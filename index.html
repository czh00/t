<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時間</title>
    <style>
        /* 全局樣式：設定所有元素的盒模型為 border-box */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* body 樣式：設定頁面為全屏顯示，內容居中，背景為黑色 */
        body {
            margin: 0;
            overflow: hidden; /* 隱藏超出視窗的內容 */
            display: flex; /* 使用 Flexbox 佈局 */
            flex-direction: column; /* 垂直排列子元素 */
            justify-content: center; /* 垂直居中對齊 */
            align-items: center; /* 水平居中對齊 */
            min-height: 100vh; /* 最小高度為視窗高度 */
            width: 100vw; /* 寬度為視窗寬度 */
            position: relative; /* 相對定位 */
            font-family: 'Inter', sans-serif; /* 使用 Inter 字體 */
        }

        /* dateTimeDisplay 樣式：時間顯示容器的樣式，包括字體、顏色、陰影和定位 */
        #dateTimeDisplay {
            font-family: 'Segoe UI', Arial, sans-serif; /* 字體設定 */
            font-weight: bold; /* 字體加粗 */
            text-align: center; /* 文字居中對齊 */
            padding: 10px; /* 內邊距 */
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5); /* 文字陰影 */
            position: absolute; /* 絕對定位 */
            transition: transform 1s ease-in-out; /* 變換過渡效果 */
            transform: translate(-50%, -50%); /* 居中定位 */
            left: 50%; /* 左邊距 50% */
            top: 50%; /* 上邊距 50% */
        }

        /* time-text 樣式：顯示時分的主時間文字樣式 */
        .time-text {
            font-size: 32vw; /* 字體大小根據視窗寬度調整 */
            margin-bottom: -10vw; /* 底部外邊距 */
            position: relative; /* 相對定位，為秒數和AM/PM提供定位上下文 */
            display: inline-block; /* 行內塊級元素 */
            white-space: nowrap; /* 不換行 */
            padding-right: 8vw; /* 為秒數和AM/PM騰出空間 */
        }

        /* time-seconds 樣式：顯示秒數的文字樣式 */
        .time-seconds {
            font-size: 6vw; /* 字體大小根據視窗寬度調整 */
            cursor: pointer; /* 鼠標懸停時顯示手型 */
            position: absolute; /* 絕對定位 */
            top: 12vw; /* 調整垂直位置 */
            right: ; /* 對齊到 time-text 的右邊緣 */
            text-align: right; /* 確保文字靠右對齊 */
            width: 6vw; /* 給定寬度以對齊 */
        }

        /* time-ampm 樣式：顯示上午/下午的文字樣式 */
        .time-ampm {
            font-size: 5vw; /* 字體大小與秒數相同 */
            position: absolute; /* 絕對定位 */
            bottom: 10vw; /* 調整垂直位置 */
            right: 0; /* 對齊到 time-text 的右邊緣 */
            text-align: right; /* 確保文字靠右對齊 */
            width: 8vw; /* 給定寬度以對齊 */
        }

        /* gregorian-date-text 樣式：顯示公曆日期的文字樣式 */
        .gregorian-date-text {
            font-size: 10vw; /* 字體大小根據視窗寬度調整 */
            margin-top: -2vw; /* 新增：對公曆日期元素設定負上外邊距 */
            margin-bottom: -3vw; /* 底部外邊距 */
            display: block; /* 塊級元素 */
            white-space: nowrap; /* 不換行 */
        }

        /* lunar-jieqi-combined-text 樣式：顯示農曆和節氣的文字樣式 */
        .lunar-jieqi-combined-text {
            font-size: 6.4vw; /* 字體大小根據視窗寬度調整 */
            display: block; /* 塊級元素 */
            white-space: nowrap; /* 不換行 */
        }

        /* noscript-message 樣式：當 JavaScript 被禁用時顯示的提示訊息樣式 */
        .noscript-message {
            font-size: 0.5em; /* 字體大小 */
            color: #FFB3BA; /* 淺紅色 */
            margin-top: 10px; /* 頂部外邊距 */
        }

        /* 設定彈出視窗的樣式 - 預設隱藏 */
        .settings-modal, .jieqi-modal, .yiji-modal {
            display: none; /* 預設隱藏 */
            position: fixed; /* 固定定位 */
            z-index: 100; /* 確保在最上層 */
            left: 0;
            top: 0;
            width: 100%; /* 全寬 */
            height: 100%; /* 全高 */
            overflow: auto; /* 允許滾動 */
            background-color: rgba(0, 0, 0, 0.7); /* 半透明黑色背景 */
        }

        /* 彈出視窗顯示時的樣式 */
        .settings-modal.is-active, .jieqi-modal.is-active, .yiji-modal.is-active {
            display: flex; /* 僅在 .is-active 時顯示為 flex */
            justify-content: center;
            align-items: center;
        }

        /* 設定彈出視窗內容的樣式 */
        .settings-content, .jieqi-content, .yiji-content {
            background-color: #333; /* 深灰色背景 */
            margin: auto; /* 自動外邊距，用於居中 */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* 寬度佔 90% */
            max-width: 600px; /* 最大寬度 */
            border-radius: 10px; /* 圓角 */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); /* 陰影 */
            color: #00FF00; /* 文字顏色 */
            text-align: center; /* 文字居中 */
            display: flex; /* 使用 Flexbox 進行整體內容佈局 */
            flex-direction: column; /* 垂直堆疊其子元素 */
            gap: 15px; /* 子元素之間的間距 */
            max-height: 90vh; /* 限制最大高度為視窗的 90% */
            overflow-y: auto; /* 如果內容超出高度，則允許垂直滾動 */
        }

        /* 設定項目樣式 */
        .setting-item {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between; /* 將內容分開對齊 */
            align-items: center;
            flex-wrap: nowrap; /* 防止單個設定項目內容換行 */
        }

        .setting-item label {
            font-size: 1.2em;
            flex-shrink: 0; /* 防止標籤縮小 */
            margin-right: 10px; /* 標籤與開關之間的間距 */
        }

        /* 開關按鈕樣式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: auto; /* 將開關推到右邊 */
            margin-right: 10px; /* 在開關和顏色選擇器之間增加間距 */
            flex-shrink: 0; /* 防止開關縮小 */
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #00FF00;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #00FF00;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* 顏色選擇器樣式 */
        .setting-item input[type="color"] {
            width: 40px; /* 調整顏色選擇器寬度 */
            height: 34px; /* 調整顏色選擇器高度 */
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
            flex-shrink: 0; /* 防止顏色選擇器縮小 */
        }

        /* 恢復預設和隨機按鈕樣式 */
        .action-button {
            background-color: #555;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
        }

        .action-button:hover {
            background-color: #777;
        }

        /* 按鈕群組樣式，用於排列「恢復預設」、「隨機」和「完成」按鈕 */
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px; /* 按鈕之間的間距 */
            margin-top: 20px;
            white-space: nowrap; /* 不換行 */
        }

        /* 新增：日曆設定容器，用於並排顯示公曆和農曆設定 */
        .calendar-settings-container {
            display: flex;
            flex-wrap: wrap; /* 允許在小螢幕上換行 */
            gap: 20px; /* 列之間的間距 */
            justify-content: space-around; /* 分散空間 */
            width: 100%; /* 佔用可用寬度 */
        }

        /* 新增：公曆和農曆設定的列樣式 */
        .gregorian-settings-column,
        .lunar-settings-column {
            flex: 1; /* 每列佔用相等空間 */
            min-width: 80px; /* 每列的最小寬度，防止在小螢幕上過度壓縮 */
            padding: 10px;
            border: 1px solid #555; /* 可選：為視覺分離添加邊框 */
            border-radius: 8px;
            background-color: #444; /* 列的背景顏色 */
            text-align: left; /* 將列內的文字左對齊 */
        }

        .gregorian-settings-column h3,
        .lunar-settings-column h3 {
            text-align: center; /* 列標題居中 */
            margin-top: 0;
        }

        /* 節氣文字可點擊樣式 */
        .jieqi-clickable {
            cursor: pointer;
        }

        /* 農曆日期文字可點擊樣式 */
        .lunar-date-clickable {
            cursor: pointer;
        }

        /* 時辰文字可點擊樣式 */
        .lunar-shichen-clickable {
            cursor: pointer;
        }

        /* 宜忌彈窗內容特定樣式 */
        .yiji-content p {
            margin-bottom: 5px;
        }
        .yiji-content strong {
            color: #FFD700; /* 金色，讓宜忌標題更顯眼 */
        }

        /* 節氣/節日彈窗內容特定樣式 */
        .jieqi-content p {
            margin-bottom: 5px;
        }
        .jieqi-content strong {
            color: #FFD700; /* 金色，讓標題更顯眼 */
        }
    </style>
    <!-- 加入對外部 lunar-javascript 函式庫的引用，用於農曆和節氣計算 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.7.0/lunar.min.js"></script>
</head>
<body>
    <!-- 時間、日期、農曆和節氣的顯示容器 -->
    <div id="dateTimeDisplay"></div>

    <!-- 如果瀏覽器不支援 JavaScript，顯示此訊息 -->
    <noscript>
            <div class="noscript-message">
                您的瀏覽器不支援或已禁用 JavaScript。
            </div>
    </noscript>

    <!-- 設定彈出視窗 -->
    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <h2>顯示設定</h2>
            <div class="calendar-settings-container"> <!-- 新增：用於並排顯示公曆和農曆設定的容器 -->
                <div class="gregorian-settings-column"> <!-- 公曆設定列 -->
                    <h3>公曆</h3>
                    <div class="setting-item">
                        <label for="textColor">時間</label>
                        <label class="switch" title="切換上午/下午格式">
                            <input type="checkbox" id="showAmPm">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="textColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianYear">年</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianYear">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianYearColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianMonth">月</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianMonth">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianMonthColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianDay">日</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianDay">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianDayColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showGregorianWeekday">周</label>
                        <label class="switch">
                            <input type="checkbox" id="showGregorianWeekday">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="gregorianWeekdayColor" value="#00FF00">
                    </div>
                </div>

                <div class="lunar-settings-column"> <!-- 農曆設定列 -->
                    <h3>農曆</h3>
                    <div class="setting-item">
                        <label for="showMinguoYear">年</label>
                        <label class="switch">
                            <input type="checkbox" id="showMinguoYear">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="minguoYearColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showLunarMonth">月</label>
                        <label class="switch">
                            <input type="checkbox" id="showLunarMonth">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="lunarMonthColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showLunarDay">日</label>
                        <label class="switch">
                            <input type="checkbox" id="showLunarDay">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="lunarDayColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showLunarShiChen">時</label>
                        <label class="switch">
                            <input type="checkbox" id="showLunarShiChen">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="lunarShiChenColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showJieqi">節氣</label>
                        <label class="switch">
                            <input type="checkbox" id="showJieqi">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="jieqiColor" value="#00FF00">
                    </div>
                    <div class="setting-item">
                        <label for="showHolidays">節日</label>
                        <label class="switch">
                            <input type="checkbox" id="showHolidays">
                            <span class="slider"></span>
                        </label>
                        <input type="color" id="holidayColor" value="#00FF00">
                    </div>
                </div>
            </div>

            <div class="setting-item">
                <label for="backgroundColor">背景顏色</label>
                <input type="color" id="backgroundColor" value="#000000">
            </div>

            <div class="button-group">
                <button id="restoreDefaultsBtn" class="action-button">恢復預設</button>
                <button id="randomColorsBtn" class="action-button">隨機顏色</button>
                <button id="doneBtn" class="action-button">完成</button>
            </div>
        </div>
    </div>

    <!-- 節氣詳細資料彈出視窗 -->
    <div id="jieqiDetailsModal" class="jieqi-modal">
        <div class="jieqi-content">
            <h2>節氣與節日資訊</h2>
            <div id="jieqiDetailsContent" style="text-align: left;">
                <!-- 節氣和節日詳細資料將在此處動態載入 -->
            </div>
            <button id="closeJieqiDetailsBtn" class="action-button">關閉</button>
        </div>
    </div>

    <!-- 每日宜忌彈出視窗 -->
    <div id="yijiDetailsModal" class="yiji-modal">
        <div class="yiji-content">
            <h2>宜忌資訊</h2> <!-- 標題已從「每日宜忌」修改為「宜忌資訊」 -->
            <div id="yijiDetailsContent" style="text-align: left;">
                <!-- 宜忌詳細資料將在此處動態載入 -->
            </div>
            <button id="closeYijiDetailsBtn" class="action-button">關閉</button>
        </div>
    </div>

    <script>
        let lastSecondTensDigit = -1; // 用於追蹤秒數的十位數，以觸發每十秒的隨機移動
        let currentPosition = { x: 0, y: 0 }; // 追蹤時間顯示元素的當前位置

        // 預設顯示設定的初始值
        const defaultDisplaySettings = {
            showAmPm: false, // 新增：上午/下午 (AM/PM) 顯示設定
            showGregorianYear: true,
            showGregorianMonth: true,
            showGregorianDay: true,
            showGregorianWeekday: true,
            showMinguoYear: true,
            showLunarMonth: true,
            showLunarDay: true,
            showLunarShiChen: true,
            showJieqi: true, // 預設節氣開啟
            showHolidays: false, // 預設節日關閉
            textColor: '#00FF00', // 主時間文字顏色設定
            backgroundColor: '#000000', // 背景顏色設定
            // 個別顯示項目的預設顏色設定
            gregorianYearColor: '#00FF00',
            gregorianMonthColor: '#00FF00',
            gregorianDayColor: '#00FF00',
            gregorianWeekdayColor: '#00FF00',
            minguoYearColor: '#00FF00',
            lunarMonthColor: '#00FF00',
            lunarDayColor: '#00FF00',
            lunarShiChenColor: '#00FF00',
            jieqiColor: '#00FF00',
            holidayColor: '#00FF00' // 節日文字顏色設定
        };

        // displaySettings 儲存當前應用於顯示的設定。
        // 使用展開運算符 (...) 複製 defaultDisplaySettings，確保 displaySettings 獨立於預設值，
        // 允許用戶修改並儲存這些設定而不會影響原始預設值。
        let displaySettings = { ...defaultDisplaySettings }; 

        /**
         * 將顯示設定儲存到 Cookie 中。
         * 將 displaySettings 物件轉換為 JSON 字串並儲存到名為 'displaySettings' 的 Cookie 中。
         * Cookie 有效期設定為 365 天，並在整個網站路徑下可用。
         */
        function saveSettings() {
            const settingsJson = JSON.stringify(displaySettings);
            document.cookie = `displaySettings=${settingsJson}; expires=${new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toUTCString()}; path=/`;
        }

        /**
         * 從 Cookie 中載入顯示設定。
         * 讀取 'displaySettings' Cookie，解析 JSON 字串，並更新 displaySettings 物件。
         * 如果 Cookie 不存在或解析失敗，將保留當前的 displaySettings（預設值或之前載入的值）。
         * 這種遍歷確保了即使在 Cookie 中缺少某些設定時，新的預設值也能被應用。
         */
        function loadSettings() {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith('displaySettings=')) {
                    try {
                        const settingsJson = cookie.substring('displaySettings='.length);
                        const loadedSettings = JSON.parse(settingsJson);
                        // 使用 Object.assign 來合併載入的設定和預設設定，確保新增加的設定項能被正確初始化
                        displaySettings = Object.assign({ ...defaultDisplaySettings }, loadedSettings);
                    } catch (e) {
                        console.error("Failed to parse display settings from cookie:", e);
                    }
                    return; // 找到並處理完 cookie 後就返回
                }
            }
        }

        /**
         * 更新設定彈出視窗中的所有 UI 元素（開關和顏色選擇器）以匹配當前 displaySettings。
         */
        function updateSettingsModalCheckboxes() {
            document.getElementById('showAmPm').checked = displaySettings.showAmPm;
            document.getElementById('showGregorianYear').checked = displaySettings.showGregorianYear;
            document.getElementById('showGregorianMonth').checked = displaySettings.showGregorianMonth;
            document.getElementById('showGregorianDay').checked = displaySettings.showGregorianDay;
            document.getElementById('showGregorianWeekday').checked = displaySettings.showGregorianWeekday;
            document.getElementById('showMinguoYear').checked = displaySettings.showMinguoYear;
            document.getElementById('showLunarMonth').checked = displaySettings.showLunarMonth;
            document.getElementById('showLunarDay').checked = displaySettings.showLunarDay;
            document.getElementById('showLunarShiChen').checked = displaySettings.showLunarShiChen;
            document.getElementById('showJieqi').checked = displaySettings.showJieqi;
            document.getElementById('showHolidays').checked = displaySettings.showHolidays; // 新增

            document.getElementById('textColor').value = displaySettings.textColor;
            document.getElementById('backgroundColor').value = displaySettings.backgroundColor;

            document.getElementById('gregorianYearColor').value = displaySettings.gregorianYearColor;
            document.getElementById('gregorianMonthColor').value = displaySettings.gregorianMonthColor;
            document.getElementById('gregorianDayColor').value = displaySettings.gregorianDayColor;
            document.getElementById('gregorianWeekdayColor').value = displaySettings.gregorianWeekdayColor;
            document.getElementById('minguoYearColor').value = displaySettings.minguoYearColor;
            document.getElementById('lunarMonthColor').value = displaySettings.lunarMonthColor;
            document.getElementById('lunarDayColor').value = displaySettings.lunarDayColor;
            document.getElementById('lunarShiChenColor').value = displaySettings.lunarShiChenColor;
            document.getElementById('jieqiColor').value = displaySettings.jieqiColor;
            document.getElementById('holidayColor').value = displaySettings.holidayColor; // 新增
        }

        /**
         * 將生肖名稱轉換為對應的 emoji。
         * @param {string} shengXiaoName - 生肖的中文名稱。
         * @returns {string} 對應的生肖 emoji。
         */
        function getShengXiaoEmoji(shengXiaoName) {
            const emojiMap = {
                '鼠': '🐭',
                '牛': '�',
                '虎': '🐅',
                '兔': '🐇',
                '龍': '🐉',
                '蛇': '🐍',
                '馬': '🐎',
                '羊': '🐑',
                '猴': '🐒',
                '雞': '🐓',
                '狗': '🐕',
                '豬': '🐖'
            };
            return emojiMap[shengXiaoName] || shengXiaoName; // 如果找不到對應的 emoji，則返回原始名稱
        }

        /**
         * 獲取節氣的詳細說明。
         * @param {string} jieqiName - 節氣的名稱。
         * @returns {string} 節氣的詳細說明。
         */
        function getJieqiDescription(jieqiName) {
            const descriptions = {
                '立春': '春季開始，萬物復甦，氣溫回升。',
                '雨水': '降雨增多，草木萌動，春耕開始。',
                '驚蟄': '春雷響動，驚醒冬眠動物，氣溫漸升。',
                '春分': '晝夜等長，春意盎然，南北半球氣溫趨於平衡。',
                '清明': '氣候清爽明朗，萬物潔淨，是掃墓祭祖的日子。',
                '穀雨': '雨水滋潤，穀物生長，是播種移苗的好時節。',
                '立夏': '夏季開始，萬物繁茂，氣溫明顯升高。',
                '小滿': '麥類等夏熟作物籽粒開始飽滿，但尚未成熟。',
                '芒種': '有芒作物（如麥、稻）成熟，可以收穫和播種。',
                '夏至': '北半球白晝最長，陽氣最盛，是盛夏的開始。',
                '小暑': '天氣開始炎熱，但還未到最熱的時候。',
                '大暑': '一年中最炎熱的時期，濕熱交蒸。',
                '立秋': '秋季開始，氣溫逐漸下降，但仍有暑熱。',
                '處暑': '暑氣漸退，天氣轉涼，但仍有「秋老虎」。',
                '白露': '天氣轉涼，水氣凝結成露珠，天氣漸寒。',
                '秋分': '晝夜等長，秋高氣爽，是收穫的季節。',
                '寒露': '氣溫更低，露水更多，天氣轉冷。',
                '霜降': '天氣漸冷，露水凝結成霜，是秋季的最後一個節氣。',
                '立冬': '冬季開始，萬物收藏，氣溫顯著下降。',
                '小雪': '開始降雪，但雪量不大，氣溫持續走低。',
                '大雪': '降雪量增多，天氣更冷，冰凍現象常見。',
                '冬至': '北半球白晝最短，夜晚最長，是數九寒天的開始。',
                '小寒': '天氣寒冷，尚未達到最冷。',
                '大寒': '一年中最寒冷的時期，嚴寒冰凍。'
            };
            return descriptions[jieqiName] || '此節氣無詳細說明。';
        }

        /**
         * 獲取指定年份的節日列表。
         * 包括公曆節日和農曆節日（轉換為公曆日期）。
         * @param {number} year - 要獲取節日的年份。
         * @returns {Array<Object>} 節日列表，每個物件包含 { name: string, date: Date }。
         */
        function getHolidays(year) {
            const holidays = [
                { name: '元旦', date: new Date(year, 0, 1) }, // Jan 1
                { name: '和平', date: new Date(year, 1, 28) }, // Feb 28
                { name: '兒童', date: new Date(year, 3, 4) }, // Apr 4
                // 清明節通常在 4/4 或 4/5，這裡暫時寫死 4/4，實際應與節氣計算同步
                { name: '清明', date: new Date(year, 3, 4) }, // Apr 4
                { name: '勞動', date: new Date(year, 4, 1) }, // May 1
                { name: '國慶', date: new Date(year, 9, 10) }, // Oct 10
                { name: '聖誕', date: new Date(year, 11, 25) } // Dec 25
            ];

            // 農曆新年 (根據 Lunar 庫獲取)
            const lunarNewYear = Lunar.fromYmd(year, 1, 1).getSolar();
            holidays.push({ name: '過年', date: new Date(lunarNewYear.getYear(), lunarNewYear.getMonth() - 1, lunarNewYear.getDay()) });

            // 端午節 (農曆五月初五)
            const dragonBoatFestival = Lunar.fromYmd(year, 5, 5).getSolar();
            holidays.push({ name: '端午', date: new Date(dragonBoatFestival.getYear(), dragonBoatFestival.getMonth() - 1, dragonBoatFestival.getDay()) });

            // 中元節 (農曆七月十五)
            const ghostFestival = Lunar.fromYmd(year, 7, 15).getSolar();
            holidays.push({ name: '中元', date: new Date(ghostFestival.getYear(), ghostFestival.getMonth() - 1, ghostFestival.getDay()) });

            // 中秋節 (農曆八月十五)
            const midAutumnFestival = Lunar.fromYmd(year, 8, 15).getSolar();
            holidays.push({ name: '中秋', date: new Date(midAutumnFestival.getYear(), midAutumnFestival.getMonth() - 1, midAutumnFestival.getDay()) });

            // 重陽節 (農曆九月初九)
            const doubleNinthFestival = Lunar.fromYmd(year, 9, 9).getSolar();
            holidays.push({ name: '重陽', date: new Date(doubleNinthFestival.getYear(), doubleNinthFestival.getMonth() - 1, doubleNinthFestival.getDay()) });

            // 除夕 (農曆十二月最後一天)
            // 獲取下一個農曆年的第一天，然後回溯一天得到當年的除夕
            const nextLunarNewYearSolar = Lunar.fromYmd(year + 1, 1, 1).getSolar();
            const chineseNewYearsEveDate = new Date(nextLunarNewYearSolar.getYear(), nextLunarNewYearSolar.getMonth() - 1, nextLunarNewYearSolar.getDay() - 1);
            holidays.push({ name: '除夕', date: chineseNewYearsEveDate });


            // 排序節日，確保按日期升序排列
            holidays.sort((a, b) => a.date.getTime() - b.date.getTime());

            return holidays;
        }


        /**
         * 根據小時獲取時辰。
         * @param {number} h - 當前小時 (0-23)。
         * @returns {string} 對應的時辰字串。
         */
        function getShiChen(h) {
            if (h >= 23 || h < 1) return '子';
            if (h >= 1 && h < 3) return '丑';
            if (h >= 3 && h < 5) return '寅';
            if (h >= 5 && h < 7) return '卯';
            if (h >= 7 && h < 9) return '辰';
            if (h >= 9 && h < 11) return '巳';
            if (h >= 11 && h < 13) return '午';
            if (h >= 13 && h < 15) return '未';
            if (h >= 15 && h < 17) return '申';
            if (h >= 17 && h < 19) return '酉';
            if (h >= 19 && h < 21) return '戌';
            if (h >= 21 && h < 23) return '亥';
            return '';
        }

        /**
         * 根據小時獲取更詳細的時間段名稱。
         * @param {number} hour - 當前小時 (0-23)。
         * @returns {string} 詳細的時間段名稱。
         */
        function getDetailedTimePeriod(hour) {
            if (hour >= 0 && hour < 5) return '凌晨';
            if (hour >= 5 && hour < 9) return '清晨';
            if (hour >= 9 && hour < 12) return '上午';
            if (hour === 12) return '中午';
            if (hour > 12 && hour < 17) return '下午';
            if (hour >= 17 && hour < 19) return '傍晚';
            if (hour >= 19 && hour < 23) return '夜晚';
            if (hour === 23) return '深夜';
            return '';
        }

        /**
         * 更新時間、日期、農曆和節氣的顯示。
         * 每秒呼叫一次，並在每十秒觸發一次隨機移動效果。
         * 根據 displaySettings 中的值動態生成 HTML 並應用顏色。
         */
        function updateDateTime() {
            const now = new Date(); // 獲取當前日期和時間
            const currentSeconds = now.getSeconds(); // 獲取當前秒數
            const secondTensDigit = Math.floor(currentSeconds / 10); // 計算秒數的十位數

            // 每十秒隨機移動一次
            if (secondTensDigit !== lastSecondTensDigit) {
                moveRandomly(); // 呼叫隨機移動函數
                lastSecondTensDigit = secondTensDigit; // 更新秒數的十位數
            }

            // 格式化時間
            const timeOptions = {
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true // 始終使用 12 小時制來獲取小時和 AM/PM，以便後續判斷詳細時間段
            };
            
            const formatter = new Intl.DateTimeFormat('zh-Hant', timeOptions);
            const parts = formatter.formatToParts(now);

            let hoursMinutes = '';
            let seconds = '';
            let amPmText = ''; // 用於儲存上午/下午/詳細時間段文字

            const hourPart = parts.find(p => p.type === 'hour')?.value.padStart(2, '0') || '00';
            const minutePart = parts.find(p => p.type === 'minute')?.value || '00';
            const secondPart = parts.find(p => p.type === 'second')?.value || '00';
            
            hoursMinutes = `${hourPart}:${minutePart}`;
            seconds = secondPart;
            
            // 根據設定決定顯示上午/下午或更詳細的時間段
            if (displaySettings.showAmPm) {
                const currentHour24 = now.getHours(); // 獲取 24 小時制的小時
                amPmText = getDetailedTimePeriod(currentHour24);
            }


            // 公曆日期邏輯
            let gregorianDateHtml = '';
            if (displaySettings.showGregorianYear || displaySettings.showGregorianMonth || displaySettings.showGregorianDay || displaySettings.showGregorianWeekday) {
                const year = now.getFullYear();
                // 將月份和日期補足兩位數
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const weekday = ['日', '一', '二', '三', '四', '五', '六'][now.getDay()];

                let gregorianParts = [];
                if (displaySettings.showGregorianYear) gregorianParts.push(`<span style="color: ${displaySettings.gregorianYearColor};">${year}年</span>`);
                if (displaySettings.showGregorianMonth) gregorianParts.push(`<span style="color: ${displaySettings.gregorianMonthColor};">${month}月</span>`);
                if (displaySettings.showGregorianDay) gregorianParts.push(`<span style="color: ${displaySettings.gregorianDayColor};">${day}日</span>`);
                if (displaySettings.showGregorianWeekday) gregorianParts.push(`<span style="color: ${displaySettings.gregorianWeekdayColor};">周${weekday}</span>`);

                if (gregorianParts.length > 0) {
                    gregorianDateHtml = `<div class="gregorian-date-text">${gregorianParts.join('')}</div>`;
                }
            }

            // 農曆和節氣邏輯 (僅在 lunar-javascript 函式庫載入成功時執行)
            let lunarAndJieQiHtml = '';
            let currentJieqiInfo = null; // 用於儲存當前或下一個節氣的完整資訊
            let nextHolidayInfo = null; // 用於儲存下一個即將到來的節日資訊 (for modal)
            let currentHolidayName = ''; // 用於儲存當天的節日名稱 (for modal)

            if ((displaySettings.showMinguoYear || displaySettings.showLunarMonth || displaySettings.showLunarDay || displaySettings.showLunarShiChen || displaySettings.showJieqi || displaySettings.showHolidays) && typeof Lunar !== 'undefined' && typeof Solar !== 'undefined') {
                const year = now.getFullYear();
                const hour = now.getHours();
                const minguoYear = year - 1911;

                const solar = Solar.fromDate(now); // 使用 Solar.fromDate(now) 獲取當前日期的陽曆物件
                const lunar = solar.getLunar(); // 根據陽曆物件獲取農曆物件

                let lunarParts = [];
                if (displaySettings.showMinguoYear) {
                    const shengXiaoEmoji = getShengXiaoEmoji(lunar.getYearShengXiao());
                    lunarParts.push(`<span style="color: ${displaySettings.minguoYearColor};">${minguoYear}年${shengXiaoEmoji}</span>`);
                }
                if (displaySettings.showLunarMonth) lunarParts.push(`<span style="color: ${displaySettings.lunarMonthColor};">${lunar.getMonthInChinese().replace('闰', '閏')}月</span>`);
                if (displaySettings.showLunarDay) lunarParts.push(`<span id="lunarDayDisplay" class="lunar-date-clickable" style="color: ${displaySettings.lunarDayColor};">${lunar.getDayInChinese()}</span>`); // 添加 ID 和 class
                if (displaySettings.showLunarShiChen) lunarParts.push(`<span id="lunarShiChenDisplay" class="lunar-shichen-clickable" style="color: ${displaySettings.lunarShiChenColor};">${getShiChen(hour)}時</span>`); // 添加 ID 和 class
                
                let lunarDateString = lunarParts.join('');

                // 節氣計算 (無論開關是否開啟，都計算 currentJieqiInfo)
                const solarToday = Solar.fromDate(now);
                const jieQisForYear = solarToday.getLunar().getJieQiTable();

                let tempJieqiName = ''; // 用於暫存計算出的節氣名稱
                let tempJieqiDate = null; // 用於暫存計算出的節氣日期
                let tempDaysUntilNextJieqi = -1; // 用於暫存距離下個節氣的天數

                // 將節氣表轉換為物件陣列，以便於處理和排序
                const allJieqis = Object.entries(jieQisForYear).map(([name, dateStr]) => {
                    return { name: name, date: new Date(dateStr) };
                }).sort((a, b) => a.date.getTime() - b.date.getTime()); // 根據日期排序

                let foundTodayJieqi = false;
                for (const jq of allJieqis) {
                    // 檢查今天是否為此節氣的日期（忽略時間）
                    if (jq.date.getFullYear() === now.getFullYear() &&
                        jq.date.getMonth() === now.getMonth() &&
                        jq.date.getDate() === now.getDate()) {
                        tempJieqiName = jq.name;
                        tempJieqiDate = jq.date;
                        foundTodayJieqi = true;
                        break; // 找到今天的節氣
                    }
                }

                if (!foundTodayJieqi) {
                    // 如果今天不是節氣日，則尋找下一個即將到來的節氣
                    for (const jq of allJieqis) {
                        // 設置 jq.date 的時間為當天結束，以便正確計算天數
                        const jqDateAtEndOfDay = new Date(jq.date.getFullYear(), jq.date.getMonth(), jq.date.getDate(), 23, 59, 59, 999);
                        if (jqDateAtEndOfDay > now) { 
                            const diffTime = jqDateAtEndOfDay.getTime() - now.getTime();
                            tempDaysUntilNextJieqi = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            tempJieqiName = jq.name;
                            tempJieqiDate = jq.date;
                            break; // 找到第一個未來的節氣
                        }
                    }
                }
                // 將計算出的節氣資訊儲存到 currentJieqiInfo
                if (tempJieqiName && tempJieqiDate) {
                    currentJieqiInfo = { name: tempJieqiName, date: tempJieqiDate };
                }

                let jieQiText = '';
                if (displaySettings.showJieqi) { // 只有當節氣開關開啟時才顯示
                    if (foundTodayJieqi) {
                        jieQiText = `${tempJieqiName}`;
                    } else if (tempJieqiName && tempDaysUntilNextJieqi !== -1) {
                        jieQiText = `${tempDaysUntilNextJieqi}➡${tempJieqiName}`;
                    }
                }

                // --- START: Unconditional Holiday Data Calculation for Modal ---
                const holidays = getHolidays(now.getFullYear());
                let foundTodayHoliday = false;

                for (const holiday of holidays) {
                    if (holiday.date.getFullYear() === now.getFullYear() &&
                        holiday.date.getMonth() === now.getMonth() &&
                        holiday.date.getDate() === now.getDate()) {
                        currentHolidayName = holiday.name; // Always store current holiday name
                        foundTodayHoliday = true;
                        break;
                    }
                }

                if (!foundTodayHoliday) { // Only search for next upcoming holiday if today is NOT a holiday
                    const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    for (const holiday of holidays) {
                        const holidayDateAtEndOfDay = new Date(holiday.date.getFullYear(), holiday.date.getMonth(), holiday.date.getDate(), 23, 59, 59, 999);
                        if (holidayDateAtEndOfDay >= tomorrow) {
                            const diffTime = holidayDateAtEndOfDay.getTime() - now.getTime();
                            nextHolidayInfo = { // Always populate nextHolidayInfo if applicable
                                name: holiday.name,
                                date: holiday.date,
                                daysUntil: Math.ceil(diffTime / (1000 * 60 * 60 * 24))
                            };
                            break;
                        }
                    }
                }
                // --- END: Unconditional Holiday Data Calculation for Modal ---


                let holidayCountdownText = ''; // This is for the main display
                if (displaySettings.showHolidays) { // Only display on main screen if setting is ON
                    if (foundTodayHoliday) {
                        holidayCountdownText = `${currentHolidayName}`; // Only name, no countdown
                    } else if (nextHolidayInfo) { // If no current holiday, and nextHolidayInfo exists
                        holidayCountdownText = `${nextHolidayInfo.daysUntil}➡${nextHolidayInfo.name}`;
                    }
                }


                let combinedJieqiHolidayText = '';
                // 移除節氣和節日之間的空格
                if (jieQiText && holidayCountdownText) { // 兩者都有顯示時才組合
                    combinedJieqiHolidayText = `<span style="color: ${displaySettings.jieqiColor};">${jieQiText}</span><span style="color: ${displaySettings.holidayColor};">${holidayCountdownText}</span>`;
                } else if (jieQiText) { // 只有節氣
                    combinedJieqiHolidayText = `<span style="color: ${displaySettings.jieqiColor};">${jieQiText}</span>`;
                } else if (holidayCountdownText) { // 只有節日（當天節日或倒數）
                    combinedJieqiHolidayText = `<span style="color: ${displaySettings.holidayColor};">${holidayCountdownText}</span>`;
                }


                if (lunarDateString || combinedJieqiHolidayText) {
                    lunarAndJieQiHtml = `
                        <div class="lunar-jieqi-combined-text">
                            ${lunarDateString}<span id="jieqiDisplay" class="jieqi-clickable"
                                data-jieqi-name="${currentJieqiInfo ? currentJieqiInfo.name : ''}" 
                                data-jieqi-date="${currentJieqiInfo ? currentJieqiInfo.date.toISOString() : ''}"
                                data-next-holiday-name="${nextHolidayInfo ? nextHolidayInfo.name : ''}"
                                data-next-holiday-date="${nextHolidayInfo ? nextHolidayInfo.date.toISOString() : ''}"
                                data-next-holiday-days-until="${nextHolidayInfo ? nextHolidayInfo.daysUntil : ''}"
                                data-current-holiday-name="${currentHolidayName}"
                            >${combinedJieqiHolidayText}</span>
                        </div>
                    `;
                }
            }

            // 更新畫面
            const dateTimeDisplay = document.getElementById('dateTimeDisplay');
            dateTimeDisplay.innerHTML = `
                <div class="time-text" style="color: ${displaySettings.textColor};">
                    <span>${hoursMinutes}</span>
                    <span class="time-seconds" id="secondsDisplay">${seconds}</span>
                    ${amPmText ? `<span class="time-ampm">${amPmText}</span>` : ''}
                </div>
                ${gregorianDateHtml}
                ${lunarAndJieQiHtml}
            `;
            document.body.style.backgroundColor = displaySettings.backgroundColor; // 應用背景顏色
        }

        /**
         * 使時間顯示元素在螢幕上隨機移動。
         * 移動範圍受限於安全邊界，以確保元素不會移出視窗。
         */
        function moveRandomly() {
            const displayElement = document.getElementById('dateTimeDisplay'); // 獲取時間顯示元素
            const viewportWidth = window.innerWidth; // 獲取視窗寬度
            const viewportHeight = window.innerHeight; // 獲取視窗高度
            const elementRect = displayElement.getBoundingClientRect(); // 獲取元素的大小和位置
            const elementWidth = elementRect.width; // 元素寬度
            const elementHeight = elementRect.height; // 元素高度
            const safeMargin = 20; // 元素距離視窗邊緣的安全邊距
            const smallOffsetRange = 40; // 每次隨機移動的範圍

            let currentX = currentPosition.x; // 當前 X 座標
            let currentY = currentPosition.y; // 當前 Y 座標

            // 計算隨機偏移量
            const offsetX = (Math.random() * 2 - 1) * smallOffsetRange; // X 軸隨機偏移量
            const offsetY = (Math.random() * 2 - 1) * smallOffsetRange; // Y 軸隨機偏移量

            let newTargetX = currentX + offsetX; // 新的目標 X 座標
            let newTargetY = currentY + offsetY; // 新的目標 Y 座標

            // 計算允許的移動範圍，確保元素不會移出視窗
            const minAllowedX = - (viewportWidth / 2) + (elementWidth / 2) + safeMargin;
            const minAllowedY = - (viewportHeight / 2) + (elementHeight / 2) + safeMargin;
            const maxAllowedX = (viewportWidth / 2) - (elementWidth / 2) - safeMargin;
            const maxAllowedY = (viewportHeight / 2) - (elementHeight / 2) - safeMargin;

            // 將新的目標位置限制在允許的範圍內
            newTargetX = Math.max(minAllowedX, Math.min(newTargetX, maxAllowedX));
            newTargetY = Math.max(minAllowedY, Math.min(newTargetY, maxAllowedY));

            // 更新當前位置並應用 CSS 變換
            currentPosition.x = newTargetX;
            currentPosition.y = newTargetY;
            // 調整 transform 確保居中，因為內容高度可能會因顯示設定而變化
            displayElement.style.transform = `translate(calc(-50% + ${newTargetX}px), calc(-72% + ${newTargetY}px))`;
        }

        /**
         * 將所有設定恢復為預設值。
         * 將 displaySettings 重置為 defaultDisplaySettings 的副本，然後儲存並更新 UI。
         */
        function restoreDefaults() {
            displaySettings = { ...defaultDisplaySettings }; // 將當前設定重置為預設值
            saveSettings(); // 儲存預設設定
            updateSettingsModalCheckboxes(); // 更新設定視窗中的顯示
            updateDateTime(); // 更新主畫面顯示
        }

        /**
         * 生成一個隨機的十六進制顏色碼。
         * @returns {string} 隨機的十六進制顏色碼，例如 '#RRGGBB'。
         */
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        /**
         * 隨機設定所有顏色選項的顏色。
         * 更新 displaySettings 中的所有顏色屬性為隨機顏色，然後儲存並更新 UI。
         */
        function setRandomColors() {
            displaySettings.textColor = getRandomColor();
            displaySettings.backgroundColor = getRandomColor();
            displaySettings.gregorianYearColor = getRandomColor();
            displaySettings.gregorianMonthColor = getRandomColor();
            displaySettings.gregorianDayColor = getRandomColor();
            displaySettings.gregorianWeekdayColor = getRandomColor();
            displaySettings.minguoYearColor = getRandomColor();
            displaySettings.lunarMonthColor = getRandomColor();
            displaySettings.lunarDayColor = getRandomColor();
            displaySettings.lunarShiChenColor = getRandomColor();
            displaySettings.jieqiColor = getRandomColor();
            displaySettings.holidayColor = getRandomColor(); // 新增

            saveSettings(); // 儲存新的隨機顏色設定
            updateSettingsModalCheckboxes(); // 更新設定視窗中的顯示
            updateDateTime(); // 更新主畫面顯示
        }


        // 頁面載入後開始更新時間
        window.onload = function () {
            loadSettings(); // 載入之前儲存的設定
            updateSettingsModalCheckboxes(); // 在載入設定後立即更新設定視窗中的開關狀態
            currentPosition = { x: 0, y: 0 }; // 初始化元素位置
            setInterval(updateDateTime, 1000); // 每秒更新一次
            updateDateTime(); // 立即更新一次以避免延遲

            // 設定彈出視窗的「完成」按鈕事件，點擊後關閉彈出視窗
            document.getElementById('doneBtn').onclick = function() {
                document.getElementById('settingsModal').classList.remove('is-active'); // 使用 classList.remove
            };

            // 節氣詳細資料彈出視窗的「關閉」按鈕事件
            document.getElementById('closeJieqiDetailsBtn').onclick = function() {
                document.getElementById('jieqiDetailsModal').classList.remove('is-active'); // 使用 classList.remove
            };

            // 每日宜忌彈出視窗的「關閉」按鈕事件
            document.getElementById('closeYijiDetailsBtn').onclick = function() {
                document.getElementById('yijiDetailsModal').classList.remove('is-active'); // 使用 classList.remove
            };

            // 設定選項的變更事件
            // 每當任何開關或顏色選擇器改變時，都會更新 displaySettings，儲存設定並更新顯示。
            document.getElementById('showAmPm').onchange = function(event) {
                displaySettings.showAmPm = event.target.checked;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('showGregorianYear').onchange = function(event) {
                displaySettings.showGregorianYear = event.target.checked;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('showGregorianMonth').onchange = function(event) {
                displaySettings.showGregorianMonth = event.target.checked;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('showGregorianDay').onchange = function(event) {
                displaySettings.showGregorianDay = event.target.checked;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('showGregorianWeekday').onchange = function(event) {
                displaySettings.showGregorianWeekday = event.target.checked;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('showMinguoYear').onchange = function(event) {
                displaySettings.showMinguoYear = event.target.checked;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('showLunarMonth').onchange = function(event) {
                displaySettings.showLunarMonth = event.target.checked; // 修正：應為 checked
                saveSettings();
                updateDateTime();
            };
            document.getElementById('showLunarDay').onchange = function(event) {
                displaySettings.showLunarDay = event.target.checked;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('showLunarShiChen').onchange = function(event) {
                displaySettings.showLunarShiChen = event.target.checked;
                saveSettings();
                updateDateTime();
            };
            
            // 節氣和節日互斥邏輯
            document.getElementById('showJieqi').onchange = function(event) {
                displaySettings.showJieqi = event.target.checked;
                if (event.target.checked) {
                    displaySettings.showHolidays = false;
                    document.getElementById('showHolidays').checked = false; // 更新 UI
                }
                saveSettings();
                updateDateTime();
            };
            document.getElementById('showHolidays').onchange = function(event) { // 新增
                displaySettings.showHolidays = event.target.checked;
                if (event.target.checked) {
                    displaySettings.showJieqi = false;
                    document.getElementById('showJieqi').checked = false; // 更新 UI
                }
                saveSettings();
                updateDateTime();
            };

            document.getElementById('textColor').onchange = function(event) {
                displaySettings.textColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('backgroundColor').onchange = function(event) {
                displaySettings.backgroundColor = event.target.value;
                saveSettings();
                updateDateTime();
            };

            document.getElementById('gregorianYearColor').onchange = function(event) {
                displaySettings.gregorianYearColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('gregorianMonthColor').onchange = function(event) {
                displaySettings.gregorianMonthColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('gregorianDayColor').onchange = function(event) {
                displaySettings.gregorianDayColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('gregorianWeekdayColor').onchange = function(event) {
                displaySettings.gregorianWeekdayColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('minguoYearColor').onchange = function(event) {
                displaySettings.minguoYearColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('lunarMonthColor').onchange = function(event) {
                displaySettings.lunarMonthColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('lunarDayColor').onchange = function(event) {
                displaySettings.lunarDayColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('lunarShiChenColor').onchange = function(event) {
                displaySettings.lunarShiChenColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('jieqiColor').onchange = function(event) {
                displaySettings.jieqiColor = event.target.value;
                saveSettings();
                updateDateTime();
            };
            document.getElementById('holidayColor').onchange = function(event) { // 新增
                displaySettings.holidayColor = event.target.value;
                saveSettings();
                updateDateTime();
            };

            // 恢復預設按鈕事件
            document.getElementById('restoreDefaultsBtn').onclick = restoreDefaults;
            // 新增隨機顏色按鈕事件
            document.getElementById('randomColorsBtn').onclick = setRandomColors;

            // 使用事件委派處理所有動態生成的可點擊元素
            document.getElementById('dateTimeDisplay').addEventListener('click', function(event) {
                const now = new Date();
                const solar = Solar.fromDate(now);
                const lunar = solar.getLunar();

                const secondsElement = event.target.closest('#secondsDisplay');
                const jieqiElement = event.target.closest('#jieqiDisplay');
                const lunarDayElement = event.target.closest('#lunarDayDisplay');
                const lunarShiChenElement = event.target.closest('#lunarShiChenDisplay');

                if (secondsElement) {
                    document.getElementById('settingsModal').classList.add('is-active');
                    updateSettingsModalCheckboxes();
                } else if (jieqiElement) {
                    // 從 data 屬性中獲取資訊
                    const jieqiName = jieqiElement.getAttribute('data-jieqi-name');
                    const jieqiDateStr = jieqiElement.getAttribute('data-jieqi-date');
                    
                    const nextHolidayName = jieqiElement.getAttribute('data-next-holiday-name');
                    const nextHolidayDateStr = jieqiElement.getAttribute('data-next-holiday-date');
                    const nextHolidayDaysUntil = jieqiElement.getAttribute('data-next-holiday-days-until');
                    const currentHolidayNameFromData = jieqiElement.getAttribute('data-current-holiday-name'); // 從 data 屬性獲取當前節日名稱

                    let detailsHtml = '';

                    // 節氣資訊 (無論 showJieqi 設定如何，都顯示)
                    if (jieqiName && jieqiDateStr) {
                        const jieqiDate = new Date(jieqiDateStr);
                        const formattedDate = `${jieqiDate.getFullYear()}年${(jieqiDate.getMonth() + 1).toString().padStart(2, '0')}月${jieqiDate.getDate().toString().padStart(2, '0')}日`;
                        const description = getJieqiDescription(jieqiName);
                        detailsHtml += `
                            <h3>節氣資訊</h3>
                            <p><strong>節氣名稱：</strong> ${jieqiName}</p>
                            <p><strong>公曆日期：</strong> ${formattedDate}</p>
                            <p style="margin-top: 15px;"><strong>說明：</strong> ${description}</p>
                            <p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
                                節氣是中國傳統曆法中用於指導農事的補充曆法，反映了地球在公轉軌道上的位置變化。
                                ※固定在早上八點辰時更新
                            </p>
                            <hr style="margin: 20px 0; border-color: #555;">
                        `;
                    } else {
                        detailsHtml += `<p>目前沒有節氣資訊可顯示。</p><hr style="margin: 20px 0; border-color: #555;">`;
                    }

                    // 節日資訊 (無論 showHolidays 設定如何，都顯示)
                    // 如果當天有節日，則只顯示當天節日資訊，不顯示即將到來的節日
                    if (currentHolidayNameFromData) {
                        detailsHtml += `
                            <h3>今日節日</h3>
                            <p><strong>節日名稱：</strong> ${currentHolidayNameFromData}</p>
                        `;
                    } else if (nextHolidayName && nextHolidayDateStr && nextHolidayDaysUntil) {
                        const nextHolidayDate = new Date(nextHolidayDateStr);
                        const formattedHolidayDate = `${nextHolidayDate.getFullYear()}年${(nextHolidayDate.getMonth() + 1).toString().padStart(2, '0')}月${nextHolidayDate.getDate().toString().padStart(2, '0')}日`;
                        detailsHtml += `
                            <h3>即將到來的節日</h3>
                            <p><strong>節日名稱：</strong> ${nextHolidayName}</p>
                            <p><strong>公曆日期：</strong> ${formattedHolidayDate}</p>
                            <p><strong>倒數：</strong> 還有 ${nextHolidayDaysUntil} 天</p>
                        `;
                    } else {
                        detailsHtml += `<p>目前沒有即將到來的節日資訊。</p>`;
                    }

                    document.getElementById('jieqiDetailsContent').innerHTML = detailsHtml;
                    document.getElementById('jieqiDetailsModal').classList.add('is-active');
                } else if (lunarDayElement) {
                    const yiList = lunar.getDayYi() || [];
                    const jiList = lunar.getDayJi() || [];

                    let yijiHtml = `
                        <p><strong>農曆日期：</strong> ${lunar.getMonthInChinese().replace('闰', '閏')}月${lunar.getDayInChinese()}</p>
                        <p style="margin-top: 15px;"><strong>宜：</strong> ${yiList.join('、')}</p>
                        <p style="margin-top: 15px;"><strong>忌：：</strong> ${jiList.join('、')}</p>
                        <p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
                            每日宜忌僅供參考，請勿過度迷信。
                        </p>
                    `;
                    document.getElementById('yijiDetailsContent').innerHTML = yijiHtml;
                    document.getElementById('yijiDetailsModal').classList.add('is-active');
                } else if (lunarShiChenElement) {
                    const currentHour = now.getHours();
                    const shiChenName = getShiChen(currentHour);

                    const hourYiList = lunar.getTimeYi() || ['無'];
                    const hourJiList = lunar.getTimeJi() || ['無'];

                    let yijiHtml = `
                        <p><strong>時辰：：</strong> ${shiChenName}時</p>
                        <p style="margin-top: 15px;"><strong>宜：</strong> ${hourYiList.join('、')}</p>
                        <p style="margin-top: 15px;"><strong>忌：：</strong> ${hourJiList.join('、')}</p>
                        <p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
                            時辰宜忌僅供參考，請勿過度迷信。
                        </p>
                    `;
                    document.getElementById('yijiDetailsContent').innerHTML = yijiHtml;
                    document.getElementById('yijiDetailsModal').classList.add('is-active');
                }
            });
        };
    </script>
</body>
</html>
�
