<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時間</title>
    <script src="https://unpkg.com/lunar-javascript@1.7.3/lunar.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --page-background-color: #000; --highlight-color: #ff5b3f; --hour-hand-color: #fff; --minute-hand-color: #fff; --second-hand-color: #ff5b3f; --tick-color: #fff; --number-color: #fff; --calendar-header-color: #ff5b3f; --calendar-weekday-color: #00ffff; --calendar-day-color: #fff; --calendar-lunar-color: #aaa; }
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; min-height: 100vh; width: 100vw; position: relative; font-family: 'Noto Sans TC', sans-serif; background-color: var(--page-background-color); color: #fff; }
        
        /* --- 通用樣式 --- */
        .action-button { background-color: #555; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; transition: background-color 0.3s; }
        .action-button:hover { background-color: #777; }
        .today-btn { font-size: 0.8em; padding: 0; }
        .control-icon { position: fixed; bottom: 20px; width: 32px; height: 32px; cursor: pointer; z-index: 200; opacity: 0.5; transition: opacity 0.3s ease; }
        .control-icon svg { width: 100%; height: 100%; fill: #fff; }
        .control-icon:hover { opacity: 1; }
        #edit-mode-icon { right: 104px; }
        #settings-icon { right: 62px; }
        #fullscreen-icon { right: 20px; }
        .notification-popup { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 255, 127, 0.85); color: #111; padding: 12px 25px; border-radius: 8px; z-index: 1000; font-size: 1.1em; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.4s ease, top 0.4s ease; pointer-events: none; }
        .notification-popup.show { opacity: 1; top: 50px; }

        /* --- 彈出視窗 (Modal) 基礎樣式 --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal.is-active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: #333; margin: auto; padding: 10px; border: 1px solid #888; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); color: #e0e0e0; text-align: center; display: flex; flex-direction: column; gap: 0px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { position: sticky; top: -10px; background-color: #333; z-index: 11; margin: 0; padding: 0 10px 10px 10px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2, .modal-header h3 { margin: 0; font-size: 1.5em; font-weight: bold; color: #00FF00; margin-right: auto; text-align: left; }
        .modal-controls-right { display: flex; gap: 10px; flex-shrink: 0; align-items: center; }
        .close-icon { font-size: 1.5rem; font-weight: bold; color: #fff; cursor: pointer; line-height: 1; transition: color 0.3s; user-select: none; flex-shrink: 0; }
        .close-icon:hover { color: var(--highlight-color); }
        #settingsModal { z-index: 130; }
        #settingsModal .modal-content { width: 1200px; max-width: 95vw; }
        #dateDetailsModal, #shichenDetailsModal, #weatherForecastModal, #hourlyWeatherModal, #moonPhaseModal, #zodiacModal { z-index: 120; }
        #calendarModal, #weeklyCalendarModal, #yearlyCalendarModal { z-index: 110; }
        
        /* --- 全螢幕彈出視窗樣式 --- */
        .modal-fullscreen .modal-content { width: 100%; height: 100%; max-width: none; max-height: none; border-radius: 0; margin: 0; border: none; padding: 2vmin; gap: 1.5vmin; }
        .modal-fullscreen .modal-header { padding: 0; margin: 0; }
        .modal-fullscreen .modal-header h2, .modal-fullscreen .modal-header h3 { font-size: clamp(1.5em, 5vmin, 3em); }
        .modal-fullscreen .modal-header .action-button { font-size: clamp(0.9em, 3vmin, 1.5em); padding: 1vmin 2vmin; }
        .modal-fullscreen .modal-controls-right button { font-size: clamp(1.1em, 3.5vmin, 2em); padding: 0.5vmin 1.2vmin; border-radius: 8px; background-color: #555; color: white; border: none; cursor: pointer; transition: background-color 0.3s; line-height: 1; display: inline-flex; align-items: center; justify-content: center; }
        .modal-fullscreen .modal-controls-right button:hover { background-color: #777; }
        .modal-fullscreen .close-icon { font-size: clamp(1.5rem, 6vmin, 3.5rem); }

        /* --- 設定面板 --- */
        .settings-columns-container { display: flex; flex-wrap: wrap; gap: 0px; justify-content: space-around; width: 100%; }
        .settings-column { flex: 1; min-width: 270px; padding: 10px; border: 1px solid #555; border-radius: 8px; background-color: #444; text-align: left; }
        .settings-column h3 { text-align: center; margin: 0; color: #00FF00; }
        .setting-item { margin-bottom: 6px; display: flex; align-items: center; flex-wrap: nowrap; gap: 10px; transition: opacity 0.3s ease; }
        .setting-item label:first-child { margin-right: auto; flex-shrink: 0; }
        .setting-item.disabled { opacity: 0.5; pointer-events: none; }
        .setting-item.disabled input, .setting-item.disabled select, .setting-item.disabled button { pointer-events: none; }
        .setting-controls { display: flex; align-items: center; gap: 5px; }
        .setting-item input[type="color"] { width: 32px; height: 27px; border: none; padding: 0; background: none; cursor: pointer; flex-shrink: 0; }
        .setting-item input[type="text"] { background-color: #555; color: white; border: 1px solid #888; border-radius: 4px; padding: 5px; font-size: 0.9em; max-width: 100px; }
        .setting-item button { background: none; border: none; cursor: pointer; padding: 0 5px; display: inline-flex; align-items: center; }
        .setting-item button svg { width: 24px; height: 24px; stroke: white; }
        .switch { position: relative; display: inline-block; width: 48px; height: 27px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 27px; }
        .slider:before { position: absolute; content: ""; height: 21px; width: 21px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00FF00; }
        input:focus + .slider { box-shadow: 0 0 1px #00FF00; }
        input:checked + .slider:before { transform: translateX(21px); }
        .interval-selector-group { display: flex; align-items: center; gap: 2px; }
        .interval-select { background-color: #555; color: white; border: 1px solid #888; border-radius: 4px; padding: 5px; font-size: 0.9em; }
        .interval-select-label { color: #ccc; font-size: 0.9em; margin: 0; padding: 0 2px; }
        .random-color-btn { background: #555; border: 1px solid #888; border-radius: 5px; cursor: pointer; padding: 0; font-size: 1.2em; line-height: 1; }
        .random-color-btn:hover { background: #777; }
        .location-input-group, .location-controls-group { display: flex; align-items: center; gap: 5px; }
        .location-controls-group { margin-left: auto; }
        
        /* --- 日曆通用樣式 --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; width: 100%; margin: 0; }
        .calendar-header .calendar-title { margin: 0; font-size: 1.5em; font-weight: bold; color: var(--calendar-header-color); cursor: pointer; margin-right: auto; }
        .calendar-header .calendar-controls { display: flex; gap: 10px; flex-shrink: 0; align-items: center; }
        .calendar-header button { background: none; border: 0; color: #00FF00; font-size: 1.2em; cursor: pointer; padding: 2px 8px; border-radius: 4px; transition: background-color 0.3s, color 0.3s; }
        .calendar-header button:hover { background-color: #555; color: #fff; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; position: sticky; background-color: #333; z-index: 10; padding: 5px 0; font-weight: bold; color: #aaa; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { border-radius: 5px; padding: 5px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; font-size: 0.9em; border: 1px solid #555; cursor: pointer; transition: background-color 0.3s; background-color: transparent !important; z-index: 1; }
        .calendar-day.is-today { border-color: #00FF00; box-shadow: 0 0 5px #00FF00; }
        .calendar-day.other-month { color: #777; }
        .calendar-day:hover { background-color: rgba(94, 94, 94, 0.5) !important; }
        .calendar-day.other-month:hover { background-color: rgba(74, 74, 74, 0.5) !important; }
        .gregorian-day { font-size: 1.2em; font-weight: bold; }
        .lunar-day { font-size: 0.8em; color: #ccc; white-space:nowrap; }
        .event-indicator { font-size: 1em; padding: 1px 4px; border-radius: 3px; display: block; text-align: center; width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin: 3px 0 0 0; }
        .calendar-day.other-month .event-indicator { opacity: 0.6; }
        .event-indicator.holiday { background-color: #007bff; color: white; }
        .event-indicator.jieqi { background-color: #28a745; color: white; }
        .calendar-bg-month { position: absolute; top: 52%; left: 50%; transform: translate(-50%, -50%); font-weight: 900; color: rgba(255, 255, 255, 0.12); z-index: 0; pointer-events: none; font-family: 'Noto Sans TC', 'Inter', sans-serif; line-height: 1; transition: color 0.4s ease; font-size: 30rem; }

        /* --- 主月曆 (Widget) --- */
        .calendar-container { width: clamp(350px, 95vw, 700px); text-align: center; z-index: 10; display: flex; flex-direction: column; flex-shrink: 0; position: relative; padding: 15px; background-color: transparent; border-radius: 10px; overflow: hidden; }
        #analog-calendar-widget .weekday-header { color: var(--calendar-weekday-color); }
        .calendar-container .calendar-day { min-height: 6vh; }
        .calendar-container .calendar-day:hover { background-color: rgba(94, 94, 94, 0.7) !important; }
        .calendar-container .calendar-day.is-today { border-color: var(--highlight-color); box-shadow: 0 0 5px var(--highlight-color); }
        .calendar-container .gregorian-day { font-size: clamp(1.1rem, 1.8vw, 1.4rem); color: var(--calendar-day-color); }
        .calendar-container .lunar-day { font-size: clamp(0.75rem, 1.1vw, 0.9rem); color: var(--calendar-lunar-color); }
        .calendar-container .event-indicator { font-size: clamp(0.7rem, 1vw, 0.8rem); padding: 2px 4px; }
        .calendar-container .calendar-weekdays { top: 30px; background-color: transparent; font-weight: bold;}
        
        /* --- 月曆彈窗 --- */
        #calendarModal .modal-content { overflow: hidden; }
        #calendarModal .calendar-grid { overflow-y: auto; max-height: none; flex-grow: 1; padding-bottom: 2vmin; }
        .modal-fullscreen .calendar-weekdays div { font-size: clamp(0.8em, 2.5vmin, 1.2em); }
        .modal-fullscreen .calendar-day { padding: 1vmin; font-size: clamp(0.9em, 2vmin, 1.2em); }
        .modal-fullscreen .gregorian-day { font-size: clamp(1.2em, 3vmin, 1.8em); }
        .modal-fullscreen .lunar-day { font-size: clamp(0.8em, 2vmin, 1.1em); }
        .modal-fullscreen .event-indicator { font-size: clamp(0.8em, 1.8vmin, 1em); padding: 0.5vmin 1vmin; margin-top: 0.5vmin; }
        .modal-fullscreen .calendar-bg-month { font-size: 80vmin; }

        /* --- 週曆 --- */
        .weekly-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .weekly-calendar-day { border-radius: 8px; padding: 10px; min-height: 100px; display: flex; flex-direction: column; align-items: center; border: 1px solid #555; cursor: pointer; transition: background-color: 0.3s; background-color: transparent !important; z-index: 1; }
        .weekly-calendar-day.is-today { border-color: #00FF00; box-shadow: 0 0 5px #00FF00; }
        .weekly-day-header { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .weekly-gregorian-day { font-size: 1.5em; font-weight: bold; }
        .weekly-lunar-day { font-size: 0.9em; color: #ccc; margin-top: 5px; }
        .weekly-calendar-day .event-indicator { width: 90%; }
        
        /* --- 年曆 --- */
        .yearly-calendar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(25vmin, 1fr)); gap: 1.5vmin; overflow-y: auto; flex-grow: 1; }
        .yearly-month-container { position: relative; overflow: hidden; background-color: transparent; border: 1px solid #555; max-height: 26vh; }
        .yearly-month-container .calendar-bg-month { font-size: 28vmin; top: 46%; }
        .yearly-month-header { font-size: clamp(1.2em, 3.5vmin, 1.8em); font-weight: bold; text-align: center; margin-bottom: 1.5vmin; color: #00FF00; cursor: pointer; }
        .yearly-day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5vmin; text-align: center; }
        .yearly-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; text-align: center; }
        .yearly-weekdays div { font-size: clamp(0.8em, 2vmin, 1.1em); }
        .yearly-day { font-size: clamp(0.9em, 2.2vmin, 1.2em); padding: 0; border-radius: 0; position: relative; cursor: pointer; transition: background-color: 0.3s; min-height: 2vmin; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 0; }
        .yearly-day:hover { background-color: rgba(85, 85, 85, 0.7); }
        .yearly-day.is-today { background-color: #00FF00; color: #000; font-weight: bold; }
        .yearly-indicators { display: flex; gap: 4px; }
        .yearly-indicators .dot { width: 4px; height: 4px; border-radius: 50%; }
        .yearly-indicators .holiday { background-color: #007bff; }
        .yearly-indicators .jieqi { background-color: #28a745; }

        /* --- 詳細資訊彈窗 (日期, 時辰) --- */
        .details-content { text-align: left; }
        .modal-fullscreen .details-content { max-width: 100%; }
        .details-content p { margin-bottom: 10px; font-size: clamp(1.5em, 4.5vmin, 2.5em); line-height: 1.6; }
        .details-content strong { color: #FFD700; }
        .details-content .yi-ji-grid { display: grid; grid-template-columns: 8vmin 1fr; gap: 1vmin 2vmin; font-size: clamp(1.4em, 4vmin, 2.2em); text-align: left; }
        .details-content .yi-ji-grid strong { grid-column: 1; }
        .details-content .yi-ji-grid span { grid-column: 2; }
        .details-content .countdown-section { border-top: 1px solid #555; margin-top: 15px; padding-top: 15px; font-size: 1em; }

        /* --- 天氣彈窗 --- */
        .auto-fit-grid { display: grid; gap: 1.5vmin; width: 100%; text-align: center; }
        .weather-forecast-grid { grid-template-columns: repeat(auto-fit, minmax(15vmin, 1fr)); }
        .hourly-weather-grid { grid-template-columns: repeat(auto-fit, minmax(15vmin, 1fr)); }
        .forecast-day, .hourly-item { background-color: #444; padding: 1.5vmin; border-radius: 8px; border: 1px solid #555; }
        .forecast-day { cursor: pointer; transition: background-color: 0.3s; }
        .forecast-day:hover { background-color: #5e5e5e; }
        .forecast-day p, .hourly-item p { margin: 2px 0; line-height: 1.4; font-size: clamp(0.9em, 2.2vmin, 1.2em); }
        .forecast-day .day-name, .hourly-item .hour-time { font-weight: bold; color: #FFD700; }
        .weather-icon { margin: 5px 0; height: 6vmin; }
        .hourly-item .weather-icon { height: 5vmin; }
        .forecast-day .temp-high { color: #FFA07A; }
        .forecast-day .temp-low { color: #87CEFA; }
        .hourly-item.is-now { border-color: #00FF00; box-shadow: 0 0 8px #00FF00; }
        .weather-svg-icon { display: inline-block; vertical-align: middle; transform: translateY(-10%); }

        /* --- 月相彈窗 --- */
        #moonPhaseModal .modal-content { overflow: hidden; }
        #moonPhaseModal #moonPhaseModalContent { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; align-items: center; gap: 0px; text-align: center; }
        #moonPhaseDisplay { display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%; position: sticky; top: 0; background-color: #333; z-index: 10; padding-bottom: 10px; margin-bottom: 0; }
        #moonPhaseDisplay p { font-size: clamp(1.1em, 3vmin, 1.6em); max-width: 100%; margin: 0; line-height: 1.6; }
        .moon-calendar-container { width: 100%; max-width: 100%; position: relative; margin: 0 auto; max-height: none; flex-grow: 1; overflow-y: auto; }
        .moon-calendar-container .calendar-bg-month { font-size: 28vmin; }
        #moonCalendarGrid .calendar-day { min-height: 10vmin; padding: 0.5vmin; font-size: clamp(0.8em, 2vmin, 1.1em); gap: 0.5vmin; }
        #moonCalendarGrid .gregorian-day { font-size: clamp(1.1em, 2.8vmin, 1.5em); }
        #moonCalendarGrid .moon-phase-icon-small svg, #moonCalendarGrid .moon-phase-icon-small img { width: 4vmin; height: 4vmin; }
        #moonCalendarGrid .calendar-day.is-selected { border-color: #FFD700; box-shadow: 0 0 8px #FFD700; background-color: #5a5a5a !important; }

        /* --- 生肖彈窗 --- */
        .zodiac-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(18vmin, 1fr)); gap: 2vmin; flex-grow: 1; overflow-y: auto; }
        .zodiac-item { background-color: #444; padding: 1.5vmin; border-radius: 8px; border: 1px solid #555; max-height: 20vh; }
        .zodiac-item .zodiac-icon { height: 12vmin; margin-bottom: 1vmin; }
        .zodiac-item p { font-size: clamp(1em, 3vmin, 1.5em); margin: 0; font-weight: bold; }
        .zodiac-svg-icon { display: inline-block; vertical-align: middle; transform: translateY(-15%); }

        /* --- 主畫面 Widget --- */
        #master-layout { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 1s ease-in-out; will-change: transform; z-index: 2; }
        .widget-wrapper { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 1s ease-in-out; will-change: transform; z-index: 10; display: inline-flex; justify-content: center; align-items: center; }
        #dateTimeDisplay { text-align: center; padding: 0; cursor: default; z-index: 10; line-height: 0.75; }
        #led-clock-container { display: flex; align-items: flex-end; justify-content: center; gap: 1vw; }
        #led-clock-svg { width: 100vw; max-width: 84vw; height: auto; filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2)); overflow: visible; }
        .segment, .colon-segment { transition: opacity 0.2s ease-in-out; }
        .time-ampm { font-size: 4vw; font-weight: bold; position: absolute; top: 2vw; right: -1vw; }
        .gregorian-date-text, .lunar-and-jieqi-line { font-family: 'Noto Sans TC', 'Inter', sans-serif; display: flex; justify-content: center; align-items: baseline; white-space: nowrap; cursor: default; position: relative; z-index: 1; width: 92vw; font-weight: 1000; padding: 0.1vw 0; line-height: 0.9; font-size: 6.5vw; }
        .lunar-and-jieqi-line { font-size: 6.25vw; }
        .gregorian-date-parts, .lunar-date-static-text { flex-shrink: 0; }
        .gregorian-date-parts span, .lunar-date-static-text span, .lunar-date-static-text .lunar-month-target-group { cursor: pointer; }
        .moon-phase-icon-target { margin-left: 0; }
        .marquee-container { flex-grow: 1; overflow: hidden; position: relative; text-align: left; min-width: 0; cursor: pointer; align-self: stretch; display: flex; align-items: center; }
        .marquee-inner { display: flex; flex-wrap: nowrap; width: fit-content; will-change: transform; }
        .marquee-container.scrolling .marquee-inner { animation: marquee linear infinite; }
        .marquee-content, .marquee-content-duplicate { display: inline-flex; align-items: baseline; white-space: nowrap; flex-shrink: 0; }
        @keyframes marquee { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        /* --- 類比時鐘 --- */
        #analog-clock-widget { width: clamp(250px, 40vmin, 500px); aspect-ratio: 1 / 1; }
        .clock-container { width: 100%; aspect-ratio: 1 / 1; position: relative; border-radius: 50%; display: flex; justify-content: center; align-items: center; background-color: transparent; box-shadow: 0 0 0 0px var(--tick-color); flex-shrink: 0; z-index: 1; }
        .clock-center-dot { position: absolute; width: 15px; height: 15px; background-color: var(--tick-color); border-radius: 50%; z-index: 11; cursor: pointer; transition: transform 0.2s ease; }
        .clock-center-dot:hover { transform: scale(1.1); }
        .hand { position: absolute; height: 100%; width: 100%; z-index: 10; }
        .hour-hand i { position: absolute; top: 25%; left: 50%; width: 10px; height: 25%; background-color: var(--hour-hand-color); transform: translateX(-50%); border-radius: 2px; }
        .minute-hand i { position: absolute; top: 15%; left: 50%; width: 6px; height: 35%; background-color: var(--minute-hand-color); transform: translateX(-50%); border-radius: 2px; }
        .second-hand i { position: absolute; top: 10%; left: 50%; width: 2px; height: 40%; background-color: var(--second-hand-color); transform: translateX(-50%); border-radius: 1px; }
        .tick-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .tick { position: absolute; background: var(--tick-color); left: 50%; transform: translateX(-50%); }
        .tick-hour { height: 12px; width: 3px; top: 0; }
        .tick-minute { height: 6px; width: 1px; top: 0; opacity: 0.7; }
        .number { position: absolute; top: 25px; left: 50%; transform: translateX(-50%); color: var(--number-color); font-family: 'Noto Sans TC', sans-serif; font-size: clamp(0.8rem, 2.2vw, 1.4rem); font-weight: 700; }
        .number div { transform: rotate(calc(-1 * var(--rotation))); }

        /* --- 掃描線效果 --- */
        .scanline-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background-color: transparent; display: none; }
        #background-scanline-overlay { z-index: -1; }
        #text-scanline-overlay { z-index: 50; }
        #background-scanline-overlay.active.pattern-a { display: block; background-image: repeating-linear-gradient(to bottom, transparent, transparent 2px, rgba(255,255,255,0.1) 2px, rgba(255,255,255,0.1) 4px); }
        #background-scanline-overlay.active.pattern-b { display: block; background-image: repeating-linear-gradient(to bottom, rgba(255,255,255,0.1) 0, rgba(255,255,255,0.1) 2px, transparent 2px, transparent 4px); }
        #text-scanline-overlay.active.pattern-a { display: block; background-image: repeating-linear-gradient(to bottom, transparent, transparent 2px, var(--page-background-color) 2px, var(--page-background-color) 4px); }
        #text-scanline-overlay.active.pattern-b { display: block; background-image: repeating-linear-gradient(to bottom, var(--page-background-color) 0, var(--page-background-color) 2px, transparent 2px, transparent 4px); }

        /* --- 編輯模式 --- */
        body.edit-mode .widget-wrapper { cursor: grab; }
        #edit-mode-controls { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); background-color: rgba(30, 30, 30, 0.8); padding: 10px; border-radius: 10px 10px 0 0; z-index: 210; display: none; gap: 10px; align-items: center; border: 1px solid #555; border-bottom: none; }
        body.edit-mode #edit-mode-controls { display: flex; }
        #edit-mode-controls select, #edit-mode-controls button { background-color: #555; color: white; border: 1px solid #888; border-radius: 5px; padding: 8px 12px; font-size: 1em; cursor: pointer; font-family: 'Noto Sans TC', sans-serif; transition: background-color 0.3s; }
        #edit-mode-controls button:hover { background-color: #777; }
        .edit-controls-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 2px dashed rgba(0, 255, 255, 0.5); display: none; pointer-events: none; z-index: 99; }
        body.edit-mode .edit-controls-wrapper { display: block; }
        .move-handle { position: absolute; background-color: rgba(0, 255, 255, 0.8); border: 1px solid #fff; border-radius: 50%; pointer-events: auto; z-index: 100; box-shadow: 0 0 10px rgba(0, 255, 255, 0.7); width: 40px; height: 40px; top: 50%; left: 50%; transform: translate(-50%, -50%); cursor: move; }
        .move-handle::before, .move-handle::after { content: ''; position: absolute; background-color: #000; }
        .move-handle::before { width: 60%; height: 10%; top: 45%; left: 20%; }
        .move-handle::after { width: 10%; height: 60%; top: 20%; left: 45%; }
        .resize-handle-x { position: absolute; top: 50%; right: -10px; transform: translateY(-50%); width: 10px; height: 40px; background-color: rgba(0, 255, 255, 0.8); border: 1px solid #fff; border-radius: 5px; cursor: ew-resize; pointer-events: auto; z-index: 101; display: none; }
        body.edit-mode .resize-handle-x { display: block; }
        #edit-mode-grid { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-image: linear-gradient(to bottom, transparent 24px, rgba(0, 255, 255, 0.2) 24px, rgba(0, 255, 255, 0.2) 25px, transparent 25px), linear-gradient(to right, transparent 24px, rgba(0, 255, 255, 0.2) 24px, rgba(0, 255, 255, 0.2) 25px, transparent 25px); background-size: 50px 50px; background-position: center center; z-index: 90; pointer-events: none; }
        #edit-mode-grid::before, #edit-mode-grid::after { content: ''; position: absolute; background-color: rgba(255, 0, 255, 0.5); z-index: 91; }
        #edit-mode-grid::before { top: 0; left: 50%; width: 1px; height: 100%; transform: translateX(-50%); }
        #edit-mode-grid::after { top: 50%; left: 0; width: 100%; height: 1px; transform: translateY(-50%); }
        body.edit-mode #edit-mode-grid { display: block; }
        body.edit-mode #analog-clock-widget { border-radius: 50%; overflow: hidden; }
        body.edit-mode #analog-clock-widget .edit-controls-wrapper { border-radius: 50%; }
    </style>
</head>
<body>
    <div id="edit-mode-grid"></div>
    <div id="background-scanline-overlay" class="scanline-overlay"></div>
    <div id="text-scanline-overlay" class="scanline-overlay"></div>
    <div id="master-layout">
        <div id="digital-widget" class="widget-wrapper">
            <div id="dateTimeDisplay">
                <div id="led-clock-container"><svg id="led-clock-svg"></svg><span class="time-ampm" id="amPmDisplay"></span></div>
            </div>
            <div class="edit-controls-wrapper"><div class="move-handle"></div></div>
        </div>
        <div id="gregorian-date-widget" class="widget-wrapper">
            <div class="gregorian-date-text" id="gregorianDateDisplay">
                <span class="gregorian-date-parts" id="gregorianDateParts"></span>
                <div class="marquee-container" id="weatherMarqueeContainer"><div class="marquee-inner" id="weatherMarqueeInner"><span class="marquee-content"></span><span class="marquee-content-duplicate"></span></div></div>
            </div>
            <div class="edit-controls-wrapper"><div class="move-handle"></div><div class="resize-handle-x"></div></div>
        </div>
        <div id="lunar-date-widget" class="widget-wrapper">
            <div class="lunar-and-jieqi-line" id="lunarAndJieqiLine">
                <span class="lunar-date-static-text" id="lunarDateDisplay"></span>
                <div class="marquee-container" id="jieqiHolidayMarqueeContainer"><div class="marquee-inner" id="jieqiHolidayMarqueeInner"><span class="marquee-content"></span><span class="marquee-content-duplicate"></span></div></div>
            </div>
            <div class="edit-controls-wrapper"><div class="move-handle"></div><div class="resize-handle-x"></div></div>
        </div>
        <div id="analog-clock-widget" class="widget-wrapper" style="display: none;">
            <div class="clock-container">
                <div class="hand hour-hand"><i></i></div><div class="hand minute-hand"><i></i></div><div class="hand second-hand"><i></i></div>
                <div class="clock-center-dot" id="clockCenterDot" title="查看時辰宜忌"></div>
                <div id="ticks-container"></div>
            </div>
            <div class="edit-controls-wrapper"><div class="move-handle"></div></div>
        </div>
        <div id="analog-calendar-widget" class="widget-wrapper" style="display: none;">
            <div class="calendar-container">
                 <div class="calendar-bg-month"></div>
                 <div class="calendar-header">
                     <h2 class="calendar-title" id="mainCalendarTitle"></h2>
                     <div class="calendar-controls"><button id="mainPrevMonthBtn">&lt;</button><button id="mainTodayBtn" class="today-btn">今天</button><button id="mainNextMonthBtn">&gt;</button></div>
                 </div>
                 <div class="calendar-weekdays" id="mainCalendarWeekdays"></div>
                 <div id="analog-calendar-grid" class="calendar-grid"></div>
            </div>
            <div class="edit-controls-wrapper"><div class="move-handle"></div></div>
        </div>
    </div>
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>顯示設定</h2>
                <div class="modal-controls-right"><button class="action-button" id="restoreDefaultsBtn">恢復預設</button><button class="action-button" id="randomColorsBtn">隨機顏色</button><span class="close-icon">&times;</span></div>
            </div>
            <div class="settings-columns-container">
                <div class="settings-column">
                    <h3>數位時間</h3>
                    <div class="setting-item"><label for="showDigitalTime">數位時間</label><div class="setting-controls"><label class="switch"><input id="showDigitalTime" type="checkbox"><span class="slider"></span></label></div></div>
                    <div class="setting-item"><label for="hourColor">時</label><div class="setting-controls"><input id="hourColor" type="color"><button class="random-color-btn" data-target="hourColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="minuteColor">分</label><div class="setting-controls"><input id="minuteColor" type="color"><button class="random-color-btn" data-target="minuteColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="secondColor">秒</label><div class="setting-controls"><input id="secondColor" type="color"><button class="random-color-btn" data-target="secondColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="colonColor">冒號</label><div class="setting-controls"><label class="switch" title="切換冒號閃爍"><input id="enableColonBlink" type="checkbox"><span class="slider"></span></label><input id="colonColor" type="color"><button class="random-color-btn" data-target="colonColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showAmPm">12/24小時</label><div class="setting-controls"><label class="switch" title="切換12/24小時格式"><input id="showAmPm" type="checkbox"><span class="slider"></span></label><input id="amPmColor" type="color"><button class="random-color-btn" data-target="amPmColor" title="隨機顏色">🎨</button></div></div>
                    <hr>
                    <h3>公曆</h3>
                    <div class="setting-item"><label for="showGregorianDate">公曆</label><div class="setting-controls"><label class="switch"><input id="showGregorianDate" type="checkbox"><span class="slider"></span></label></div></div>
                    <div class="setting-item"><label for="showGregorianYear">年</label><div class="setting-controls"><label class="switch"><input id="showGregorianYear" type="checkbox"><span class="slider"></span></label><input id="gregorianYearColor" type="color"><button class="random-color-btn" data-target="gregorianYearColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showGregorianMonth">月</label><div class="setting-controls"><label class="switch"><input id="showGregorianMonth" type="checkbox"><span class="slider"></span></label><input id="gregorianMonthColor" type="color"><button class="random-color-btn" data-target="gregorianMonthColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showGregorianDay">日</label><div class="setting-controls"><label class="switch"><input id="showGregorianDay" type="checkbox"><span class="slider"></span></label><input id="gregorianDayColor" type="color"><button class="random-color-btn" data-target="gregorianDayColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showGregorianWeekday">周</label><div class="setting-controls"><label class="switch"><input id="showGregorianWeekday" type="checkbox"><span class="slider"></span></label><input id="gregorianWeekdayColor" type="color"><button class="random-color-btn" data-target="gregorianWeekdayColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showWeather">天氣資訊</label><div class="setting-controls"><label class="switch"><input id="showWeather" type="checkbox"><span class="slider"></span></label><input id="weatherColor" type="color"><button class="random-color-btn" data-target="weatherColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showWeatherLocation">天氣地區</label><div class="setting-controls"><label class="switch"><input id="showWeatherLocation" type="checkbox"><span class="slider"></span></label><input id="weatherLocationColor" type="color"><button class="random-color-btn" data-target="weatherLocationColor" title="隨機顏色">🎨</button></div></div>
                </div>
                <div class="settings-column">
                    <h3>類比時鐘</h3>
                    <div class="setting-item"><label for="showAnalogClock">類比時鐘</label><div class="setting-controls"><label class="switch"><input id="showAnalogClock" type="checkbox"><span class="slider"></span></label></div></div>
                    <div class="setting-item"><label for="hourHandColor">時</label><div class="setting-controls"><input id="hourHandColor" type="color"><button class="random-color-btn" data-target="hourHandColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="minuteHandColor">分</label><div class="setting-controls"><input id="minuteHandColor" type="color"><button class="random-color-btn" data-target="minuteHandColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="secondHandColor">秒</label><div class="setting-controls"><input id="secondHandColor" type="color"><button class="random-color-btn" data-target="secondHandColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="tickColor">刻度</label><div class="setting-controls"><input id="tickColor" type="color"><button class="random-color-btn" data-target="tickColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="numberColor">時間數字</label><div class="setting-controls"><input id="numberColor" type="color"><button class="random-color-btn" data-target="numberColor" title="隨機顏色">🎨</button></div></div>
                    <hr>
                    <h3>農曆</h3>
                    <div class="setting-item"><label for="showLunarDate">農曆</label><div class="setting-controls"><label class="switch"><input id="showLunarDate" type="checkbox"><span class="slider"></span></label></div></div>
                    <div class="setting-item"><label for="showMinguoYear">年</label><div class="setting-controls"><label class="switch"><input id="showMinguoYear" type="checkbox"><span class="slider"></span></label><input id="minguoYearColor" type="color"><button class="random-color-btn" data-target="minguoYearColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showLunarMonth">月</label><div class="setting-controls"><label class="switch"><input id="showLunarMonth" type="checkbox"><span class="slider"></span></label><input id="lunarMonthColor" type="color"><button class="random-color-btn" data-target="lunarMonthColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showLunarDay">日</label><div class="setting-controls"><label class="switch"><input id="showLunarDay" type="checkbox"><span class="slider"></span></label><input id="lunarDayColor" type="color"><button class="random-color-btn" data-target="lunarDayColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showLunarShiChen">時辰</label><div class="setting-controls"><label class="switch"><input id="showLunarShiChen" type="checkbox"><span class="slider"></span></label><input id="lunarShiChenColor" type="color"><button class="random-color-btn" data-target="lunarShiChenColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showJieqi">節氣</label><div class="setting-controls"><label class="switch"><input id="showJieqi" type="checkbox"><span class="slider"></span></label><input id="jieqiColor" type="color"><button class="random-color-btn" data-target="jieqiColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="showHolidays">節日</label><div class="setting-controls"><label class="switch"><input id="showHolidays" type="checkbox"><span class="slider"></span></label><input id="holidayColor" type="color"><button class="random-color-btn" data-target="holidayColor" title="隨機顏色">🎨</button></div></div>
                </div>
            </div>
            <div class="settings-columns-container">
                <div class="settings-column">
                    <h3>月曆</h3>
                    <div class="setting-item"><label for="showAnalogCalendar">月曆</label><div class="setting-controls"><label class="switch"><input id="showAnalogCalendar" type="checkbox"><span class="slider"></span></label></div></div>
                    <div class="setting-item"><label for="calendarHeaderColor">月</label><div class="setting-controls"><input id="calendarHeaderColor" type="color"><button class="random-color-btn" data-target="calendarHeaderColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="calendarWeekdayColor">周</label><div class="setting-controls"><input id="calendarWeekdayColor" type="color"><button class="random-color-btn" data-target="calendarWeekdayColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="calendarDayColor">日</label><div class="setting-controls"><input id="calendarDayColor" type="color"><button class="random-color-btn" data-target="calendarDayColor" title="隨機顏色">🎨</button></div></div>
                    <div class="setting-item"><label for="calendarLunarColor">農曆</label><div class="setting-controls"><input id="calendarLunarColor" type="color"><button class="random-color-btn" data-target="calendarLunarColor" title="隨機顏色">🎨</button></div></div>
                </div>
                <div class="settings-column">
                    <h3>通用</h3>
                    <div class="setting-item"><div class="location-input-group"><select id="countySelect" class="interval-select" style="max-width: 85px;"></select><select id="districtSelect" class="interval-select" style="max-width: 85px;"></select><input id="weatherLocation" type="text" class="interval-select" title="可手動輸入英文地名" placeholder="手動輸入(英文)" style="width: 120px; margin-left: 5px;"></div><div class="location-controls-group"><button id="useCurrentLocationBtn" title="使用目前位置"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L12 6"/><path d="M12 18L12 22"/><path d="M20 12L22 12"/><path d="M2 12L4 12"/><circle cx="12" cy="12" r="2"/><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/></svg></button></div></div>
                    <div class="setting-item"><label for="enableMovement">隨機移動</label><div class="setting-controls"><div class="interval-selector-group"><select id="movementIntervalMinutes" class="interval-select"></select><span class="interval-select-label">分</span><select id="movementIntervalSeconds" class="interval-select"></select><span class="interval-select-label">秒</span></div><label class="switch"><input id="enableMovement" type="checkbox"><span class="slider"></span></label></div></div>
                    <div class="setting-item"><label for="enableTextScanline">文字掃描線</label><div class="setting-controls"><div class="interval-selector-group"><select id="scanlineIntervalMinutes" class="interval-select"></select><span class="interval-select-label">分</span><select id="scanlineIntervalSeconds" class="interval-select"></select><span class="interval-select-label">秒</span></div><label class="switch"><input id="enableTextScanline" type="checkbox"><span class="slider"></span></label></div></div>
                    <div class="setting-item"><label for="enableBackgroundScanline">背景掃描線</label><div class="setting-controls"><label class="switch"><input id="enableBackgroundScanline" type="checkbox"><span class="slider"></span></label></div></div>
                    <div class="setting-item"><label for="backgroundColor">背景顏色</label><div class="setting-controls"><input id="backgroundColor" type="color"><button class="random-color-btn" data-target="backgroundColor" title="隨機顏色">🎨</button></div></div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal modal-fullscreen" id="dateDetailsModal"><div class="modal-content details-content"><div class="modal-header"><h2 id="dateDetailsModalTitle"></h2><span class="close-icon">&times;</span></div><div id="dateDetailsModalContent"></div></div></div>
    <div class="modal modal-fullscreen" id="shichenDetailsModal"><div class="modal-content details-content"><div class="modal-header"><h2 id="shichenDetailsModalTitle"></h2><div class="modal-controls-right"><button id="prevShichenBtn">&lt;</button><button id="nowShichenBtn" class="today-btn">現在</button><button id="nextShichenBtn">&gt;</button><span class="close-icon">&times;</span></div></div><div id="shichenDetailsModalContent"></div></div></div>
    <div class="modal modal-fullscreen" id="calendarModal"><div class="modal-content"><div class="modal-header"><h2 class="calendar-title" id="calendarMonthYear"></h2><div class="modal-controls-right"><button id="popupPrevMonthBtn">&lt;</button><button id="popupTodayBtn" class="today-btn">今天</button><button id="popupNextMonthBtn">&gt;</button><span class="close-icon">&times;</span></div></div><div class="calendar-weekdays" id="calendarWeekdays"></div><div class="calendar-grid" id="calendarGrid"></div></div></div>
    <div class="modal modal-fullscreen" id="weeklyCalendarModal"><div class="modal-content"><div class="modal-header"><h2></h2><div class="modal-controls-right"><button id="prevWeekBtn">&lt;</button><button id="todayWeeklyBtn" class="today-btn">本週</button><button id="nextWeekBtn">&gt;</button><span class="close-icon">&times;</span></div></div><div class="weekly-calendar-grid" id="weeklyCalendarGrid"></div></div></div>
    <div class="modal modal-fullscreen" id="yearlyCalendarModal"><div class="modal-content"><div class="modal-header"><h2 id="yearlyCalendarTitle"></h2><div class="modal-controls-right"><button id="prevYearBtn">&lt;</button><button id="todayYearlyBtn" class="today-btn">今年</button><button id="nextYearBtn">&gt;</button><span class="close-icon">&times;</span></div></div><div class="yearly-calendar-grid" id="yearlyCalendarGrid"></div></div></div>
    <div class="modal modal-fullscreen" id="weatherForecastModal"><div class="modal-content"><div class="modal-header"><h2 id="weatherForecastModalTitle"></h2><span class="close-icon">&times;</span></div><div class="weather-forecast-grid auto-fit-grid" id="weatherForecastGrid"></div></div></div>
    <div class="modal modal-fullscreen" id="hourlyWeatherModal"><div class="modal-content"><div class="modal-header"><h2 id="hourlyWeatherModalTitle"></h2><div class="modal-controls-right"><button class="action-button" id="backToWeeklyForecastBtn">返回週預報</button><span class="close-icon">&times;</span></div></div><div class="hourly-weather-grid auto-fit-grid" id="hourlyWeatherGrid"></div></div></div>
    <div class="modal modal-fullscreen" id="moonPhaseModal"><div class="modal-content details-content"><div class="modal-header"><h2 id="moonPhaseModalTitle"></h2><div class="modal-controls-right"><button id="prevMoonMonthBtn">&lt;</button><button id="todayMoonCalendarBtn" class="today-btn">今天</button><button id="nextMoonMonthBtn">&gt;</button><span class="close-icon">&times;</span></div></div><div id="moonPhaseModalContent"><div id="moonPhaseDisplay"><div class="moon-phase-icon-large" id="mainMoonIcon"></div><p id="mainMoonDescription"></p></div><div class="moon-calendar-container"><div class="calendar-weekdays" id="moonCalendarWeekdays"></div><div class="calendar-grid" id="moonCalendarGrid"></div></div></div></div></div>
    <div class="modal modal-fullscreen" id="zodiacModal"><div class="modal-content"><div class="modal-header"><h2>十二生肖</h2><span class="close-icon">&times;</span></div><div class="zodiac-grid" id="zodiacGrid"></div></div></div>
    <div id="edit-mode-controls"><label for="layoutSlotSelect" id="layout-controls-handle" style="color: #ccc; font-size: 0.9em; cursor: move; user-select: none;">版面槽:</label><select id="layoutSlotSelect"></select><button id="saveLayoutBtn">儲存</button><button id="loadLayoutBtn">讀取</button><button id="exportLayoutsBtn">匯出</button><button id="importLayoutsBtn">匯入</button><input type="file" id="importLayoutsInput" accept=".json" style="display: none;"></div>
    <div id="edit-mode-icon" class="control-icon" title="編輯模式"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><g class="wrench-icon"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></g><g class="close-icon-svg" style="display: none;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></g></svg></div>
    <div id="settings-icon" class="control-icon" title="設定"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg></div>
    <div id="fullscreen-icon" class="control-icon" title="全螢幕"><svg class="enter-fullscreen-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg><svg class="exit-fullscreen-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display: none;"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"></path></svg></div>
    <script>
        // --- 全域變數、狀態與常數 ---
        let settings = {}, transformState = {};
        let timers = { main: null, movement: null, scanline: null, weather: null, analog: null };
        let state = { scanlinePatternIsA: true, lastMarqueeContent: '', lastWeatherContent: '', calendarDate: new Date(), weeklyCalendarDate: new Date(), yearlyCalendarDate: new Date(), shichenDetailDate: new Date(), moonCalendarDate: new Date(), yearlyDataCache: {}, weatherDataCache: null, isDragging: false, dragTarget: null, dragType: null, startX: 0, startY: 0, initialX: 0, initialY: 0, initialScale: 1, initialDist: 0, initialWidth: 0, movementEnabledBeforeEdit: true, initialControlsX: 0, initialControlsY: 0 };
        let ledDigits = {}, ledColons = {};
        const segmentMap = [[1, 1, 1, 1, 1, 1, 0],[0, 1, 1, 0, 0, 0, 0],[1, 1, 0, 1, 1, 0, 1],[1, 1, 1, 1, 0, 0, 1],[0, 1, 1, 0, 0, 1, 1],[1, 0, 1, 1, 0, 1, 1],[1, 0, 1, 1, 1, 1, 1],[1, 1, 1, 0, 0, 0, 0],[1, 1, 1, 1, 1, 1, 1],[1, 1, 1, 1, 0, 1, 1]];
        const segmentTransforms = [ 'translate(16, 0)', 'translate(116, 15) rotate(90)', 'translate(116, 105) rotate(90)', 'translate(16, 180)', 'translate(25, 105) rotate(90)', 'translate(25, 15) rotate(90)', 'translate(16, 90)' ];
        const taiwanLocations = { "台灣": { "english": "taiwan", "districts": { "台灣": "taiwan" } }, "基隆市": { "english": "keelung", "districts": { "基隆市": "keelung", "仁愛區": "renai", "信義區": "xinyi", "中正區": "zhongzheng", "中山區": "zhongshan", "安樂區": "anle", "暖暖區": "nuannuan", "七堵區": "qidu" } }, "臺北市": { "english": "taipei", "districts": { "臺北市": "taipei", "中正區": "zhongzheng", "大同區": "datong", "中山區": "zhongshan", "松山區": "songshan", "大安區": "da'an", "萬華區": "wanhua", "信義區": "xinyi", "士林區": "shilin", "北投區": "beitou", "內湖區": "neihu", "南港區": "nangang", "文山區": "wenshan" } }, "新北市": { "english": "new taipei", "districts": { "新北市": "new taipei", "板橋區": "banqiao", "三重區": "sanchong", "中和區": "zhonghe", "永和區": "yonghe", "新莊區": "xinzhuang", "新店區": "xindian", "土城區": "tucheng", "蘆洲區": "luzhou", "樹林區": "shulin", "汐止區": "xizhi", "鶯歌區": "yingge", "三峽區": "sanxia", "淡水區": "danshui", "瑞芳區": "ruifang", "五股區": "wugu", "泰山區": "taishan", "林口區": "linkou", "深坑區": "shengkeng", "石碇區": "shiding", "坪林區": "pinglin", "三芝區": "sanzhi", "石門區": "shimen", "八里區": "bali", "平溪區": "pingxi", "雙溪區": "shuangxi", "貢寮區": "gongliao", "金山區": "jinshan", "萬里區": "wanli", "烏來區": "wulai" } }, "桃園市": { "english": "taoyuan", "districts": { "桃園市": "taoyuan", "桃園區": "taoyuan", "中壢區": "zhongli", "平鎮區": "pingzhen", "八德區": "bade", "楊梅區": "yangmei", "蘆竹區": "luzhu", "大溪區": "daxi", "龍潭區": "longtan", "龜山區": "guishan", "大園區": "dayuan", "觀音區": "guanyin", "新屋區": "xinwu", "復興區": "fuxing" } }, "臺中市": { "english": "taichung", "districts": { "臺中市": "taichung", "中區": "central", "東區": "east", "南區": "south", "西區": "west", "北區": "north", "北屯區": "beitun", "西屯區": "xitun", "南屯區": "nantun", "太平區": "taiping", "大里區": "dali", "霧峰區": "wufeng", "烏日區": "wuri", "豐原區": "fengyuan", "后里區": "houli", "石岡區": "shigang", "東勢區": "dongshi", "和平區": "heping", "新社區": "xinshe", "潭子區": "tanzi", "大雅區": "daya", "神岡區": "shengang", "大肚區": "dadu", "沙鹿區": "shalu", "龍井區": "longjing", "梧棲區": "wuqi", "清水區": "qingshui", "大甲區": "dajia", "外埔區": "waipu", "大安區": "daan" } }, "臺南市": { "english": "tainan", "districts": { "臺南市": "tainan", "中西區": "west central", "東區": "east", "南區": "south", "北區": "north", "安平區": "anping", "安南區": "annan", "永康區": "yongkang", "歸仁區": "guiren", "新化區": "xinhua", "左鎮區": "zuozhen", "玉井區": "yujing", "楠西區": "nanxi", "南化區": "nanhua", "仁德區": "rende", "關廟區": "guanmiao", "龍崎區": "longqi", "官田區": "guantian", "麻豆區": "madou", "佳里區": "jiali", "西港區": "xigang", "七股區": "qigu", "將軍區": "jiangjun", "學甲區": "xuejia", "北門區": "beimen", "新營區": "xinying", "後壁區": "houbi", "白河區": "baihe", "東山區": "dongshan", "六甲區": "liujia", "下營區": "xiaying", "柳營區": "liuying", "鹽水區": "yanshui", "善化區": "shanhua", "大內區": "danei", "山上區": "shanshang", "新市區": "xingshi", "安定區": "anding" } }, "高雄市": { "english": "kaohsiung", "districts": { "高雄市": "kaohsiung", "楠梓區": "nanzi", "左營區": "zuoying", "鼓山區": "gushan", "三民區": "sanmin", "鹽埕區": "yancheng", "前金區": "qianjin", "新興區": "xinxing", "苓雅區": "lingya", "前鎮區": "qianzhen", "旗津區": "qijin", "小港區": "xiaogang", "鳳山區": "fengshan", "林園區": "linyuan", "大寮區": "daliao", "大樹區": "dashu", "大社區": "dashe", "仁武區": "renwu", "鳥松區": "niaosong", "岡山區": "gangshan", "橋頭區": "qiaotou", "燕巢區": "yanchao", "田寮區": "tianliao", "阿蓮區": "alian", "路竹區": "luzhu", "湖內區": "hunei", "茄萣區": "qieding", "永安區": "yong'an", "彌陀區": "mizuo", "梓官區": "ziguan", "旗山區": "qishan", "美濃區": "meinong", "六龜區": "liugui", "甲仙區": "jiaxian", "杉林區": "shanlin", "內門區": "neimen", "茂林區": "maolin", "桃源區": "taoyuan", "那瑪夏區": "namasia" } }, "新竹縣": { "english": "hsinchu county", "districts": { "新竹縣": "hsinchu county", "竹北市": "zhubei", "竹東鎮": "zhudong", "新埔鎮": "xinpu", "關西鎮": "guanxi", "湖口鄉": "hukou", "新豐鄉": "xinfeng", "芎林鄉": "qionglin", "橫山鄉": "hengshan", "北埔鄉": "beipu", "寶山鄉": "baoshan", "峨眉鄉": "emei", "尖石鄉": "jianshi", "五峰鄉": "wufeng" } }, "苗栗縣": { "english": "miaoli", "districts": { "苗栗縣": "miaoli", "苗栗市": "miaoli city", "頭份市": "toufen", "苑裡鎮": "yuanli", "通霄鎮": "tongxiao", "竹南鎮": "zhunan", "後龍鎮": "houlong", "卓蘭鎮": "zhuolan", "大湖鄉": "dahu", "公館鄉": "gongguan", "銅鑼鄉": "tongluo", "南庄鄉": "nanzhuang", "頭屋鄉": "touwu", "三灣鄉": "sanwan", "三義鄉": "sanyi", "西湖鄉": "xihu", "造橋鄉": "zaoqiao", "獅潭鄉": "shitan", "泰安鄉": "taian" } }, "彰化縣": { "english": "changhua", "districts": { "彰化縣": "changhua", "彰化市": "changhua city", "員林市": "yuanlin", "和美鎮": "hemei", "鹿港鎮": "lukang", "溪湖鎮": "xihu", "田中鎮": "tianzhong", "北斗鎮": "beidou", "二林鎮": "erlin", "線西鄉": "xianxi", "伸港鄉": "shengang", "福興鄉": "fuxing", "秀水鄉": "xiushui", "花壇鄉": "huatan", "芬園鄉": "fenyuan", "大村鄉": "dacun", "埔鹽鄉": "puyan", "埔心鄉": "puxin", "永靖鄉": "yongjing", "社頭鄉": "shetou", "二水鄉": "ershui", "田尾鄉": "tianwei", "埤頭鄉": "pitou", "芳苑鄉": "fangyuan", "大城鄉": "dacheng", "竹塘鄉": "zhutang", "溪州鄉": "xizhou" } }, "南投縣": { "english": "nantou", "districts": { "南投縣": "nantou", "南投市": "nantou city", "埔里鎮": "puli", "草屯鎮": "caotun", "竹山鎮": "zhushan", "集集鎮": "jiji", "名間鄉": "mingjian", "鹿谷鄉": "lugu", "中寮鄉": "zhongliao", "魚池鄉": "yuchi", "國姓鄉": "guoxing", "水里鄉": "shuili", "信義鄉": "xinyi", "仁愛鄉": "ren'ai" } }, "雲林縣": { "english": "yunlin", "districts": { "雲林縣": "yunlin", "斗六市": "douliu", "斗南鎮": "dounan", "虎尾鎮": "huwei", "西螺鎮": "xiluo", "土庫鎮": "tuku", "北港鎮": "beigang", "古坑鄉": "gukeng", "大埤鄉": "dapi", "莿桐鄉": "citong", "林內鄉": "linnei", "二崙鄉": "erlun", "崙背鄉": "lunbei", "麥寮鄉": "mailiao", "東勢鄉": "dongshi", "褒忠鄉": "baozhong", "臺西鄉": "taixi", "元長鄉": "yuanchang", "四湖鄉": "sihu", "口湖鄉": "kouhu", "水林鄉": "shuilin" } }, "嘉義縣": { "english": "chiayi county", "districts": { "嘉義縣": "chiayi county", "太保市": "taibao", "朴子市": "puzi", "布袋鎮": "budai", "大林鎮": "dalin", "民雄鄉": "minxiong", "溪口鄉": "xikou", "新港鄉": "xingang", "六腳鄉": "liujiao", "東石鄉": "dongshi", "義竹鄉": "yizu", "鹿草鄉": "lucao", "水上鄉": "shuishang", "中埔鄉": "zhongpu", "竹崎鄉": "zhuqi", "梅山鄉": "meishan", "番路鄉": "fanlu", "大埔鄉": "dapu", "阿里山鄉": "alishan" } }, "屏東縣": { "english": "pingtung", "districts": { "屏東縣": "pingtung", "屏東市": "pingtung city", "潮州鎮": "chaozhou", "東港鎮": "donggang", "恆春鎮": "hengchun", "萬丹鄉": "wandan", "長治鄉": "changzhi", "麟洛鄉": "linluo", "九如鄉": "jiuru", "里港鄉": "ligang", "鹽埔鄉": "yanpu", "高樹鄉": "gaoshu", "萬巒鄉": "wanluan", "內埔鄉": "neipu", "竹田鄉": "zhutian", "新埤鄉": "xinpi", "枋寮鄉": "fangliao", "新園鄉": "xinyuan", "崁頂鄉": "kanding", "林邊鄉": "linbian", "南州鄉": "nanzhou", "佳冬鄉": "jiadong", "琉球鄉": "liuqiu", "車城鄉": "checheng", "滿州鄉": "manzhou", "枋山鄉": "fangshan", "三地門鄉": "sandimen", "霧臺鄉": "wutai", "瑪家鄉": "majia", "泰武鄉": "taiwu", "來義鄉": "laiyi", "春日鄉": "chunri", "獅子鄉": "shizi", "牡丹鄉": "mudan" } }, "宜蘭縣": { "english": "yilan", "districts": { "宜蘭縣": "yilan", "宜蘭市": "yilan city", "羅東鎮": "luodong", "蘇澳鎮": "su'ao", "頭城鎮": "toucheng", "礁溪鄉": "jiaoxi", "壯圍鄉": "zhuangwei", "員山鄉": "yuanshan", "冬山鄉": "dongshan", "五結鄉": "wujie", "三星鄉": "sanxing", "大同鄉": "datong", "南澳鄉": "nan'ao" } }, "花蓮縣": { "english": "hualien", "districts": { "花蓮縣": "hualien", "花蓮市": "hualien city", "鳳林鎮": "fenglin", "玉里鎮": "yuli", "新城鄉": "xincheng", "吉安鄉": "ji'an", "壽豐鄉": "shoufeng", "光復鄉": "guangfu", "豐濱鄉": "fengbin", "瑞穗鄉": "ruisui", "富里鄉": "fuli", "秀林鄉": "xiulin", "萬榮鄉": "wanrong", "卓溪鄉": "zhuoxi" } }, "臺東縣": { "english": "taitung", "districts": { "臺東縣": "taitung", "臺東市": "taitung city", "成功鎮": "chenggong", "關山鎮": "guanshan", "卑南鄉": "beinan", "鹿野鄉": "luye", "池上鄉": "chishang", "東河鄉": "donghe", "長濱鄉": "changbin", "太麻里鄉": "taimali", "大武鄉": "dawu", "達仁鄉": "daren", "金峰鄉": "jinfeng", "海端鄉": "haiduan", "延平鄉": "yanping", "綠島鄉": "ludao", "蘭嶼鄉": "lanyu" } }, "澎湖縣": { "english": "penghu", "districts": { "澎湖縣": "penghu", "馬公市": "magong", "湖西鄉": "huxi", "白沙鄉": "baisha", "西嶼鄉": "xiyu", "望安鄉": "wang'an", "七美鄉": "qimei" } }, "金門縣": { "english": "kinmen", "districts": { "金門縣": "kinmen", "金城鎮": "jincheng", "金湖鎮": "jinhu", "金沙鎮": "jinsha", "金寧鄉": "jinning", "烈嶼鄉": "lieyu", "烏坵鄉": "wuqiu" } }, "連江縣": { "english": "lienchiang", "districts": { "連江縣": "lienchiang", "南竿鄉": "nangan", "北竿鄉": "beigan", "莒光鄉": "juguang", "東引鄉": "dongyin" } }, "新竹市": { "english": "hsinchu", "districts": { "新竹市": "hsinchu", "東區": "east", "北區": "north", "香山區": "xiangshan" } }, "嘉義市": { "english": "chiayi", "districts": { "嘉義市": "chiayi", "東區": "east", "西區": "west" } } };
        const defaultSettings = { backgroundColor: '#000000', enableMovement: true, movementIntervalMinutes: 0, movementIntervalSeconds: 10, showWeather: true, weatherLocation: 'taiwan', weatherColor: '#87CEFA', showWeatherLocation: true, weatherLocationColor: '#00FFFF', showDigitalTime: true, showGregorianDate: true, showLunarDate: true, showAmPm: true, showGregorianYear: true, showGregorianMonth: true, showGregorianDay: true, showGregorianWeekday: true, showMinguoYear: true, showLunarMonth: true, showLunarDay: true, showLunarShiChen: true, showJieqi: true, showHolidays: true, hourColor: '#00FF00', minuteColor: '#00FF00', colonColor: '#00FF00', enableColonBlink: true, secondColor: '#00FF00', amPmColor: '#00FF00', gregorianYearColor: '#00FF00', gregorianMonthColor: '#00FF00', gregorianDayColor: '#00FF00', gregorianWeekdayColor: '#00FF00', minguoYearColor: '#00FF00', lunarMonthColor: '#00FF00', lunarDayColor: '#00FF00', lunarShiChenColor: '#00FF00', jieqiColor: '#00FF00', holidayColor: '#00FFFF', enableTextScanline: false, enableBackgroundScanline: false, scanlineIntervalMinutes: 0, scanlineIntervalSeconds: 10, showAnalogClock: false, showAnalogCalendar: false, hourHandColor: '#ffffff', minuteHandColor: '#ffffff', secondHandColor: '#ff5b3f', tickColor: '#ffffff', numberColor: '#ffffff', calendarHeaderColor: '#ff5b3f', calendarWeekdayColor: '#00ffff', calendarDayColor: '#ffffff', calendarLunarColor: '#aaaaaa' };
        const defaultTransformState = { 'master': { x: 0, y: 0, scale: 1 }, 'digital': { x: 0, y: -120, scale: 1 }, 'gregorian-date': { x: 0, y: 80, scale: 1, width: 92 }, 'lunar-date': { x: 0, y: 150, scale: 1, width: 92 }, 'analog-clock': { x: 0, y: -150, scale: 0.8 }, 'analog-calendar': { x: 0, y: 150, scale: 0.8 } };
        const moonPhaseData = { 1: { name: '朔月', aka: '新月', desc: '月球位於太陽和地球之間，月球的黑暗面朝向地球，因此我們看不見月亮。這是農曆月的開始。' }, 2: { name: '既朔月', desc: '新月之後，月球被太陽照亮的一小部分開始可見，呈現極細的彎月。' }, 3: { name: '蛾眉新月', desc: '月牙兒逐漸變寬，形如美女的秀眉。' }, 4: { name: '蛾眉月', desc: '月相持續變寬，更易於觀察。' }, 5: { name: '蛾眉月', desc: '月相持續變寬，更易於觀察。' }, 6: { name: '夕月', desc: '日落後不久即可在西方天空看到，故名夕月。' }, 7: { name: '上弦月', desc: '月球運行到其軌道的四分之一處，我們能看到月球被太陽照亮的一半，看起來像一個字母 "D"。' }, 8: { name: '上弦月', desc: '月球運行到其軌道的四分之一處，我們能看到月球被太陽照亮的一半，看起來像一個字母 "D"。' }, 9: { name: '九夜月', desc: '上弦月之後，可見的被照亮部分繼續增加。' }, 10: { name: '宵月', desc: '夜晚大部分時間都能看到月亮。' }, 11: { name: '漸盈凸月', desc: '月相接近圓滿，但尚未完全變圓。' }, 12: { name: '漸盈凸月', desc: '月相接近圓滿，但尚未完全變圓。' }, 13: { name: '漸盈凸月', desc: '月相接近圓滿，但尚未完全變圓。' }, 14: { name: '小望月', desc: '距離滿月僅一步之遙，非常明亮。' }, 15: { name: '望月', aka: '滿月', desc: '地球位於太陽和月球之間，月球被太陽照亮的整個半球都朝向地球，看起來是一個完整的圓盤。' }, 16: { name: '既望月', desc: '滿月之後，月亮開始由盈轉虧。' }, 17: { name: '立待月', desc: '月出時間稍晚，需要站著等待一會兒。' }, 18: { name: '居待月', desc: '月出更晚，可以在家中坐著等待。' }, 19: { name: '寢待月', desc: '月亮升起時已近睡覺時間。' }, 20: { name: '更待月', desc: '月亮在深夜一更之後才升起。' }, 21: { name: '漸虧凸月', desc: '可見的被照亮部分開始減少，但仍然大於一半。' }, 22: { name: '下弦月', desc: '我們再次看到月球被照亮的一半，但這次看起來像一個反向的 "D"。' }, 23: { name: '下弦月', desc: '我們再次看到月球被照亮的一半，但這次看起來像一個反向的 "D"。' }, 24: { name: '有明月', desc: '天將亮時，仍可在天空中看見月亮。' }, 25: { name: '蛾眉殘月', desc: '月相變回彎曲的鐮刀形狀。' }, 26: { name: '蛾眉殘月', desc: '月相變回彎曲的鐮刀形狀。' }, 27: { name: '殘月', desc: '月牙兒變得更細。' }, 28: { name: '殘月', desc: '月牙兒變得更細。' }, 29: { name: '曉月', desc: '僅在黎明前的東方天空短暫可見。' }, 30: { name: '晦月', desc: '月亮完全消失在太陽的光芒中，為一個農曆月的結束。' } };
        const timeInfoByHour = { 0: { shichen: '子', period: '凌晨' }, 1: { shichen: '丑', period: '凌晨' }, 2: { shichen: '丑', period: '凌晨' }, 3: { shichen: '寅', period: '凌晨' }, 4: { shichen: '寅', period: '凌晨' }, 5: { shichen: '卯', period: '清晨' }, 6: { shichen: '卯', period: '清晨' }, 7: { shichen: '辰', period: '清晨' }, 8: { shichen: '辰', period: '清晨' }, 9: { shichen: '巳', period: '上午' }, 10: { shichen: '巳', period: '上午' }, 11: { shichen: '午', period: '上午' }, 12: { shichen: '午', period: '中午' }, 13: { shichen: '未', period: '下午' }, 14: { shichen: '未', period: '下午' }, 15: { shichen: '申', period: '下午' }, 16: { shichen: '申', period: '下午' }, 17: { shichen: '酉', period: '傍晚' }, 18: { shichen: '酉', period: '傍晚' }, 19: { shichen: '戌', period: '夜晚' }, 20: { shichen: '戌', period: '夜晚' }, 21: { shichen: '亥', period: '夜晚' }, 22: { shichen: '亥', period: '夜晚' }, 23: { shichen: '子', period: '深夜' } };
        const shichenTimeRanges = { '子': '23:00 - 00:59', '丑': '01:00 - 02:59', '寅': '03:00 - 04:59', '卯': '05:00 - 06:59', '辰': '07:00 - 08:59', '巳': '09:00 - 10:59', '午': '11:00 - 12:59', '未': '13:00 - 14:59', '申': '15:00 - 16:59', '酉': '17:00 - 18:59', '戌': '19:00 - 20:59', '亥': '21:00 - 22:59' };
        const zodiacSVGFunctions = { "鼠": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><path d="M 50 90 C 20 90, 20 40, 50 30 C 80 40, 80 90, 50 90 Z" fill="#9E9E9E" stroke="#616161" stroke-width="2"></path><path d="M 25 45 A 15 15 0 1 1 35 30" fill="#757575" stroke="#616161" stroke-width="2"></path><path d="M 75 45 A 15 15 0 1 0 65 30" fill="#757575" stroke="#616161" stroke-width="2"></path><path d="M 40 60 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 60 60 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 50 75 a 4 4 0 1 1 0.1 0" fill="black"></path></svg>`, "牛": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><path d="M 30 30 Q 10 10 20 40" fill="#795548" stroke="#4E342E" stroke-width="2"></path><path d="M 70 30 Q 90 10 80 40" fill="#795548" stroke="#4E342E" stroke-width="2"></path><path d="M 50 95 C 20 95, 25 30, 50 25 C 75 30, 80 95, 50 95 Z" fill="#795548" stroke="#4E342E" stroke-width="2"></path><path d="M 25 50 L 15 60 L 30 60 Z" fill="#A1887F" stroke="#4E342E" stroke-width="2"></path><path d="M 75 50 L 85 60 L 70 60 Z" fill="#A1887F" stroke="#4E342E" stroke-width="2"></path><path d="M 40 60 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 60 60 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 40 80 A 10 8 0 1 1 60 80" fill="#A1887F" stroke="#4E342E" stroke-width="2"></path></svg>`, "虎": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><path d="M 50 90 A 40 40 0 1 1 50.1 90 Z" fill="#FF9800" stroke="#E65100" stroke-width="2"></path><path d="M 25 30 A 10 10 0 1 1 35 20" fill="#F57C00" stroke="#E65100" stroke-width="2"></path><path d="M 75 30 A 10 10 0 1 0 65 20" fill="#F57C00" stroke="#E65100" stroke-width="2"></path><path d="M 20 50 L 30 55" stroke="black" stroke-width="3" fill="none"></path><path d="M 22 65 L 32 68" stroke="black" stroke-width="3" fill="none"></path><path d="M 80 50 L 70 55" stroke="black" stroke-width="3" fill="none"></path><path d="M 78 65 L 68 68" stroke="black" stroke-width="3" fill="none"></path><path d="M 50 30 L 50 40" stroke="black" stroke-width="3" fill="none"></path><path d="M 40 55 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 60 55 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 50 70 L 45 80 L 55 80 Z" fill="black"></path></svg>`, "兔": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><path d="M 35 40 C 30 10, 40 10, 40 40 Z" fill="#FAFAFA" stroke="#BDBDBD" stroke-width="2"></path><path d="M 65 40 C 70 10, 60 10, 60 40 Z" fill="#FAFAFA" stroke="#BDBDBD" stroke-width="2"></path><path d="M 50 90 A 25 30 0 1 1 50.1 90 Z" fill="#FAFAFA" stroke="#BDBDBD" stroke-width="2"></path><path d="M 42 65 a 3 3 0 1 1 0.1 0" fill="#F44336"></path><path d="M 58 65 a 3 3 0 1 1 0.1 0" fill="#F44336"></path><path d="M 50 75 L 50 80 M 45 80 Q 50 85 55 80" fill="none" stroke="#BDBDBD" stroke-width="2"></path></svg>`, "龍": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><path d="M 50 95 C 20 95, 15 40, 50 20 C 85 40, 80 95, 50 95 Z" fill="#00695C" stroke="#004D40" stroke-width="2"></path><path d="M 35 30 C 20 10, 40 15, 40 35" fill="#FFC107" stroke="#FF8F00" stroke-width="1"></path><path d="M 65 30 C 80 10, 60 15, 60 35" fill="#FFC107" stroke="#FF8F00" stroke-width="1"></path><path d="M 40 80 C 35 70, 65 70, 60 80 Q 50 90 40 80 Z" fill="#00695C" stroke="#004D40" stroke-width="2"></path><circle cx="40" cy="55" r="4" fill="#F44336"></circle><circle cx="60" cy="55" r="4" fill="#F44336"></circle><path d="M 35 80 Q 15 75 30 65" fill="none" stroke="#FF8F00" stroke-width="1"></path><path d="M 65 80 Q 85 75 70 65" fill="none" stroke="#FF8F00" stroke-width="1"></path></svg>`, "蛇": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><path d="M 50 20 C 80 20, 80 70, 50 90 C 20 70, 20 20, 50 20 Z" fill="#8BC34A" stroke="#558B2F" stroke-width="2"></path><path d="M 40 50 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 60 50 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 50 90 L 50 98 L 47 95 M 50 98 L 53 95" stroke="#F44336" stroke-width="2" fill="none"></path></svg>`, "馬": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><path d="M 60 10 L 55 40 L 65 40 L 60 60" fill="#6D4C41" stroke="#5D4037" stroke-width="2"></path><path d="M 50 95 C 25 95, 30 20, 50 20 C 70 20, 75 95, 50 95 Z" fill="#A1887F" stroke="#5D4037" stroke-width="2"></path><path d="M 35 30 L 30 15 L 45 30 Z" fill="#A1887F" stroke="#5D4037" stroke-width="2"></path><path d="M 65 30 L 70 15 L 55 30 Z" fill="#A1887F" stroke="#5D4037" stroke-width="2"></path><path d="M 40 55 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 60 55 a 3 3 0 1 1 0.1 0" fill="black"></path></svg>`, "羊": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><circle cx="50" cy="40" r="20" fill="#ECEFF1" stroke="#B0BEC5" stroke-width="1"></circle><circle cx="35" cy="55" r="18" fill="#ECEFF1" stroke="#B0BEC5" stroke-width="1"></circle><circle cx="65" cy="55" r="18" fill="#ECEFF1" stroke="#B0BEC5" stroke-width="1"></circle><circle cx="50" cy="65" r="20" fill="#ECEFF1" stroke="#B0BEC5" stroke-width="1"></circle><circle cx="50" cy="65" r="15" fill="#CFD8DC" stroke="#78909C" stroke-width="2"></circle><circle cx="44" cy="62" r="2.5" fill="black"></circle><circle cx="56" cy="62" r="2.5" fill="black"></circle><path d="M 30 50 C 15 45, 15 65, 30 65" fill="none" stroke="#78909C" stroke-width="2"></path><path d="M 70 50 C 85 45, 85 65, 70 65" fill="none" stroke="#78909C" stroke-width="2"></path></svg>`, "猴": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><path d="M 20 60 A 15 15 0 1 1 20.1 60 Z" fill="#BCAAA4" stroke="#795548" stroke-width="2"></path><path d="M 80 60 A 15 15 0 1 1 80.1 60 Z" fill="#BCAAA4" stroke="#795548" stroke-width="2"></path><path d="M 50 90 A 35 35 0 1 1 50.1 90 Z" fill="#BCAAA4" stroke="#795548" stroke-width="2"></path><path d="M 50 80 A 25 25 0 1 1 50.1 80 Z" fill="#D7CCC8" stroke="#795548" stroke-width="2"></path><path d="M 40 60 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 60 60 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 40 75 Q 50 85 60 75" fill="none" stroke="#795548" stroke-width="2"></path></svg>`, "雞": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><circle cx="50" cy="60" r="25" fill="#FFFFFF" stroke="#9E9E9E" stroke-width="2"></circle><path d="M 40 35 Q 45 25, 50 35 T 60 35" fill="#F44336" stroke="#D32F2F" stroke-width="1"></path><path d="M 75 60 L 85 65 L 75 70 Z" fill="#FFC107" stroke="#FFA000"></path><path d="M 70 75 A 5 8 0 1 1 70.1 75 Z" fill="#F44336" stroke="#D32F2F" stroke-width="1"></path><circle cx="60" cy="55" r="3" fill="black"></circle></svg>`, "狗": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><path d="M 25 40 L 15 70 L 35 50 Z" fill="#FFE0B2" stroke="#FB8C00" stroke-width="2"></path><path d="M 75 40 L 85 70 L 65 50 Z" fill="#FFE0B2" stroke="#FB8C00" stroke-width="2"></path><path d="M 50 90 C 20 90, 20 40, 50 35 C 80 40, 80 90, 50 90 Z" fill="#FFE0B2" stroke="#FB8C00" stroke-width="2"></path><path d="M 40 60 a 4 4 0 1 1 0.1 0" fill="black"></path><path d="M 60 60 a 4 4 0 1 1 0.1 0" fill="black"></path><path d="M 50 75 L 45 85 L 55 85 Z" fill="black"></path></svg>`, "豬": (s) => `<svg class="zodiac-svg-icon" width="${s}" height="${s}" viewBox="0 0 100 100"><path d="M 25 40 L 20 20 L 40 40 Z" fill="#F8BBD0" stroke="#EC407A" stroke-width="2"></path><path d="M 75 40 L 80 20 L 60 40 Z" fill="#F8BBD0" stroke="#EC407A" stroke-width="2"></path><path d="M 50 90 A 35 35 0 1 1 50.1 90 Z" fill="#F8BBD0" stroke="#EC407A" stroke-width="2"></path><path d="M 50 75 A 15 10 0 1 1 50.1 75 Z" fill="#F48FB1" stroke="#EC407A" stroke-width="2"></path><path d="M 46 75 a 2 2 0 1 1 0.1 0" fill="black"></path><path d="M 54 75 a 2 2 0 1 1 0.1 0" fill="black"></path><path d="M 40 52 a 3 3 0 1 1 0.1 0" fill="black"></path><path d="M 60 52 a 3 3 0 1 1 0.1 0" fill="black"></path></svg>` };
        
        // --- 輔助函式 (Utilities) ---
        const qs = (selector) => document.querySelector(selector);
        const qsa = (selector) => document.querySelectorAll(selector);
        const setStyle = (element, styles) => Object.assign(element.style, styles);
        function hexToRgba(hex, alpha = 1) { // 將 HEX 色碼轉為 RGBA
            if (!hex || !hex.startsWith('#')) return `rgba(255, 255, 255, ${alpha})`;
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255, g = (bigint >> 8) & 255, b = bigint & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        function s2t(input) { // 簡轉繁
            if (typeof input !== 'string' && !Array.isArray(input)) return input;
            const map = {'见':'見','贵':'貴','无':'無','开':'開','纳':'納','财':'財','挂':'掛','梁':'樑','动':'動','种':'種','启':'啟','钻':'鑽','订':'訂','竖':'豎','门':'門','词':'詞','讼':'訟','发':'髮','养':'養','马':'馬','经':'經','络':'絡','盖':'蓋','会':'會','学':'學','艺':'藝','医':'醫','装':'裝','结':'結','网':'網','渔':'漁','猎':'獵','亲':'親','进':'進','扫':'掃','绘':'繪','齐':'齊','斋':'齋','庙':'廟','灶':'竈','谢':'謝','问':'問','婿':'壻','归':'歸','宁':'寧','坟':'墳','寿':'壽','坏':'壞','补':'補','厕':'廁','仓':'倉','涂':'塗','桥':'橋','筑':'築','饰':'飾','墙':'牆','买':'買','车':'車','产':'產','雇':'僱','佣':'傭','货':'貨','机':'機','械':'械','酝':'醞','酿':'釀','铸':'鑄','针':'針','库':'庫','疗':'療','诸':'諸','馀':'餘','丧':'喪','断':'斷','蚁':'蟻','户':'戶','炉':'爐','栖':'棲','厨':'廚','胜':'勝','负':'負','灭':'滅','龙':'龍','鸡':'雞','猪':'豬','乌':'烏','双':'雙','宫':'宮','惊':'驚','蛰':'蟄','满':'滿','处':'處','时':'時','气':'氣','后':'後','灾':'災','复':'復','虚':'虛','贼':'賊','败':'敗','仪':'儀','祸':'禍','临':'臨','阴':'陰','阳':'陽','圣':'聖','冲':'沖','绝':'絕','岁':'歲','伤':'傷','杀':'殺','黄':'黃','节':'節','树':'樹','国':'國','万':'萬','长':'長','华':'華','为':'為','电':'電','声':'聲','冻':'凍','虫':'蟲','鱼':'魚','鹰':'鷹','来':'來','润':'潤','凉':'涼','麦':'麥','温':'溫','收':'收','闭':'閉','闰':'閏','谷':'穀','殓':'殮'};
            const convert = (str) => str.split('').map(char => map[char] || char).join('');
            return Array.isArray(input) ? input.map(convert) : convert(input);
        }
        function getWeekNumber(d) { // 取得一年中的第幾週
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return [d.getUTCFullYear(), Math.ceil((((d - yearStart) / 86400000) + 1) / 7)];
        }
        function showNotification(message, duration = 2000) { // 顯示通知
            let notification = qs('.notification-popup');
            if (!notification) {
                notification = document.createElement('div');
                notification.className = 'notification-popup';
                document.body.appendChild(notification);
            }
            notification.textContent = message;
            notification.classList.remove('show');
            requestAnimationFrame(() => notification.classList.add('show'));
            setTimeout(() => notification.classList.remove('show'), duration);
        }

        // --- 狀態與版面配置存取 (State & Layout Management) ---
        function saveState() { // 儲存設定與版面到 localStorage
            try {
                localStorage.setItem('mergedClockSettings_v4', JSON.stringify(settings));
                localStorage.setItem('mergedClockTransforms_v4', JSON.stringify(transformState));
            } catch (e) { console.error("儲存狀態失敗:", e); }
        }
        function loadState() { // 從 localStorage 載入設定與版面
            try {
                const storedSettings = localStorage.getItem('mergedClockSettings_v4');
                settings = storedSettings ? { ...defaultSettings, ...JSON.parse(storedSettings) } : { ...defaultSettings };
                const storedTransforms = localStorage.getItem('mergedClockTransforms_v4');
                transformState = storedTransforms ? { ...defaultTransformState, ...JSON.parse(storedTransforms) } : { ...defaultTransformState };
            } catch (e) {
                console.error("解析狀態失敗:", e);
                settings = { ...defaultSettings };
                transformState = { ...defaultTransformState };
            }
            settings.editMode = false;
        }
        function saveLayoutToSlot(slot) { // 儲存版面到指定槽位
            if (!slot || slot < 1 || slot > 10) return;
            const now = new Date();
            const defaultRemark = `${now.getFullYear().toString().slice(-2)}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
            let remark = prompt("請輸入版面備註：", "");
            if (remark === null) return;
            if (remark.trim() === "") remark = defaultRemark;
            try {
                const layoutData = { transforms: transformState, settings: settings, timestamp: now.toISOString(), remark: remark };
                localStorage.setItem(`mergedClockLayout_v5_slot_${slot}`, JSON.stringify(layoutData));
                qs(`#layoutSlotSelect option[value="${slot}"]`).textContent = `版面 ${slot} (${remark})`;
                showNotification(`版面 ${slot} 已儲存！`);
            } catch (e) { console.error(`儲存版面 ${slot} 失敗:`, e); showNotification(`儲存版面 ${slot} 失敗。`, 3000); }
        }
        function loadLayoutFromSlot(slot) { // 從指定槽位讀取版面
            if (!slot || slot < 1 || slot > 10) return;
            try {
                const storedLayoutData = localStorage.getItem(`mergedClockLayout_v5_slot_${slot}`);
                if (storedLayoutData) {
                    const layoutData = JSON.parse(storedLayoutData);
                    settings = { ...defaultSettings, ...layoutData.settings };
                    transformState = { ...defaultTransformState, ...layoutData.transforms };
                    applyAllSettings(true);
                    showNotification(`已讀取版面 ${slot}。`);
                } else { showNotification(`版面 ${slot} 沒有儲存的資料。`, 2500); }
            } catch (e) { console.error(`讀取版面 ${slot} 失敗:`, e); showNotification(`讀取版面 ${slot} 失敗。`, 3000); }
        }
        function exportLayoutsToFile() { // 匯出所有版面配置
            const layoutsToExport = {};
            let hasData = false;
            for (let i = 1; i <= 10; i++) {
                const layoutData = localStorage.getItem(`mergedClockLayout_v5_slot_${i}`);
                if (layoutData) {
                    layoutsToExport[i] = JSON.parse(layoutData);
                    hasData = true;
                }
            }
            if (!hasData) { showNotification("沒有可匯出的版面資料。", 2500); return; }
            const jsonString = JSON.stringify(layoutsToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
            a.href = url;
            a.download = `time_layouts_${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification("所有版面已匯出成檔案。", 2000);
        }
        function importLayoutsFromFile(event) { // 從檔案匯入版面配置
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedLayouts = JSON.parse(e.target.result);
                    let importedCount = 0;
                    for (const slot in importedLayouts) {
                        const slotNum = parseInt(slot, 10);
                        if (!isNaN(slotNum) && slotNum >= 1 && slotNum <= 10) {
                            const layoutData = importedLayouts[slot];
                            if (layoutData && layoutData.transforms && layoutData.settings) {
                                localStorage.setItem(`mergedClockLayout_v5_slot_${slotNum}`, JSON.stringify(layoutData));
                                importedCount++;
                            }
                        }
                    }
                    if (importedCount > 0) {
                        populateLayoutSlots();
                        showNotification(`成功匯入 ${importedCount} 個版面配置！`, 2500);
                    } else { showNotification("檔案中未找到有效的版面資料。", 3000); }
                } catch (error) { console.error("匯入版面失敗:", error); showNotification("讀取檔案失敗，請確認檔案格式是否正確。", 3000); }
                finally { event.target.value = null; }
            };
            reader.onerror = () => { showNotification("讀取檔案時發生錯誤。", 3000); event.target.value = null; };
            reader.readAsText(file);
        }

        // --- 設定與UI更新 (Settings & UI Updates) ---
        function updateSettingsModalUI() { // 將 settings 物件的內容同步到設定面板UI上
            for (const key in settings) {
                const el = document.getElementById(key);
                if (el) {
                    if (el.type === 'checkbox') el.checked = settings[key];
                    else if (!['countySelect', 'districtSelect'].includes(key)) el.value = settings[key];
                }
            }
            setLocationSelectorsFromEnglish(settings.weatherLocation);
        }
        function restoreDefaults() { // 恢復預設設定
            settings = { ...defaultSettings };
            delete settings.layoutControlsPos;
            transformState = { ...defaultTransformState };
            settings.editMode = false;
            state.movementEnabledBeforeEdit = true;
            saveState();
            toggleEditModeState();
            applyAllSettings(true);
            state.lastMarqueeContent = '';
            state.lastWeatherContent = '';
            updateWeather();
        }
        function setRandomColors() { // 設定隨機顏色
            for (const key in settings) {
                if (key.toLowerCase().includes('color')) {
                    settings[key] = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                }
            }
            saveState();
            updateSettingsModalUI();
            applyAllSettings();
        }
        function applyLayoutControlsPosition() { // 應用編輯模式控制列的位置
            const controls = qs('#edit-mode-controls');
            if (controls) {
                if (settings.layoutControlsPos) {
                    controls.style.left = settings.layoutControlsPos.x;
                    controls.style.bottom = settings.layoutControlsPos.y;
                    controls.style.transform = 'none';
                } else {
                    controls.style.left = '50%';
                    controls.style.bottom = '0';
                    controls.style.transform = 'translateX(-50%)';
                }
            }
        }
        function applyAllSettings(fullRefresh = false) { // 將所有設定應用到畫面上
            document.documentElement.style.setProperty('--page-background-color', settings.backgroundColor);
            ['hourHandColor', 'minuteHandColor', 'secondHandColor', 'tickColor', 'numberColor', 'calendarHeaderColor', 'calendarWeekdayColor', 'calendarDayColor', 'calendarLunarColor'].forEach(key => {
                if (settings[key]) document.documentElement.style.setProperty('--' + key.replace(/([A-Z])/g, '-$1').toLowerCase(), settings[key]);
            });
            qsa('.calendar-bg-month').forEach(el => el.style.color = hexToRgba(settings.calendarHeaderColor, 0.12));
            if (ledDigits.h1) {
                qsa('.hour-digit .segment').forEach(el => el.style.fill = settings.hourColor);
                qsa('.minute-digit .segment').forEach(el => el.style.fill = settings.minuteColor);
                qsa('.second-digit .segment').forEach(el => el.style.fill = settings.secondColor);
                qsa('.colon-segment').forEach(el => el.style.fill = settings.colonColor);
                setStyle(qs('#amPmDisplay'), { color: settings.amPmColor });
            }
            updateWeatherDisplay();
            updateDigitalClock();
            updateAnalogClock();
            if (fullRefresh) {
                updateSettingsModalUI();
                applyTransforms();
                updateWidgetVisibility();
                applyScanlineEffect();
                updateSettingDependencies();
                applyLayoutControlsPosition();
            }
        }
        function updateWidgetVisibility() { // 根據設定更新各 Widget 的可見度
            setStyle(qs('#digital-widget'), { display: settings.showDigitalTime ? 'inline-flex' : 'none' });
            setStyle(qs('#gregorian-date-widget'), { display: settings.showGregorianDate ? 'inline-flex' : 'none' });
            setStyle(qs('#lunar-date-widget'), { display: settings.showLunarDate ? 'inline-flex' : 'none' });
            setStyle(qs('#analog-clock-widget'), { display: settings.showAnalogClock ? 'inline-flex' : 'none' });
            setStyle(qs('#analog-calendar-widget'), { display: settings.showAnalogCalendar ? 'inline-flex' : 'none' });
        }
        function updateSettingDependencies() { // 更新設定項之間的連動關係 (例如父項關閉時，子項變為 disabled)
            const toggleSettingGroup = (parentSelector, childSelectors, isParentEnabled) => {
                const parentSwitch = qs(parentSelector);
                if (!parentSwitch) return;
                const isEnabled = isParentEnabled && parentSwitch.checked;
                childSelectors.forEach(selector => {
                    const item = qs(selector)?.closest('.setting-item');
                    if (item) {
                        item.classList.toggle('disabled', !isEnabled);
                        item.querySelectorAll('input, select, button').forEach(ctrl => ctrl.disabled = !isEnabled);
                    }
                });
            };
            const isGregorianOn = qs('#showGregorianDate').checked, isWeatherOn = qs('#showWeather').checked;
            toggleSettingGroup('#showDigitalTime', ['#hourColor', '#minuteColor', '#secondColor', '#colonColor', '#showAmPm', '#amPmColor'], true);
            toggleSettingGroup('#showLunarDate', ['#showMinguoYear', '#minguoYearColor', '#showLunarMonth', '#lunarMonthColor', '#showLunarDay', '#lunarDayColor', '#showLunarShiChen', '#lunarShiChenColor', '#showJieqi', '#jieqiColor', '#showHolidays', '#holidayColor'], true);
            toggleSettingGroup('#showAnalogClock', ['#hourHandColor', '#minuteHandColor', '#secondHandColor', '#tickColor', '#numberColor'], true);
            toggleSettingGroup('#showAnalogCalendar', ['#calendarHeaderColor', '#calendarWeekdayColor', '#calendarDayColor', '#calendarLunarColor'], true);
            toggleSettingGroup('#showGregorianDate', ['#showGregorianYear', '#gregorianYearColor', '#showGregorianMonth', '#gregorianMonthColor', '#showGregorianDay', '#gregorianDayColor', '#showGregorianWeekday', '#gregorianWeekdayColor', '#showWeather', '#weatherColor', '#showWeatherLocation', '#weatherLocationColor'], true);
            
            qs('#showWeatherLocation').closest('.setting-item')?.classList.toggle('disabled', !(isGregorianOn && isWeatherOn));
            qs('#countySelect').closest('.setting-item')?.classList.toggle('disabled', !(isGregorianOn && isWeatherOn));

            const movementItem = qs('#enableMovement').closest('.setting-item');
            if (movementItem) {
                movementItem.classList.toggle('disabled', settings.editMode);
                movementItem.querySelectorAll('input, select').forEach(ctrl => ctrl.disabled = settings.editMode);
            }
            [ { s: 'showAmPm', c: 'amPmColor' }, { s: 'showGregorianYear', c: 'gregorianYearColor' }, { s: 'showGregorianMonth', c: 'gregorianMonthColor' }, { s: 'showGregorianDay', c: 'gregorianDayColor' }, { s: 'showGregorianWeekday', c: 'gregorianWeekdayColor' }, { s: 'showMinguoYear', c: 'minguoYearColor' }, { s: 'showLunarMonth', c: 'lunarMonthColor' }, { s: 'showLunarDay', c: 'lunarDayColor' }, { s: 'showLunarShiChen', c: 'lunarShiChenColor' }, { s: 'showJieqi', c: 'jieqiColor' }, { s: 'showHolidays', c: 'holidayColor' } ].forEach(item => {
                const s = qs(`#${item.s}`), c = qs(`#${item.c}`);
                if (s && c && !s.checked) {
                    c.disabled = true;
                    c.nextElementSibling?.classList.contains('random-color-btn') && (c.nextElementSibling.disabled = true);
                }
            });
        }
        
        // --- 時間與日期資料 (Time & Date Data) ---
        function getMoonPhaseDetails(lunarDay) { return moonPhaseData[lunarDay] || { name: '未知月相', desc: '無此月相的詳細資訊。' }; }
        function getJieqiDescription(name) { const d = { '立春': '春季開始，萬物復甦。', '雨水': '降雨增多，春耕開始。', '驚蟄': '春雷響動，驚醒冬眠動物。', '春分': '晝夜等長，春意盎然。', '清明': '氣候清爽明朗，掃墓祭祖。', '穀雨': '雨水滋潤，穀物生長。', '立夏': '夏季開始，萬物繁茂。', '小滿': '夏熟作物籽粒開始飽滿。', '芒種': '收穫與播種的時節。', '夏至': '北半球白晝最長，盛夏開始。', '小暑': '天氣開始炎熱。', '大暑': '一年中最炎熱的時期。', '立秋': '秋季開始，氣溫漸降。', '處暑': '暑氣漸退，天氣轉涼。', '白露': '水氣凝結成露，天氣漸寒。', '秋分': '晝夜等長，秋高氣爽。', '寒露': '氣溫更低，天氣轉冷。', '霜降': '天氣漸冷，露水凝結成霜。', '立冬': '冬季開始，萬物收藏。', '小雪': '開始降雪，但雪量不大。', '大雪': '降雪量增多，天氣更冷。', '冬至': '北半球白晝最短，數九寒天開始。', '小寒': '天氣寒冷，尚未達到最冷。', '大寒': '一年中最寒冷的時期。' }; return d[name] || '此節氣無詳細說明。'; }
        function checkYearlyCache(year) { if (state.yearlyDataCache.year !== year) state.yearlyDataCache = { year: year, holidays: [], jieqi: [] }; }
        function getHolidaysForYear(year) {
            checkYearlyCache(year);
            if (state.yearlyDataCache.holidays.length > 0) return state.yearlyDataCache.holidays;
            const holidays = [];
            [{ n: '元旦', m: 0, d: 1 }, { n: '和平紀念日', m: 1, d: 28 }, { n: '兒童節', m: 3, d: 4 }, { n: '勞動節', m: 4, d: 1 }, { n: '國慶日', m: 9, d: 10 }, { n: '聖誕節', m: 11, d: 25 }].forEach(h => holidays.push({ name: h.n, date: new Date(year, h.m, h.d) }));
            [{m:1,d:1,n:'農曆新年'}, {m:1,d:15,n:'元宵節'}, {m:5,d:5,n:'端午節'}, {m:7,d:7,n:'七夕'}, {m:7,d:15,n:'中元節'}, {m:8,d:15,n:'中秋節'}, {m:9,d:9,n:'重陽節'}, {m:12,d:8,n:'臘八節'}].forEach(lh => {
                const sd = Lunar.fromYmd(year, lh.m, lh.d).getSolar();
                holidays.push({ name: lh.n, date: new Date(sd.getYear(), sd.getMonth() - 1, sd.getDay()) });
            });
            const nySolar = Lunar.fromYmd(year, 1, 1).getSolar();
            holidays.push({ name: '除夕', date: new Date(nySolar.getYear(), nySolar.getMonth() - 1, nySolar.getDay() - 1) });
            const qmJieqi = getJieqiForYear(year).find(jq => jq.name === '清明');
            if(qmJieqi) holidays.push({ name: '清明節', date: qmJieqi.date });
            const may1 = new Date(year, 4, 1);
            holidays.push({ name: '母親節', date: new Date(year, 4, 1 + (7 - may1.getDay() + 7) % 7 + 7) });
            return state.yearlyDataCache.holidays = holidays.sort((a, b) => a.date - b.date);
        }
        function getJieqiForYear(year) {
            checkYearlyCache(year);
            if (state.yearlyDataCache.jieqi.length > 0) return state.yearlyDataCache.jieqi;
            const pinyinMap = { 'LI_CHUN': '立春', 'YU_SHUI': '雨水', 'JING_ZHE': '驚蟄', 'CHUN_FEN': '春分', 'QING_MING': '清明', 'GU_YU': '穀雨', 'LI_XIA': '立夏', 'XIAO_MAN': '小滿', 'MANG_ZHONG': '芒種', 'XIA_ZHHI': '夏至', 'XIAO_SHU': '小暑', 'DA_SHU': '大暑', 'LI_QIU': '立秋', 'CHU_SHU': '處暑', 'BAI_LU': '白露', 'QIU_FEN': '秋分', 'HAN_LU': '寒露', 'SHUANG_JIANG': '霜降', 'LI_DONG': '立冬', 'XIAO_XUE': '小雪', 'DA_XUE': '大雪', 'DONG_ZHI': '冬至', 'XIAO_HAN': '小寒', 'DA_HAN': '大寒' };
            const sMap = { '惊蛰': '驚蟄', '小满': '小滿', '芒种': '芒種', '处暑': '處暑', '谷雨': '穀雨' };
            const table = Lunar.fromYmd(year, 1, 1).getJieQiTable();
            return state.yearlyDataCache.jieqi = Object.entries(table).map(([name, dateStr]) => ({ name: pinyinMap[name] || sMap[name] || name, date: new Date(dateStr) })).sort((a, b) => a.date - b.date);
        }
        const getShiChen = (h) => timeInfoByHour[h]?.shichen || '';
        const getShiChenTimeRange = (name) => shichenTimeRanges[name] || '';
        const getDetailedTimePeriod = (h) => timeInfoByHour[h]?.period || '';
        
        // --- 圖示生成 (Icon Generation) ---
        function getMoonPhaseSVG(lunarDay, size = '1em') {
            const phase = (lunarDay - 1) / 29.0, r = 50, cx = 50, cy = 50, light = '#f0e68c', dark = '#222';
            const cos_angle = Math.cos(phase * 2 * Math.PI + Math.PI);
            const base = phase > 0.5 ? `<rect x="0" y="0" width="${cx}" height="${r*2}" fill="${light}" /><rect x="${cx}" y="0" width="${cx}" height="${r*2}" fill="${dark}" />` : `<rect x="0" y="0" width="${cx}" height="${r*2}" fill="${dark}" /><rect x="${cx}" y="0" width="${cx}" height="${r*2}" fill="${light}" />`;
            const terminator = `<ellipse cx="${cx}" cy="${cy}" rx="${r * Math.abs(cos_angle)}" ry="${r}" fill="${cos_angle > 0 ? light : dark}" />`;
            const id = 'moon-clip-' + Math.random().toString(36).substr(2, 9);
            return `<svg width="${size}" height="${size}" viewBox="0 0 100 100" style="display: inline-block; vertical-align: middle; border-radius: 50%; box-shadow: 0 0 2px rgba(240, 230, 140, 0.5);"><defs><clipPath id="${id}"><circle cx="${cx}" cy="${cy}" r="${r}" /></clipPath></defs><g clip-path="url(#${id})">${base}${terminator}</g></svg>`;
        }
        function getWeatherSVGIcon(code, size = '1em') {
            const createSvg = (viewBox = "0 0 64 64") => `<svg width="${size}" height="${size}" viewBox="${viewBox}" class="weather-svg-icon">`;
            const sun = () => `${createSvg()}<g><circle cx="32" cy="32" r="14" fill="#FDB813" stroke="#FDB813" stroke-width="2"/><g stroke="#FDB813" stroke-width="3" stroke-linecap="round">${[0, 45, 90, 135, 180, 225, 270, 315].map(a => `<line x1="32" y1="15" x2="32" y2="5" transform="rotate(${a} 32 32)"/>`).join('')}</g></g></svg>`;
            const cloud = () => `${createSvg()}<g><path d="M 15,42 A 10,10 0 0 1 25,32 A 18,18 0 0 1 52,35 A 12,12 0 0 1 58,48 L 20,48 A 10,10 0 0 1 15,42 Z" fill="#B0C4DE" stroke="#90a4be" stroke-width="1.5"/></g></svg>`;
            const partlyCloudy = () => `${createSvg()}<g><circle cx="24" cy="24" r="12" fill="#FDB813"/><path d="M 15,42 A 10,10 0 0 1 25,32 A 18,18 0 0 1 52,35 A 12,12 0 0 1 58,48 L 20,48 A 10,10 0 0 1 15,42 Z" fill="#B0C4DE" stroke="#90a4be" stroke-width="1.5"/></g></svg>`;
            const rain = () => `${createSvg()}<g><path d="M 15,38 A 10,10 0 0 1 25,28 A 18,18 0 0 1 52,31 A 12,12 0 0 1 58,44 L 20,44 A 10,10 0 0 1 15,38 Z" fill="#90a4be" stroke="#70849e" stroke-width="1.5"/><g stroke="#4682B4" stroke-width="3" stroke-linecap="round">${[[25,48,25,58],[37,50,37,60],[49,48,49,58]].map(c => `<line x1="${c[0]}" y1="${c[1]}" x2="${c[2]}" y2="${c[3]}"/>`).join('')}</g></g></svg>`;
            const snow = () => `${createSvg()}<g><path d="M 15,38 A 10,10 0 0 1 25,28 A 18,18 0 0 1 52,31 A 12,12 0 0 1 58,44 L 20,44 A 10,10 0 0 1 15,38 Z" fill="#B0C4DE" stroke="#90a4be" stroke-width="1.5"/><g stroke="#FFFFFF" stroke-width="2" stroke-linecap="round">${[[25,55],[37,58],[49,55]].map(c => `<path d="M${c[0]-4},${c[1]} l8,0 M${c[0]},${c[1]-4} l0,8 M${c[0]-3},${c[1]-3} l6,6 M${c[0]-3},${c[1]+3} l6,-6"/>`).join('')}</g></g></svg>`;
            const storm = () => `${createSvg()}<g><path d="M 15,38 A 10,10 0 0 1 25,28 A 18,18 0 0 1 52,31 A 12,12 0 0 1 58,44 L 20,44 A 10,10 0 0 1 15,38 Z" fill="#6c757d" stroke="#5c656d" stroke-width="1.5"/><path d="M 38,45 L 32,55 L 42,55 L 36,65" fill="none" stroke="#FFC107" stroke-width="3" stroke-linejoin="round" stroke-linecap="round"/></g></svg>`;
            const fog = () => `${createSvg()}<g><path d="M 15,42 A 10,10 0 0 1 25,32 A 18,18 0 0 1 52,35 A 12,12 0 0 1 58,48 L 20,48 A 10,10 0 0 1 15,42 Z" fill="#E0E0E0" stroke="#C0C0C0" stroke-width="1.5"/><g stroke="#B0B0B0" stroke-width="3" stroke-linecap="round">${[[18,38,56,38],[22,44,52,44],[20,50,54,50]].map(c => `<line x1="${c[0]}" y1="${c[1]}" x2="${c[2]}" y2="${c[3]}"/>`).join('')}</g></g></svg>`;
            switch (code) { case 0: return sun(); case 1: return partlyCloudy(); case 2: case 3: return cloud(); case 45: case 48: return fog(); case 51: case 53: case 55: case 61: case 63: case 80: case 81: return rain(); case 65: case 82: return rain(); case 95: case 96: case 99: return storm(); case 56: case 57: case 66: case 67: case 71: case 73: case 75: case 77: case 85: case 86: return snow(); default: return `<span style="font-size:${size}; vertical-align: middle;">❓</span>`; }
        }
        const getShengXiaoSVG = (name, size = '1.2em') => zodiacSVGFunctions[name] ? zodiacSVGFunctions[name](size) : '';
        
        // --- 時鐘與日期更新 (Clock & Date Updates) ---
        function updateDigitalClock() {
            const now = new Date();
            if (settings.enableBackgroundScanline || settings.enableTextScanline) {
                qs('#background-scanline-overlay').classList.toggle('pattern-a', state.scanlinePatternIsA);
                qs('#background-scanline-overlay').classList.toggle('pattern-b', !state.scanlinePatternIsA);
                qs('#text-scanline-overlay').classList.toggle('pattern-a', !state.scanlinePatternIsA);
                qs('#text-scanline-overlay').classList.toggle('pattern-b', state.scanlinePatternIsA);
            }
            if (settings.showDigitalTime) {
                const h = now.getHours(), m = String(now.getMinutes()).padStart(2, '0'), s = String(now.getSeconds()).padStart(2, '0');
                let displayHour = String(h).padStart(2, '0'), amPmText = '';
                if (settings.showAmPm) {
                    amPmText = getDetailedTimePeriod(h);
                    let dH12 = h % 12;
                    if (dH12 === 0) dH12 = 12;
                    displayHour = String(dH12).padStart(2, '0');
                }
                if (ledDigits.h1) {
                    updateLedDigit(ledDigits.h1, parseInt(displayHour[0]));
                    updateLedDigit(ledDigits.h2, parseInt(displayHour[1]));
                    updateLedDigit(ledDigits.m1, parseInt(m[0]));
                    updateLedDigit(ledDigits.m2, parseInt(m[1]));
                    updateLedDigit(ledDigits.s1, parseInt(s[0]));
                    updateLedDigit(ledDigits.s2, parseInt(s[1]));
                    if (settings.enableColonBlink) {
                        ledColons.main.style.opacity = now.getSeconds() % 2 === 0 ? '1' : '0.2';
                    } else { ledColons.main.style.opacity = '1'; }
                }
                qs('#amPmDisplay').textContent = amPmText;
                setStyle(qs('#amPmDisplay'), { display: amPmText ? 'block' : 'none' });
            }
            if (settings.showGregorianDate) {
                let gregorianParts = [];
                if (settings.showGregorianYear) gregorianParts.push(`<span class="gregorian-year-target" style="color: ${settings.gregorianYearColor};">${now.getFullYear()}年</span>`);
                if (settings.showGregorianMonth) gregorianParts.push(`<span class="gregorian-month-target" style="color: ${settings.gregorianMonthColor};">${(now.getMonth() + 1).toString().padStart(2, '0')}月</span>`);
                if (settings.showGregorianDay) gregorianParts.push(`<span class="gregorian-day-target" style="color: ${settings.gregorianDayColor};">${now.getDate().toString().padStart(2, '0')}日</span>`);
                if (settings.showGregorianWeekday) gregorianParts.push(`<span class="weekday-target" style="color: ${settings.gregorianWeekdayColor};">周${['日', '一', '二', '三', '四', '五', '六'][now.getDay()]}</span>`);
                qs('#gregorianDateParts').innerHTML = gregorianParts.join('');
            }
            if (settings.showLunarDate) {
                const lunar = Solar.fromDate(now).getLunar(), day = lunar.getDay();
                let lunarParts = [], combinedJieqiHolidayText = '';
                if (state.yearlyDataCache.year !== now.getFullYear()) {
                    getHolidaysForYear(now.getFullYear());
                    getJieqiForYear(now.getFullYear());
                }
                if (settings.showMinguoYear) {
                    const shengxiao = s2t(lunar.getYearShengXiao());
                    lunarParts.push(`<span class="lunar-year-target" title="查看十二生肖" style="color: ${settings.minguoYearColor};">${now.getFullYear() - 1911}年${getShengXiaoSVG(shengxiao)}</span>`);
                }
                if (settings.showLunarMonth) {
                    const phase = getMoonPhaseDetails(day);
                    const phaseName = phase.aka ? `${phase.name}(${phase.aka})` : phase.name;
                    lunarParts.push(`<span class="lunar-month-target-group"><span class="lunar-month-text-target" title="查看月曆" style="color: ${settings.lunarMonthColor};">${s2t(lunar.getMonthInChinese())}</span><span class="moon-phase-icon-target" title="查看月相詳情: ${phaseName}" style="color: ${settings.lunarMonthColor};">${getMoonPhaseSVG(day, '1.1em')}</span></span>`);
                }
                if (settings.showLunarDay) lunarParts.push(`<span class="lunar-day-target" style="color: ${settings.lunarDayColor};">${s2t(lunar.getDayInChinese())}</span>`);
                if (settings.showLunarShiChen) lunarParts.push(`<span class="lunar-shichen-target" style="color: ${settings.lunarShiChenColor};">${getShiChen(now.getHours())}時</span>`);
                
                let jieQiText = '', holidayText = '';
                if (settings.showJieqi) {
                    const jq = state.yearlyDataCache.jieqi.find(j => j.date.toDateString() === now.toDateString()) || state.yearlyDataCache.jieqi.find(j => j.date > now);
                    if (jq) {
                        const days = Math.ceil((jq.date - now) / 864e5);
                        jieQiText = (days === 0) ? `${jq.name}` : `${days}➡${jq.name}`;
                    }
                }
                if (settings.showHolidays) {
                    const h = state.yearlyDataCache.holidays.find(h => h.date.toDateString() === now.toDateString()) || state.yearlyDataCache.holidays.find(h => h.date > now);
                    if (h) {
                        const days = Math.ceil((h.date - now) / 864e5);
                        holidayText = (days === 0) ? `${h.name}` : `${days}➡${h.name}`;
                    }
                }
                let marqueeParts = [];
                if(jieQiText) marqueeParts.push(`<span style="color: ${settings.jieqiColor};">${jieQiText}</span>`);
                if(holidayText) marqueeParts.push(`<span style="color: ${settings.holidayColor};">${holidayText}</span>`);
                combinedJieqiHolidayText = marqueeParts.join(' ');
                
                qs('#lunarDateDisplay').innerHTML = lunarParts.join('');
                setStyle(qs('#lunarDateDisplay'), { display: lunarParts.length > 0 ? 'inline-block' : 'none' });
                
                const jieqiMarqueeVisible = settings.showJieqi || settings.showHolidays;
                setStyle(qs('#jieqiHolidayMarqueeContainer'), { display: jieqiMarqueeVisible ? 'block' : 'none' });
                if (jieqiMarqueeVisible && state.lastMarqueeContent !== combinedJieqiHolidayText) {
                    updateMarquee(combinedJieqiHolidayText, 'jieqiHoliday');
                    state.lastMarqueeContent = combinedJieqiHolidayText;
                }
            }
            const weatherMarqueeVisible = settings.showWeather && settings.showGregorianDate;
            setStyle(qs('#weatherMarqueeContainer'), { display: weatherMarqueeVisible ? 'block' : 'none' });
            if (weatherMarqueeVisible && state.lastWeatherContent && qs('#weatherMarqueeInner .marquee-content').innerHTML !== state.lastWeatherContent) {
                updateMarquee(state.lastWeatherContent, 'weather');
            }
        }
        function updateMarquee(text, type) {
            const ids = { container: `${type}MarqueeContainer`, inner: `${type}MarqueeInner` };
            const container = qs(`#${ids.container}`), inner = qs(`#${ids.inner}`);
            if (!container || !inner) return;
            const contentSpan = inner.querySelector('.marquee-content'), duplicateSpan = inner.querySelector('.marquee-content-duplicate');
            if (!contentSpan || !duplicateSpan) return;
            contentSpan.innerHTML = text;
            requestAnimationFrame(() => {
                const contentW = contentSpan.scrollWidth, containerW = container.offsetWidth;
                if (contentW > containerW) {
                    duplicateSpan.innerHTML = text;
                    container.classList.add('scrolling');
                    const computedStyle = window.getComputedStyle(container), fontSize = parseFloat(computedStyle.fontSize);
                    const speed = fontSize * 0.8; // 速度因子
                    const duration = contentW / speed;
                    setStyle(inner, { animationDuration: `${duration}s` });
                } else {
                    duplicateSpan.innerHTML = '';
                    container.classList.remove('scrolling');
                }
            });
        }
        function initializeAnalogClock() {
            const container = qs('#ticks-container');
            container.innerHTML = '';
            for (let i = 1; i <= 60; i++) {
                const isHour = i % 5 === 0, rotation = i * 6;
                const wrapper = document.createElement('div');
                wrapper.className = 'tick-wrapper';
                setStyle(wrapper, { transform: `rotate(${rotation}deg)` });
                const tick = document.createElement('div');
                tick.className = isHour ? 'tick tick-hour' : 'tick tick-minute';
                wrapper.appendChild(tick);
                if (isHour) {
                    wrapper.style.setProperty('--rotation', `${rotation}deg`);
                    const numDiv = document.createElement('div');
                    numDiv.className = 'number';
                    numDiv.innerHTML = `<div>${i / 5}</div>`;
                    wrapper.appendChild(numDiv);
                }
                container.appendChild(wrapper);
            }
        }
        function updateAnalogClock() {
            if (!settings.showAnalogClock && !settings.showAnalogCalendar) return;
            const now = new Date();
            if (settings.showAnalogClock) {
                const s = now.getSeconds() + now.getMilliseconds() / 1000;
                const m = now.getMinutes() + s / 60;
                const h = now.getHours() % 12 + m / 60;
                setStyle(qs('.hour-hand'), { transform: `rotate(${(h / 12) * 360}deg)` });
                setStyle(qs('.minute-hand'), { transform: `rotate(${(m / 60) * 360}deg)` });
                setStyle(qs('.second-hand'), { transform: `rotate(${(s / 60) * 360}deg)` });
            }
            if (settings.showAnalogCalendar) {
                const todayCell = qs('#analog-calendar-grid .is-today .gregorian-day');
                if (!todayCell || new Date().getDate() !== parseInt(todayCell.textContent)) createMainCalendarView(new Date());
            }
        }
        
        // --- LED 時鐘專用函式 ---
        function updateLedDigit(digitElement, number) {
            if (!digitElement || isNaN(number) || number < 0 || number > 9) return;
            digitElement.querySelectorAll('.segment').forEach((segment, i) => segment.style.opacity = segmentMap[number][i] ? '1' : '0.1');
        }
        function createLedDigit(id, x, y, parentGroup, className) {
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.setAttribute('id', id);
            group.setAttribute('transform', `translate(${x}, ${y})`);
            if (className) group.setAttribute('class', className);
            for (let i = 0; i < 7; i++) {
                const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
                use.setAttribute('href', '#segment-shape');
                use.setAttribute('class', 'segment');
                use.setAttribute('transform', segmentTransforms[i]);
                group.appendChild(use);
            }
            parentGroup.appendChild(group);
            return group;
        }
        function createLedColon(id, x, y, parentGroup) {
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.setAttribute('id', id);
            group.setAttribute('transform', `translate(${x}, ${y})`);
            const rect1 = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect1.setAttribute('class', 'colon-segment');
            rect1.setAttribute('x', '4'); rect1.setAttribute('y', '45'); rect1.setAttribute('width', '24'); rect1.setAttribute('height', '24'); rect1.setAttribute('rx', '5');
            group.appendChild(rect1);
            const rect2 = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect2.setAttribute('class', 'colon-segment');
            rect2.setAttribute('x', '4'); rect2.setAttribute('y', '135'); rect2.setAttribute('width', '24'); rect2.setAttribute('height', '24'); rect2.setAttribute('rx', '5');
            group.appendChild(rect2);
            parentGroup.appendChild(group);
            return group;
        }
        function initializeLedClock() {
            const svg = qs('#led-clock-svg');
            if (!svg) return;
            svg.innerHTML = '';
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const segmentShape = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            segmentShape.setAttribute('id', 'segment-shape');
            segmentShape.setAttribute('points', '12 0, 72 0, 84 12, 72 24, 12 24, 0 12');
            defs.appendChild(segmentShape);
            svg.appendChild(defs);
            const digitWidth = 120, colonWidth = 36, digitSpacing = 2, groupSpacing = 0, secondsScale = 0.2, secondsSpacing = 0;
            let currentX = 0;
            const mainClockGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            svg.appendChild(mainClockGroup);
            ledDigits.h1 = createLedDigit('digit-h1', currentX, 0, mainClockGroup, 'hour-digit'); currentX += digitWidth + digitSpacing;
            ledDigits.h2 = createLedDigit('digit-h2', currentX, 0, mainClockGroup, 'hour-digit'); currentX += digitWidth + groupSpacing;
            ledColons.main = createLedColon('colon-main', currentX, 0, mainClockGroup); currentX += colonWidth + groupSpacing;
            ledDigits.m1 = createLedDigit('digit-m1', currentX, 0, mainClockGroup, 'minute-digit'); currentX += digitWidth + digitSpacing;
            ledDigits.m2 = createLedDigit('digit-m2', currentX, 0, mainClockGroup, 'minute-digit'); currentX += digitWidth;
            const mainClockWidth = currentX;
            const secondsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            svg.appendChild(secondsGroup);
            ledDigits.s1 = createLedDigit('digit-s1', 0, 0, secondsGroup, 'second-digit');
            ledDigits.s2 = createLedDigit('digit-s2', digitWidth + digitSpacing, 0, secondsGroup, 'second-digit');
            const mainDigitHeight = 204;
            const scaledSecondsHeight = mainDigitHeight * secondsScale;
            const secondsGroupX = mainClockWidth + secondsSpacing;
            const secondsGroupY = mainDigitHeight - scaledSecondsHeight;
            secondsGroup.setAttribute('transform', `translate(${secondsGroupX}, ${secondsGroupY}) scale(${secondsScale})`);
            const totalWidth = secondsGroupX + (digitWidth * 2 + digitSpacing) * secondsScale;
            svg.setAttribute('viewBox', `0 0 ${totalWidth} ${mainDigitHeight}`);
        }
        
        // --- 日曆生成 (Calendar Generation) ---
        function createMainCalendarView(date) { generateCalendar({ date: date, type: 'main' }); }
        function createPopupCalendarView(date) { generateCalendar({ date: date, type: 'popup' }); }
        function createMoonCalendarView(date) { generateCalendar({ date: date, type: 'moon' }); }
        function generateCalendar({date, type}) {
            const config = {
                main: { 
                    grid: qs('#analog-calendar-grid'), title: qs('#mainCalendarTitle'), weekdays: qs('#mainCalendarWeekdays'),
                    container: qs('#analog-calendar-widget .calendar-container'),
                    renderCell: (d, l) => `<div class="gregorian-day">${d.getDate()}</div><div class="lunar-day">${l.getDay() === 1 ? s2t(l.getMonthInChinese()) + '月' : s2t(l.getDayInChinese())}</div>`,
                    onCellClick: (e, d) => { e.stopPropagation(); if (!settings.editMode) showDateDetails(d); }
                },
                popup: {
                    grid: qs('#calendarGrid'), title: qs('#calendarMonthYear'), weekdays: qs('#calendarWeekdays'),
                    container: qs('#calendarModal .modal-content'),
                    renderCell: (d, l) => `<div class="gregorian-day">${d.getDate()}</div><div class="lunar-day">${l.getDay() === 1 ? s2t(l.getMonthInChinese()) + '月' : s2t(l.getDayInChinese())}</div>`,
                    onCellClick: (e, d) => showDateDetails(d)
                },
                moon: {
                    grid: qs('#moonCalendarGrid'), weekdays: qs('#moonCalendarWeekdays'),
                    container: qs('#moonPhaseModal .moon-calendar-container'),
                    renderCell: (d, l) => `<div class="gregorian-day">${d.getDate()}</div><div class="moon-phase-icon-small">${getMoonPhaseSVG(l.getDay(), '24px')}</div><div class="lunar-day">${l.getDay() === 1 ? s2t(l.getMonthInChinese()) + '月' : s2t(l.getDayInChinese())}</div>`,
                    onCellClick: (e, d) => { state.moonCalendarDate = d; updateMainMoonPhaseDisplay(d); }
                }
            }[type];
            if (!config.grid) return;
            const year = date.getFullYear(), month = date.getMonth();
            config.grid.innerHTML = ''; config.weekdays.innerHTML = '';
            if (config.title) { config.title.textContent = `${year}`; config.title.dataset.year = year; config.title.dataset.month = month; }
            if (config.container) addCalendarBgMonth(config.container, month + 1);
            ['日', '一', '二', '三', '四', '五', '六'].forEach(day => { const el = document.createElement('div'); el.textContent = day; el.className = (type === 'main' ? 'weekday-header' : ''); config.weekdays.appendChild(el); });
            
            const startDate = new Date(year, month, 1 - new Date(year, month, 1).getDay());
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                currentDate.setHours(12,0,0,0);
                const cell = document.createElement('div');
                cell.className = `calendar-day ${currentDate.getMonth() !== month ? 'other-month' : ''} ${currentDate.toDateString() === new Date().toDateString() ? 'is-today' : ''}`;
                cell.dataset.date = currentDate.toISOString();
                cell.onclick = (e) => config.onCellClick(e, currentDate);
                const lunar = Solar.fromDate(currentDate).getLunar();
                cell.innerHTML = config.renderCell(currentDate, lunar);
                if (type !== 'moon') {
                    const holiday = getHolidaysForYear(currentDate.getFullYear()).find(h => h.date.toDateString() === currentDate.toDateString());
                    if (holiday) cell.innerHTML += `<span class="event-indicator holiday">${holiday.name}</span>`;
                    const jq = getJieqiForYear(currentDate.getFullYear()).find(j => j.date.toDateString() === currentDate.toDateString());
                    if (jq) cell.innerHTML += `<span class="event-indicator jieqi">${jq.name}</span>`;
                }
                if (type === 'moon' && state.moonCalendarDate.toDateString() === currentDate.toDateString()) cell.classList.add('is-selected');
                config.grid.appendChild(cell);
            }
        }
        function generateWeekCalendar(baseDate) {
            const grid = qs('#weeklyCalendarGrid'), title = qs('#weeklyCalendarModal h2');
            grid.innerHTML = '';
            const [year, weekNum] = getWeekNumber(baseDate);
            title.textContent = `${year}年 第 ${weekNum} 週`;
            const start = new Date(baseDate);
            start.setDate(baseDate.getDate() - baseDate.getDay());
            const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            for (let i = 0; i < 7; i++) {
                const day = new Date(start);
                day.setDate(start.getDate() + i);
                const cell = document.createElement('div');
                cell.className = `weekly-calendar-day ${day.toDateString() === new Date().toDateString() ? 'is-today' : ''}`;
                cell.dataset.date = day.toISOString();
                cell.onclick = () => showDateDetails(new Date(cell.dataset.date));
                const lunar = Solar.fromDate(day).getLunar();
                cell.innerHTML = `<div class="weekly-day-header">${weekdays[i]}</div><div class="weekly-gregorian-day">${day.getDate()}</div><div class="weekly-lunar-day">${lunar.getDay() === 1 ? s2t(lunar.getMonthInChinese()) + '月' : s2t(lunar.getDayInChinese())}</div>`;
                const holiday = getHolidaysForYear(day.getFullYear()).find(h => h.date.toDateString() === day.toDateString());
                if (holiday) cell.innerHTML += `<span class="event-indicator holiday">${holiday.name}</span>`;
                const jq = getJieqiForYear(day.getFullYear()).find(j => j.date.toDateString() === day.toDateString());
                if (jq) cell.innerHTML += `<span class="event-indicator jieqi">${jq.name}</span>`;
                grid.appendChild(cell);
            }
        }
        function generateYearCalendar(year) {
            const grid = qs('#yearlyCalendarGrid');
            grid.innerHTML = '';
            qs('#yearlyCalendarTitle').textContent = `${year}`;
            const today = new Date();
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            for (let month = 0; month < 12; month++) {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'yearly-month-container';
                monthContainer.title = `查看 ${month + 1}月 月曆`;
                monthContainer.onclick = () => { if (!settings.editMode) { qs('#yearlyCalendarModal').classList.remove('is-active'); state.calendarDate.setFullYear(year, month, 1); createPopupCalendarView(state.calendarDate); qs('#calendarModal').classList.add('is-active'); } };
                addCalendarBgMonth(monthContainer, month + 1);
                const header = document.createElement('div');
                header.className = 'yearly-month-header';
                // header.textContent = `${month + 1}月`;
                monthContainer.appendChild(header);
                const weekdaysDiv = document.createElement('div');
                weekdaysDiv.className = 'yearly-weekdays';
                weekdays.forEach(day => { const el = document.createElement('div'); el.textContent = day; weekdaysDiv.appendChild(el); });
                monthContainer.appendChild(weekdaysDiv);
                const dayGrid = document.createElement('div');
                dayGrid.className = 'yearly-day-grid';
                const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDay; i++) dayGrid.appendChild(document.createElement('div'));
                for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) {
                    const cell = document.createElement('div');
                    cell.className = 'yearly-day';
                    const date = new Date(year, month, dayNum);
                    cell.dataset.date = date.toISOString();
                    cell.onclick = (e) => { e.stopPropagation(); showDateDetails(new Date(cell.dataset.date)); };
                    cell.textContent = dayNum;
                    if (today.getFullYear() === year && today.getMonth() === month && dayNum === today.getDate()) cell.classList.add('is-today');
                    const holiday = getHolidaysForYear(year).find(h => h.date.toDateString() === date.toDateString());
                    const jq = getJieqiForYear(year).find(j => j.date.toDateString() === date.toDateString());
                    if(holiday || jq) {
                        const indicators = document.createElement('div');
                        indicators.className = 'yearly-indicators';
                        if(holiday) indicators.innerHTML += '<span class="dot holiday"></span>';
                        if(jq) indicators.innerHTML += '<span class="dot jieqi"></span>';
                        cell.appendChild(indicators);
                    }
                    dayGrid.appendChild(cell);
                }
                monthContainer.appendChild(dayGrid);
                grid.appendChild(monthContainer);
            }
        }
        function addCalendarBgMonth(container, month) {
            let bgMonthEl = container.querySelector('.calendar-bg-month');
            if (!bgMonthEl) {
                bgMonthEl = document.createElement('div');
                bgMonthEl.className = 'calendar-bg-month';
                container.insertBefore(bgMonthEl, container.firstChild);
            }
            bgMonthEl.textContent = month;
        }

        // --- 天氣功能 (Weather Functions) ---
        function getWeatherDescriptionAndEmoji(code) {
            const map = { 0: { desc: '晴' }, 1: { desc: '多雲時晴' }, 2: { desc: '局部多雲' }, 3: { desc: '陰' }, 45: { desc: '霧' }, 48: { desc: '凍霧' }, 51: { desc: '毛毛雨' }, 53: { desc: '毛毛雨' }, 55: { desc: '毛毛雨' }, 56: { desc: '凍毛毛雨' }, 57: { desc: '凍毛毛雨' }, 61: { desc: '雨' }, 63: { desc: '雨' }, 65: { desc: '大雨' }, 66: { desc: '凍雨' }, 67: { desc: '凍雨' }, 71: { desc: '雪' }, 73: { desc: '雪' }, 75: { desc: '大雪' }, 77: { desc: '冰雹' }, 80: { desc: '陣雨' }, 81: { desc: '陣雨' }, 82: { desc: '大陣雨' }, 85: { desc: '陣雪' }, 86: { desc: '大陣雪' }, 95: { desc: '雷陣雨' }, 96: { desc: '雷陣雨伴冰雹' }, 99: { desc: '雷陣雨伴冰雹' } };
            return map[code] || { desc: '未知' };
        }
        function updateWeatherDisplay() {
            if (!settings.showWeather) { state.lastWeatherContent = ''; updateDigitalClock(); return; }
            let weatherText = `<span style="color: ${settings.weatherColor};">無法取得天氣資訊</span>`;
            if (state.weatherDataCache) {
                const { desc } = getWeatherDescriptionAndEmoji(state.weatherDataCache.current.weather_code);
                const icon = getWeatherSVGIcon(state.weatherDataCache.current.weather_code, '1em');
                const temp = Math.round(state.weatherDataCache.current.temperature_2m);
                const location = settings.showWeatherLocation ? `<span style="color: ${settings.weatherLocationColor};">${getChineseLocationName(settings.weatherLocation)}</span> ` : '';
                weatherText = `${location}<span style="color: ${settings.weatherColor};">${desc}${icon}${temp}°C</span>`;
            }
            state.lastWeatherContent = weatherText;
            updateMarquee(weatherText, 'weather');
        }
        async function updateWeather() {
            const locationName = settings.weatherLocation.trim();
            if (!locationName) { state.weatherDataCache = null; updateWeatherDisplay(); return; }
            const coords = await fetchCoordinates(locationName);
            state.weatherDataCache = coords ? await fetchWeather(coords.latitude, coords.longitude) : null;
            updateWeatherDisplay();
        }
        async function fetchAPI(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('API請求失敗');
                return await response.json();
            } catch (error) { console.error(`獲取資料失敗: ${url}`, error); return null; }
        }
        async function fetchCoordinates(name) {
            const data = await fetchAPI(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`);
            return data?.results?.[0] || null;
        }
        async function fetchWeather(lat, lon) {
            return await fetchAPI(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=8`);
        }
        function getChineseLocationName(englishName) {
            for (const county in taiwanLocations) {
                for (const district in taiwanLocations[county].districts) {
                    if (taiwanLocations[county].districts[district].toLowerCase() === englishName.toLowerCase()) return county === district ? county : district;
                }
            }
            return englishName;
        }

        // --- 彈出視窗顯示邏輯 (Modal Display Logic) ---
        function showDateDetails(date) {
            if (settings.editMode) return;
            date.setHours(12, 0, 0, 0);
            const year = date.getFullYear();
            const isToday = date.toDateString() === new Date().toDateString();
            const lunar = Solar.fromDate(date).getLunar();
            const shengxiao = s2t(lunar.getYearShengXiao());
            const lunarYearText = `${s2t(lunar.getYearInGanZhi())}${shengxiao}${getShengXiaoSVG(shengxiao)}年`;
            const lunarDateText = `${s2t(lunar.getMonthInChinese())}月${s2t(lunar.getDayInChinese())}`;
            let eventHtml = '', countdownHtml = '';
            const currentJieqi = getJieqiForYear(year).find(j => j.date.toDateString() === date.toDateString());
            if (currentJieqi) eventHtml += `<p>${isToday ? '今天是' : '這天是'} <strong>${currentJieqi.name}</strong>！ ${getJieqiDescription(currentJieqi.name)}</p>`;
            const currentHoliday = getHolidaysForYear(year).find(h => h.date.toDateString() === date.toDateString());
            if (currentHoliday) eventHtml += `<p>${isToday ? '今天是' : '這天是'} <strong>${currentHoliday.name}</strong>！</p>`;
            const nextJieqi = getJieqiForYear(year).find(j => j.date > date);
            if (nextJieqi) {
                const days = Math.ceil((nextJieqi.date - date) / 864e5);
                countdownHtml += `<p>距離下個節氣 <strong>${nextJieqi.name}</strong> 還有 ${days} 天。<br><span style="font-size:0.9em; color:#ccc;">${getJieqiDescription(nextJieqi.name)}</span></p>`;
            }
            const nextHoliday = getHolidaysForYear(year).find(h => h.date > date);
            if (nextHoliday) {
                const days = Math.ceil((nextHoliday.date - date) / 864e5);
                countdownHtml += `<p>距離下個節日 <strong>${nextHoliday.name}</strong> 還有 ${days} 天</p>`;
            }
            if (countdownHtml) eventHtml += `<div class="countdown-section">${countdownHtml}</div>`;
            const detailsHtml = `<p><strong>公曆：</strong>${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日</p><p><strong>農曆：</strong>${lunarYearText} ${lunarDateText} ${getMoonPhaseSVG(lunar.getDay(), '1.2em')}</p><div class="yi-ji-grid"><strong>宜：</strong><span>${s2t(lunar.getDayYi()).join('、') || '無'}</span><strong>忌：</strong><span>${s2t(lunar.getDayJi()).join('、') || '無'}</span></div>${eventHtml}<p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">宜忌僅供參考，請順心而為。</p>`;
            qs('#dateDetailsModalTitle').textContent = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            qs('#dateDetailsModalContent').innerHTML = detailsHtml;
            qs('#dateDetailsModal').classList.add('is-active');
        }
        function updateShiChenDetailsView(date) {
            if (settings.editMode) return;
            state.shichenDetailDate = new Date(date);
            const lunar = Solar.fromDate(state.shichenDetailDate).getLunar();
            const hour = state.shichenDetailDate.getHours();
            const name = getShiChen(hour);
            qs('#shichenDetailsModalTitle').textContent = `${state.shichenDetailDate.getMonth() + 1}月${state.shichenDetailDate.getDate()}日 ${name}時`;
            const lunarTime = lunar.getTimes().find(lt => lt.getZhi() === name);
            if (lunarTime) {
                qs('#shichenDetailsModalContent').innerHTML = `<p><strong>時辰：</strong>${name}時 (${s2t(lunarTime.getGan() + lunarTime.getZhi())}) <span style="font-size: 0.9em; color: #ccc;">${getShiChenTimeRange(name)}</span></p><div class="yi-ji-grid"><strong>宜：</strong><span>${s2t(lunarTime.getYi()).join('、') || '無'}</span><strong>忌：</strong><span>${s2t(lunarTime.getJi()).join('、') || '無'}</span></div><p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">時辰宜忌僅供參考。</p>`;
            } else { qs('#shichenDetailsModalContent').innerHTML = `<p>找不到 ${name}時 的詳細資訊。</p>`; }
            qs('#shichenDetailsModal').classList.add('is-active');
        }
        function showWeatherForecast() {
            if (settings.editMode) return;
            if (!state.weatherDataCache) {
                const el = qs('#weatherMarqueeContainer');
                if(el) { setStyle(el, { backgroundColor: '#552222' }); setTimeout(() => setStyle(el, { backgroundColor: '' }), 500); }
                return;
            }
            const grid = qs('#weatherForecastGrid'), title = qs('#weatherForecastModalTitle');
            grid.innerHTML = '';
            title.textContent = `${getChineseLocationName(settings.weatherLocation)} 一週預報`;
            for (let i = 0; i < 7; i++) {
                const date = new Date(state.weatherDataCache.daily.time[i]);
                const dayName = i === 0 ? '今天' : `周${['日', '一', '二', '三', '四', '五', '六'][date.getDay()]}`;
                const { desc } = getWeatherDescriptionAndEmoji(state.weatherDataCache.daily.weather_code[i]);
                const dayCell = document.createElement('div');
                dayCell.className = 'forecast-day';
                dayCell.innerHTML = `<p class="day-name">${dayName}</p><p>${date.getMonth() + 1}/${date.getDate()}</p><div class="weather-icon">${getWeatherSVGIcon(state.weatherDataCache.daily.weather_code[i], '2.5em')}</div><p>${desc}</p><p><span class="temp-high">${Math.round(state.weatherDataCache.daily.temperature_2m_max[i])}°</span> / <span class="temp-low">${Math.round(state.weatherDataCache.daily.temperature_2m_min[i])}°</span></p>`;
                dayCell.onclick = () => showHourlyWeather(i);
                grid.appendChild(dayCell);
            }
            qs('#weatherForecastModal').classList.add('is-active');
        }
        function showHourlyWeather(dayIndex) {
            if (!state.weatherDataCache?.hourly) return;
            const grid = qs('#hourlyWeatherGrid'), title = qs('#hourlyWeatherModalTitle');
            grid.innerHTML = '';
            const date = new Date(state.weatherDataCache.daily.time[dayIndex]);
            const max = Math.round(state.weatherDataCache.daily.temperature_2m_max[dayIndex]), min = Math.round(state.weatherDataCache.daily.temperature_2m_min[dayIndex]);
            title.innerHTML = `${date.getMonth() + 1}月${date.getDate()}日 預報 <span style="font-size: 0.7em; color: #ccc;">(高 <span class="temp-high">${max}°</span> / 低 <span class="temp-low">${min}°</span>)</span>`;
            const now = new Date();
            const start = dayIndex * 24, end = start + 24;
            for (let i = start; i < end; i += 3) {
                const hourDate = new Date(state.weatherDataCache.hourly.time[i]);
                const { desc } = getWeatherDescriptionAndEmoji(state.weatherDataCache.hourly.weather_code[i]);
                const hourCell = document.createElement('div');
                hourCell.className = 'hourly-item';
                if (dayIndex === 0) {
                    const currentHour = now.getHours(), blockStartHour = hourDate.getHours();
                    if (currentHour >= blockStartHour && currentHour < blockStartHour + 3) hourCell.classList.add('is-now');
                }
                hourCell.innerHTML = `<p class="hour-time">${hourDate.getHours().toString().padStart(2, '0')}:00</p><div class="weather-icon">${getWeatherSVGIcon(state.weatherDataCache.hourly.weather_code[i], '2em')}</div><p>${desc}</p><p>${Math.round(state.weatherDataCache.hourly.temperature_2m[i])}°C</p>`;
                grid.appendChild(hourCell);
            }
            qs('#weatherForecastModal').classList.remove('is-active');
            qs('#hourlyWeatherModal').classList.add('is-active');
        }
        function showZodiacDetails() {
            if (settings.editMode) return;
            const grid = qs('#zodiacGrid');
            grid.innerHTML = '';
            ['鼠', '牛', '虎', '兔', '龍', '蛇', '馬', '羊', '猴', '雞', '狗', '豬'].forEach(name => {
                const item = document.createElement('div');
                item.className = 'zodiac-item';
                item.innerHTML = `<div class="zodiac-icon">${getShengXiaoSVG(name, '100%')}</div><p>${name}</p>`;
                grid.appendChild(item);
            });
            qs('#zodiacModal').classList.add('is-active');
        }
        function showMoonPhaseDetails(date) {
            if (settings.editMode) return;
            const d = new Date(date);
            d.setHours(12, 0, 0, 0);
            state.moonCalendarDate = d;
            updateMainMoonPhaseDisplay(d);
            createMoonCalendarView(d);
            qs('#moonPhaseModal').classList.add('is-active');
        }
        function updateMainMoonPhaseDisplay(date) {
            const lunar = Solar.fromDate(date).getLunar(), day = lunar.getDay(), details = getMoonPhaseDetails(day);
            const title = details.aka ? `${details.name} (${details.aka})` : details.name;
            qs('#moonPhaseModalTitle').textContent = `${date.getFullYear()}`;
            qs('#mainMoonIcon').innerHTML = getMoonPhaseSVG(day, '15vmin');
            qs('#mainMoonDescription').textContent = `${title} - ${details.desc}`;
            qsa('#moonCalendarGrid .calendar-day').forEach(d => d.classList.remove('is-selected'));
            const selectedDayEl = qs(`#moonCalendarGrid .calendar-day[data-date='${date.toISOString()}']`);
            if (selectedDayEl) selectedDayEl.classList.add('is-selected');
        }

        // --- 動態效果與編輯模式 (Dynamic Effects & Edit Mode) ---
        function applyMovement() {
            clearInterval(timers.movement);
            if (settings.editMode) return;
            if (settings.enableMovement) {
                const intervalMs = (parseInt(settings.movementIntervalMinutes) * 60 + parseInt(settings.movementIntervalSeconds)) * 1000;
                if (intervalMs > 0) {
                    moveRandomly();
                    timers.movement = setInterval(moveRandomly, intervalMs);
                }
            } else {
                if (transformState['master']) { transformState['master'].x = 0; transformState['master'].y = 0; }
                applyTransforms();
            }
        }
        function applyScanlineEffect() {
            clearInterval(timers.scanline);
            const bg = qs('#background-scanline-overlay'), txt = qs('#text-scanline-overlay');
            bg.classList.toggle('active', settings.enableBackgroundScanline);
            txt.classList.toggle('active', settings.enableTextScanline);
            if (settings.enableBackgroundScanline || settings.enableTextScanline) {
                const intervalMs = (parseInt(settings.scanlineIntervalMinutes) * 60 + parseInt(settings.scanlineIntervalSeconds)) * 1000;
                if (intervalMs > 0) {
                    timers.scanline = setInterval(() => { state.scanlinePatternIsA = !state.scanlinePatternIsA; updateDigitalClock(); }, intervalMs);
                }
            }
        }
        function getEncompassingBoundingBox(elements) {
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity, hasVisibleElements = false;
            elements.forEach(el => {
                if (window.getComputedStyle(el).display !== 'none') {
                    hasVisibleElements = true;
                    const rect = el.getBoundingClientRect();
                    minX = Math.min(minX, rect.left); minY = Math.min(minY, rect.top);
                    maxX = Math.max(maxX, rect.right); maxY = Math.max(maxY, rect.bottom);
                }
            });
            if (!hasVisibleElements) return null;
            return { width: maxX - minX, height: maxY - minY };
        }
        function moveRandomly() {
            if (settings.editMode) return;
            const id = 'master';
            if (!transformState[id]) transformState[id] = { x: 0, y: 0, scale: 1 };
            const T = transformState[id];
            const bbox = getEncompassingBoundingBox(qsa('.widget-wrapper'));
            if (!bbox) return;
            const scaledWidth = bbox.width / T.scale, scaledHeight = bbox.height / T.scale;
            const margin = 10;
            const maxX = (window.innerWidth - scaledWidth) / 2 - margin;
            const maxY = (window.innerHeight - scaledHeight) / 2 - margin;
            if (maxX > 0 && maxY > 0) {
                T.x = Math.random() * (maxX * 2) - maxX;
                T.y = Math.random() * (maxY * 2) - maxY;
            } else { T.x = 0; T.y = 0; }
            applyTransforms();
        }
        function applyTransforms() {
            const masterEl = qs('#master-layout'), T_master = transformState['master'] || defaultTransformState['master'];
            if(masterEl) {
                masterEl.style.transition = state.isDragging ? 'none' : 'transform 1s ease-in-out';
                masterEl.style.transform = `translate(calc(-50% + ${T_master.x}px), calc(-50% + ${T_master.y}px)) scale(${T_master.scale})`;
            }
            for (const id in transformState) {
                if (id === 'master') continue;
                const el = qs(`#${id}-widget`);
                if (el) {
                    const T = transformState[id];
                    el.style.transition = state.isDragging ? 'none' : 'transform 1s ease-in-out';
                    el.style.transform = `translate(calc(-50% + ${T.x}px), calc(-50% + ${T.y}px)) scale(${T.scale})`;
                    const invScale = 1 / T.scale;
                    const handle = el.querySelector('.move-handle');
                    if (handle) handle.style.transform = `translate(-50%, -50%) scale(${invScale})`;
                    const resizeHandleX = el.querySelector('.resize-handle-x');
                    if (resizeHandleX) resizeHandleX.style.transform = `translateY(-50%) scale(${invScale})`;
                    if (T.width) {
                        const contentEl = qs(`#${id}-widget > div:first-child`);
                        if(contentEl) contentEl.style.width = `${T.width}vw`;
                    }
                }
            }
        }
        function toggleEditModeState() {
            document.body.classList.toggle('edit-mode', settings.editMode);
            const wrenchIcon = qs('#edit-mode-icon .wrench-icon'), closeIcon = qs('#edit-mode-icon .close-icon-svg');
            if (wrenchIcon && closeIcon) {
                wrenchIcon.style.display = settings.editMode ? 'none' : 'block';
                closeIcon.style.display = settings.editMode ? 'block' : 'none';
            }
            qs('#edit-mode-icon').title = settings.editMode ? '結束編輯' : '編輯模式';
            if (settings.editMode) {
                state.movementEnabledBeforeEdit = settings.enableMovement;
                settings.enableMovement = false;
                qs('#enableMovement').checked = false;
                if (transformState['master']) { transformState['master'].x = 0; transformState['master'].y = 0; }
                applyTransforms();
            } else { settings.enableMovement = state.movementEnabledBeforeEdit; qs('#enableMovement').checked = state.movementEnabledBeforeEdit; }
            applyMovement();
            updateSettingDependencies();
        }
        function constrainPositions() {
            const handleSize = 40, margin = 10;
            const minX = -window.innerWidth / 2 + handleSize / 2 + margin, maxX = window.innerWidth / 2 - handleSize / 2 - margin;
            const minY = -window.innerHeight / 2 + handleSize / 2 + margin, maxY = window.innerHeight / 2 - handleSize / 2 + margin;
            let needsUpdate = false;
            for (const id in transformState) {
                if (id === 'master') continue;
                const T = transformState[id];
                if (T && typeof T.x === 'number' && typeof T.y === 'number') {
                    const originalX = T.x, originalY = T.y;
                    T.x = Math.max(minX, Math.min(maxX, T.x));
                    T.y = Math.max(minY, Math.min(maxY, T.y));
                    if (T.x !== originalX || T.y !== originalY) needsUpdate = true;
                }
            }
            return needsUpdate;
        }

        // --- 地點選擇器 (Location Selectors) ---
        function updateDistrictSelector(county) {
            const sel = qs('#districtSelect');
            sel.innerHTML = '';
            const districts = taiwanLocations[county]?.districts || {};
            for (const name in districts) {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                sel.appendChild(opt);
            }
        }
        function syncLocationControls() {
            const county = qs('#countySelect').value, district = qs('#districtSelect').value;
            const english = taiwanLocations[county]?.districts[district] || 'taiwan';
            qs('#weatherLocation').value = english;
            settings.weatherLocation = english;
            saveState();
            updateWeather();
        }
        function setLocationSelectorsFromEnglish(english) {
            const countySel = qs('#countySelect'), districtSel = qs('#districtSelect');
            qs('#weatherLocation').value = english;
            let found = false;
            for (const county in taiwanLocations) {
                for (const district in taiwanLocations[county].districts) {
                    if (taiwanLocations[county].districts[district].toLowerCase() === english.toLowerCase()) {
                        countySel.value = county;
                        updateDistrictSelector(county);
                        districtSel.value = district;
                        found = true; break;
                    }
                }
                if (found) break;
            }
            if (!found) { countySel.value = '台灣'; updateDistrictSelector('台灣'); districtSel.value = '台灣'; }
        }

        // --- 拖曳功能 (Drag & Drop) ---
        const dragStart = (e) => {
            if (!settings.editMode) return;
            const widgetWrapper = e.target.closest('.widget-wrapper');
            const controlsHandle = e.target.matches('#layout-controls-handle');
            if (!widgetWrapper && !controlsHandle) return;
            e.preventDefault();
            state.isDragging = true;
            const event = e.touches ? e.touches[0] : e;
            state.startX = event.clientX; state.startY = event.clientY;
            if (widgetWrapper) {
                state.dragTarget = widgetWrapper.id.replace('-widget', '');
                const T = transformState[state.dragTarget];
                if (!T) return;
                if (e.target.classList.contains('resize-handle-x')) {
                    state.dragType = 'resize-x'; document.body.style.cursor = 'ew-resize'; state.initialWidth = T.width || 92;
                } else if (e.target.classList.contains('move-handle')) {
                    state.dragType = 'move'; document.body.style.cursor = 'move'; state.initialX = T.x; state.initialY = T.y;
                } else {
                    state.dragType = 'scale'; document.body.style.cursor = 'nwse-resize';
                    const rect = widgetWrapper.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2, centerY = rect.top + rect.height / 2;
                    state.initialDist = Math.hypot(state.startX - centerX, state.startY - centerY);
                    state.initialScale = T.scale;
                }
            } else if (controlsHandle) {
                state.dragTarget = 'layout-controls'; state.dragType = 'controls';
                const controls = qs('#edit-mode-controls');
                const rect = controls.getBoundingClientRect();
                state.initialControlsX = rect.left; state.initialControlsY = window.innerHeight - rect.bottom;
                controls.style.transform = 'none';
                controls.style.left = `${state.initialControlsX}px`;
                controls.style.bottom = `${state.initialControlsY}px`;
            }
            window.addEventListener('mousemove', dragMove); window.addEventListener('touchmove', dragMove, { passive: false });
            window.addEventListener('mouseup', dragEnd); window.addEventListener('touchend', dragEnd);
        };
        const dragMove = (e) => {
            if (!state.isDragging) return;
            e.preventDefault();
            const event = e.touches ? e.touches[0] : e;
            requestAnimationFrame(() => {
                if (!state.isDragging) return;
                const dx = event.clientX - state.startX; const dy = event.clientY - state.startY;
                switch (state.dragType) {
                    case 'move': case 'scale': case 'resize-x': {
                        const T = transformState[state.dragTarget];
                        if (!T) return;
                        if (state.dragType === 'move') {
                            const handleSize = 40, margin = 10;
                            const minX = -window.innerWidth / 2 + handleSize / 2 + margin, maxX = window.innerWidth / 2 - handleSize / 2 - margin;
                            const minY = -window.innerHeight / 2 + handleSize / 2 + margin, maxY = window.innerHeight / 2 - handleSize / 2 + margin;
                            T.x = Math.max(minX, Math.min(maxX, state.initialX + dx));
                            T.y = Math.max(minY, Math.min(maxY, state.initialY + dy));
                        } else if (state.dragType === 'scale') {
                            const el = qs(`#${state.dragTarget}-widget`);
                            const rect = el.getBoundingClientRect();
                            const centerX = rect.left + rect.width / 2, centerY = rect.top + rect.height / 2;
                            const currentDist = Math.hypot(event.clientX - centerX, event.clientY - centerY);
                            if (state.initialDist > 0) T.scale = Math.max(0.2, state.initialScale * (currentDist / state.initialDist));
                        } else { T.width = Math.max(20, state.initialWidth + (dx / window.innerWidth) * 100); }
                        applyTransforms();
                        break;
                    }
                    case 'controls': {
                        const controls = qs('#edit-mode-controls');
                        const rect = controls.getBoundingClientRect();
                        let newLeft = state.initialControlsX + dx;
                        let newBottom = state.initialControlsY - dy;
                        newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - rect.width));
                        newBottom = Math.max(0, Math.min(newBottom, window.innerHeight - rect.height));
                        controls.style.left = `${newLeft}px`;
                        controls.style.bottom = `${newBottom}px`;
                        break;
                    }
                }
            });
        };
        const dragEnd = () => {
            if (!state.isDragging) return;
            if (state.dragType === 'controls') {
                const controls = qs('#edit-mode-controls');
                settings.layoutControlsPos = { x: controls.style.left, y: controls.style.bottom };
            } else if (state.dragTarget) { if (constrainPositions()) applyTransforms(); }
            state.isDragging = false; state.dragTarget = null; state.dragType = null;
            document.body.style.cursor = 'default';
            saveState();
            window.removeEventListener('mousemove', dragMove); window.removeEventListener('touchmove', dragMove);
            window.removeEventListener('mouseup', dragEnd); window.removeEventListener('touchend', dragEnd);
        };

        // --- 事件監聽器 (Event Listeners) ---
        function initializeEventListeners() {
            qs('#settingsModal').addEventListener('change', e => {
                const { id, type, checked, value } = e.target;
                if (['countySelect', 'districtSelect', 'weatherLocation'].includes(id)) return;
                settings[id] = type === 'checkbox' ? checked : value;
                if (id.startsWith('enableMovement') || id.includes('movementInterval')) applyMovement();
                else if (id.startsWith('enable') || id.includes('scanlineInterval')) { applyScanlineEffect(); updateDigitalClock(); }
                else if (id.startsWith('show')) { updateWidgetVisibility(); applyAllSettings(); }
                else applyAllSettings();
                updateSettingDependencies();
                saveState();
            });
            qsa('#settingsModal input[type="color"]').forEach(el => el.addEventListener('input', e => { settings[e.target.id] = e.target.value; applyAllSettings(); saveState(); }));
            qsa('.random-color-btn').forEach(btn => btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;
                if (targetId && settings.hasOwnProperty(targetId)) {
                    const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                    settings[targetId] = randomColor;
                    document.getElementById(targetId).value = randomColor;
                    saveState(); applyAllSettings();
                }
            }));
            qs('#countySelect').addEventListener('change', () => { updateDistrictSelector(qs('#countySelect').value); syncLocationControls(); });
            qs('#districtSelect').addEventListener('change', syncLocationControls);
            qs('#weatherLocation').addEventListener('change', e => { const loc = e.target.value.trim(); if(loc) { settings.weatherLocation = loc; setLocationSelectorsFromEnglish(loc); saveState(); updateWeather(); } });
            qs('#useCurrentLocationBtn').addEventListener('click', () => {
                if (navigator.geolocation) {
                    updateMarquee('正在定位...', 'weather');
                    navigator.geolocation.getCurrentPosition( pos => {
                        fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&localityLanguage=en`)
                        .then(r => r.json()).then(geo => {
                            const city = geo.locality || geo.city;
                            if (city) { settings.weatherLocation = city; setLocationSelectorsFromEnglish(city); saveState(); updateWeather(); }
                            else updateMarquee(`<span style="color: ${settings.weatherColor};">定位失敗</span>`, 'weather');
                        }).catch(() => updateMarquee(`<span style="color: ${settings.weatherColor};">定位失敗</span>`, 'weather'));
                    }, () => updateMarquee(`<span style="color: ${settings.weatherColor};">定位失敗，請檢查權限</span>`, 'weather'), { timeout: 10000 } );
                }
            });
            qs('#restoreDefaultsBtn').onclick = restoreDefaults;
            qs('#randomColorsBtn').onclick = setRandomColors;

            document.body.addEventListener('click', e => {
                if (settings.editMode || state.isDragging) return;
                const target = e.target;
                if (target.closest('#weatherMarqueeContainer')) showWeatherForecast();
                else if (target.closest('#jieqiHolidayMarqueeContainer') || target.closest('.gregorian-day-target') || target.closest('.lunar-day-target')) showDateDetails(new Date());
                else if (target.closest('.lunar-shichen-target')) updateShiChenDetailsView(new Date());
                else if (target.closest('.lunar-month-text-target') || target.closest('.gregorian-month-target')) { state.calendarDate = new Date(); createPopupCalendarView(state.calendarDate); qs('#calendarModal').classList.add('is-active'); }
                else if (target.closest('.moon-phase-icon-target')) showMoonPhaseDetails(new Date());
                else if (target.closest('.lunar-year-target')) showZodiacDetails();
                else if (target.closest('.gregorian-year-target')) { state.yearlyCalendarDate = new Date(); generateYearCalendar(state.yearlyCalendarDate.getFullYear()); qs('#yearlyCalendarModal').classList.add('is-active'); }
                else if (target.closest('.weekday-target')) { state.weeklyCalendarDate = new Date(); generateWeekCalendar(state.weeklyCalendarDate); qs('#weeklyCalendarModal').classList.add('is-active'); }
                else if (target.closest('#clockCenterDot')) updateShiChenDetailsView(new Date());
            });

            qs('#mainPrevMonthBtn').onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); createMainCalendarView(state.calendarDate); };
            qs('#mainNextMonthBtn').onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); createMainCalendarView(state.calendarDate); };
            qs('#mainTodayBtn').onclick = () => { state.calendarDate = new Date(); createMainCalendarView(state.calendarDate); };
            qs('#mainCalendarTitle').onclick = () => { if (!settings.editMode) { const year = parseInt(qs('#mainCalendarTitle').dataset.year); state.yearlyCalendarDate.setFullYear(year); generateYearCalendar(year); qs('#yearlyCalendarModal').classList.add('is-active'); } };
            
            qsa('.close-icon').forEach(btn => btn.onclick = () => btn.closest('.modal').classList.remove('is-active'));
            qsa('.modal').forEach(modal => modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('is-active'); }));
            qs('#backToWeeklyForecastBtn').onclick = () => { qs('#hourlyWeatherModal').classList.remove('is-active'); qs('#weatherForecastModal').classList.add('is-active'); };
            qs('#popupPrevMonthBtn').onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); createPopupCalendarView(state.calendarDate); };
            qs('#popupNextMonthBtn').onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); createPopupCalendarView(state.calendarDate); };
            qs('#popupTodayBtn').onclick = () => { state.calendarDate = new Date(); createPopupCalendarView(state.calendarDate); };
            qs('#calendarMonthYear').onclick = () => { const year = parseInt(qs('#calendarMonthYear').dataset.year); qs('#calendarModal').classList.remove('is-active'); state.yearlyCalendarDate.setFullYear(year); generateYearCalendar(year); qs('#yearlyCalendarModal').classList.add('is-active'); };
            qs('#prevWeekBtn').onclick = () => { state.weeklyCalendarDate.setDate(state.weeklyCalendarDate.getDate() - 7); generateWeekCalendar(state.weeklyCalendarDate); };
            qs('#nextWeekBtn').onclick = () => { state.weeklyCalendarDate.setDate(state.weeklyCalendarDate.getDate() + 7); generateWeekCalendar(state.weeklyCalendarDate); };
            qs('#todayWeeklyBtn').onclick = () => { state.weeklyCalendarDate = new Date(); generateWeekCalendar(state.weeklyCalendarDate); };
            qs('#prevYearBtn').onclick = () => { state.yearlyCalendarDate.setFullYear(state.yearlyCalendarDate.getFullYear() - 1); generateYearCalendar(state.yearlyCalendarDate.getFullYear()); };
            qs('#nextYearBtn').onclick = () => { state.yearlyCalendarDate.setFullYear(state.yearlyCalendarDate.getFullYear() + 1); generateYearCalendar(state.yearlyCalendarDate.getFullYear()); };
            qs('#todayYearlyBtn').onclick = () => { state.yearlyCalendarDate = new Date(); generateYearCalendar(state.yearlyCalendarDate.getFullYear()); };
            qs('#prevShichenBtn').onclick = () => { state.shichenDetailDate.setHours(state.shichenDetailDate.getHours() - 2); updateShiChenDetailsView(state.shichenDetailDate); };
            qs('#nextShichenBtn').onclick = () => { state.shichenDetailDate.setHours(state.shichenDetailDate.getHours() + 2); updateShiChenDetailsView(state.shichenDetailDate); };
            qs('#nowShichenBtn').onclick = () => updateShiChenDetailsView(new Date());
            qs('#prevMoonMonthBtn').onclick = () => { state.moonCalendarDate.setMonth(state.moonCalendarDate.getMonth() - 1); createMoonCalendarView(state.moonCalendarDate); };
            qs('#nextMoonMonthBtn').onclick = () => { state.moonCalendarDate.setMonth(state.moonCalendarDate.getMonth() + 1); createMoonCalendarView(state.moonCalendarDate); };
            qs('#todayMoonCalendarBtn').onclick = () => { const today = new Date(); today.setHours(12,0,0,0); state.moonCalendarDate = today; updateMainMoonPhaseDisplay(today); createMoonCalendarView(today); };

            qs('#settings-icon').addEventListener('click', () => { qs('#settingsModal').classList.add('is-active'); updateSettingsModalUI(); updateSettingDependencies(); });
            qs('#edit-mode-icon').addEventListener('click', () => { settings.editMode = !settings.editMode; toggleEditModeState(); saveState(); });
            qs('#fullscreen-icon').addEventListener('click', () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => console.warn(`無法進入全螢幕模式: ${err.message}`)); else if (document.exitFullscreen) document.exitFullscreen(); });
            const handleFullscreen = () => {
                const isFullscreen = !!document.fullscreenElement;
                qs('#fullscreen-icon .enter-fullscreen-svg').style.display = isFullscreen ? 'none' : 'block';
                qs('#fullscreen-icon .exit-fullscreen-svg').style.display = isFullscreen ? 'block' : 'none';
                qs('#fullscreen-icon').title = isFullscreen ? '退出全螢幕' : '全螢幕';
                window.dispatchEvent(new Event('resize'));
            };
            document.addEventListener('fullscreenchange', handleFullscreen);
            window.addEventListener('resize', () => { if (constrainPositions()) applyTransforms(); });

            let inactivityTimer;
            const resetIdle = () => {
                qsa('.control-icon').forEach(icon => setStyle(icon, { opacity: '0.5' }));
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => qsa('.control-icon').forEach(icon => setStyle(icon, { opacity: '0' })), 5000);
            };
            ['mousemove', 'keydown', 'touchstart'].forEach(evt => document.addEventListener(evt, resetIdle));
            resetIdle();

            document.addEventListener('mousedown', dragStart);
            document.addEventListener('touchstart', dragStart, { passive: false });
            qs('#saveLayoutBtn').addEventListener('click', () => saveLayoutToSlot(qs('#layoutSlotSelect').value));
            qs('#loadLayoutBtn').addEventListener('click', () => loadLayoutFromSlot(qs('#layoutSlotSelect').value));
            qs('#exportLayoutsBtn').addEventListener('click', exportLayoutsToFile);
            qs('#importLayoutsBtn').addEventListener('click', () => qs('#importLayoutsInput').click());
            qs('#importLayoutsInput').addEventListener('change', importLayoutsFromFile);
        }
        function populateLayoutSlots() {
            const select = qs('#layoutSlotSelect');
            if (!select) return;
            select.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const option = document.createElement('option');
                option.value = i;
                let optionText = `版面 ${i}`;
                let displayText = '';
                const storedLayoutData = localStorage.getItem(`mergedClockLayout_v5_slot_${i}`);
                if (storedLayoutData) {
                    try {
                        const layoutData = JSON.parse(storedLayoutData);
                        if (layoutData.remark) { displayText = layoutData.remark; } 
                        else if (layoutData.timestamp) {
                            const savedDate = new Date(layoutData.timestamp);
                            displayText = `${savedDate.getFullYear().toString().slice(-2)}${(savedDate.getMonth() + 1).toString().padStart(2, '0')}${savedDate.getDate().toString().padStart(2, '0')}${savedDate.getHours().toString().padStart(2, '0')}${savedDate.getMinutes().toString().padStart(2, '0')}`;
                        }
                    } catch (e) { console.error(`解析版面 ${i} 的資料失敗:`, e); }
                }
                option.textContent = displayText ? `${optionText} (${displayText})` : optionText;
                select.appendChild(option);
            }
        }

        // --- 初始化 ---
        function initializeTimers() {
            Object.values(timers).forEach(clearInterval);
            timers.main = setInterval(updateDigitalClock, 1000);
            timers.analog = setInterval(updateAnalogClock, 50);
            applyMovement();
            applyScanlineEffect();
        }
        function initializeApp() {
            ['movementIntervalMinutes', 'movementIntervalSeconds', 'scanlineIntervalMinutes', 'scanlineIntervalSeconds'].forEach(id => {
                const sel = document.getElementById(id);
                if (sel) for (let i = 0; i <= 59; i++) { const opt = document.createElement('option'); opt.value = i; opt.textContent = i; sel.appendChild(opt); }
            });
            const countySelect = qs('#countySelect');
            for (const county in taiwanLocations) { const opt = document.createElement('option'); opt.value = county; opt.textContent = county; countySelect.appendChild(opt); }
            populateLayoutSlots();
            initializeLedClock();
            loadState();
            constrainPositions();
            updateSettingDependencies();
            initializeTimers();
            initializeAnalogClock();
            createMainCalendarView(state.calendarDate);
            applyAllSettings(true);
            clearInterval(timers.weather);
            updateWeather();
            timers.weather = setInterval(updateWeather, 10 * 60 * 1000);
            initializeEventListeners();
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
